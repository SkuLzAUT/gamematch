<!DOCTYPE html>
<html lang="de-DE">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GameMatch - Dein KI-Spieleberater f√ºr Steam</title>
    
    <meta name="description" content="Finde dein perfektes PC-Spiel mit KI. GameMatch analysiert deine Stimmung, Zeit & Vorlieben und gibt dir sofort die passende Empfehlung direkt aus dem Steam Store.">
    <meta name="keywords" content="GameMatch, Steam, Spiel finden, KI Game Beratung, Steam Empfehlungen, Gaming KI, welches Spiel spielen, PC Gaming">
    <meta name="author" content="GameMatch Team">
    <link rel="canonical" href="https://gamematch.eu" />

    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&family=Orbitron:wght@700&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&family=Orbitron:wght@700&display=swap"></noscript>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/i18next/dist/umd/i18next.min.js"></script>
    <style>
.text-fluid-hero {
  /* min Gr√∂√üe, bevorzugte Gr√∂√üe, max Gr√∂√üe */
  font-size: clamp(2.0rem, 8vw, 3.75rem);
  line-height: clamp(2.4rem, 9vw, 4.25rem);
}

.text-fluid-subhero {
  font-size: clamp(1rem, 4vw, 1.25rem);
  line-height: clamp(1.5rem, 5vw, 1.75rem);
}

.text-fluid-heading {
  font-size: clamp(1.5rem, 6vw, 2.25rem);
  line-height: clamp(2rem, 7vw, 2.75rem);
}
        :root {
            --bg-dark: #111827; --bg-mid: #1F2937; --bg-light: #374151;
            --accent-blue: #2563EB; --accent-cyan: #06B6D4; --accent-yellow: #FBBF24;
            --text-light: #F9FAFB; --text-dark: #9CA3AF;
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-dark); color: var(--text-light); scroll-behavior: smooth; }
        h1, h2, h3, h4 { font-family: 'Inter', sans-serif; font-weight: 800; }
        .font-orbitron { font-family: 'Orbitron', sans-serif; }
        .hero-bg { background-image: linear-gradient(to top, var(--bg-dark) 5%, transparent 50%), linear-gradient(rgba(17, 24, 39, 0.85), rgba(17, 24, 39, 1)), url('https://images.pexels.com/photos/924824/pexels-photo-924824.jpeg?auto=compress&cs=tinysrgb&w=1920'); background-size: cover; background-position: center; }
        .page-section { display: none; opacity: 0; transition: opacity 0.3s ease; }
        .page-section.active { display: block; opacity: 1; }
        #home.active { animation: none; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
        .ai-bubble-container, .user-bubble-container { max-width: 80%; animation: fadeIn 0.5s ease-in-out; }
        .is-loading::after { content: '...'; display: inline-block; animation: dots 1s steps(3, end) infinite; }
        @keyframes dots { 0%, 20% { color: rgba(0,0,0,0); text-shadow: .25em 0 0 rgba(0,0,0,0), .5em 0 0 rgba(0,0,0,0); } 40% { color: white; text-shadow: .25em 0 0 rgba(0,0,0,0), .5em 0 0 rgba(0,0,0,0); } 60% { text-shadow: .25em 0 0 white, .5em 0 0 rgba(0,0,0,0); } 80%, 100% { text-shadow: .25em 0 0 white, .5em 0 0 white; } }
        input:-webkit-autofill { -webkit-box-shadow: 0 0 0 30px var(--bg-dark) inset !important; -webkit-text-fill-color: var(--text-light) !important; }
        
        /* KORRIGIERTE STILE F√úR PROFIL-TABS */
        .profile-tab-content { display: none; }
        .profile-tab-content.active { display: block; }
        #profile-content-spiele.active { display: grid; }
        .profile-tab-btn { color: #9CA3AF; border-color: transparent; transition: all 0.2s ease-in-out; }
        .profile-tab-btn.active { color: #06B6D4; border-color: #06B6D4; }

        .community-tab-content { display: none; }
        .community-tab-content.active { display: block; }
        .community-tab-btn { color: #9CA3AF; border-color: transparent; transition: all 0.2s ease-in-out; }
        .community-tab-btn.active { color: #06B6D4; border-color: #06B6D4; }
        .filter-btn { padding: 6px 16px; border-radius: 9999px; font-weight: 600; background-color: #374151; color: #F9FAFB; transition: background-color 0.2s; }
        .filter-btn.active { background-color: #06B6D4; color: #111827; }
        /* Stil f√ºr einen auff√§lligen Discord-Button */
        .discord-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 0.5rem; /* p-2 */
        border-radius: 9999px; /* rounded-full */
        background-color: #5865F2; /* Discord "Blurple" */
        color: white;
        transition: all 0.2s ease-in-out;
        }
        .discord-btn:hover {
        background-color: #4f5bda; /* Etwas dunkler bei Hover */
        transform: scale(1.1);
        }
        .glow-bg { position: relative; z-index: 1; }
        .glow-bg::before { content: ''; position: absolute; z-index: -1; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 60%; height: 70%; background: radial-gradient(circle, rgba(6, 182, 212, 0.15) 0%, rgba(17, 24, 39, 0) 70%); filter: blur(40px); pointer-events: none; }

        /* AUTH MODAL STYLES */
        .auth-modal {
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .auth-modal-content {
            transition: transform 0.3s ease;
        }
        html, body {
    height: 100%; /* Stellt sicher, dass die Seite immer die volle H√∂he hat */
}
body {
    display: flex;
    flex-direction: column;
}
main {
    flex-grow: 1; 
}
/* ========================= */
/* CSS f√ºr Partner-Scroller  */
/* ========================= */
/* Container, der die scrollende Leiste verbirgt und die R√§nder weichzeichnet */
.scroller-container {
    max-width: 900px;
    margin: auto;
    overflow: hidden;
    -webkit-mask-image: linear-gradient(to right, transparent, white 20%, white 80%, transparent);
    mask-image: linear-gradient(to right, transparent, white 20%, white 80%, transparent);
}

/* Die Leiste, die alle Logos enth√§lt und animiert wird */
.scroller {
    display: flex;
    width: max-content; /* Passt sich automatisch der Breite der Logos an */
    animation: scroll 30s linear infinite; /* Dauer ggf. anpassen */
}

/* H√§lt die Animation an, wenn man mit der Maus dar√ºber f√§hrt */
.scroller:hover {
    animation-play-state: paused;
}

/* Die Keyframe-Animation, die die Leiste bewegt */
@keyframes scroll {
    from {
        transform: translateX(0);
    }
    to {
        /* Bewegt die Leiste um exakt die H√§lfte ihrer Gesamtbreite */
        transform: translateX(-50%);
    }
}

/* Styling f√ºr die einzelnen Logos */
.scroller a img {
    height: 40px;
    margin: 0 32px; /* mx-8 in Tailwind */
    filter: grayscale(1) brightness(2);
    opacity: 0.8;
    transition: all 0.2s ease-in-out;
}

.scroller a:hover img {
    filter: grayscale(0) brightness(1);
    opacity: 1;
    transform: scale(1.1);
}

#game-detail-modal.visible {
    opacity: 1;
    visibility: visible;
}
#game-detail-modal.visible #game-detail-modal-content {
    transform: scale(1);
}
@media (max-width: 768px) {
    .hero {
      /* Vertikales Padding reduziert f√ºr bessere mobile Ansicht */
      padding: 3rem 1.25rem; /* 3rem oben/unten, 1.25rem links/rechts */
      text-align: center;
    }

    nav ul {
      flex-direction: column;
      align-items: center;
    }

    nav li {
      margin: 10px 0;
    }

    .features {
      flex-direction: column;
      /* Padding angepasst f√ºr mobile Ansicht */
      padding: 2.5rem 1.25rem;
    }

    .feature {
      width: 100%;
    }

    .footer {
      /* Feste, lesbare Schriftgr√∂√üe statt vw */
      font-size: 0.875rem; /* 14px */
      text-align: center;
    }
}
    </style>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9925570056243594"
     crossorigin="anonymous"></script>
</head>
<body class="bg-gray-900 text-gray-50 antialiased overflow-x-hidden">
 <noscript>
        <h1>Willkommen bei GameMatch - Ihr KI-Spieleberater</h1>
        <p>Finden Sie Ihr perfektes PC-Spiel mit k√ºnstlicher Intelligenz. GameMatch analysiert Ihre Stimmung, verf√ºgbare Zeit und pers√∂nliche Vorlieben und gibt Ihnen sofort die passende Empfehlung direkt aus dem Steam Store. Schluss mit der Unentschlossenheit! Unsere KI f√ºhrt ein echtes Gespr√§ch mit Ihnen und findet zielsicher das Spiel, auf das Sie gerade wirklich Lust haben.</p>
        <h2>Unsere Features</h2>
        <p>Werden Sie Teil einer wachsenden Community. Jedes "gelikte" Spiel landet in Ihrem Profil. Bewerten und kommentieren Sie Ihre Sammlung und bauen Sie sich so Ihren digitalen Troph√§enschrank auf. Verbinden Sie sich mit Gamern, die Ihren Geschmack teilen, vergleichen Sie Ihre Sammlungen und finden Sie neue Mitspieler.</p>
        <h2>Aktuelle News</h2>
        <p>Bleiben Sie auf dem Laufenden mit unseren neuesten Beitr√§gen √ºber Updates, Spiel-Highlights und Community-News.</p>
    </noscript>     
<div id="giveaway-banner" class="hidden bg-yellow-500 text-black p-4 text-center relative">
    <p class="font-semibold">
        <span data-i18n="giveaway_banner_title"></span>
        <span data-i18n="giveaway_banner_text" class="font-normal ml-2"></span>
    </p>
    <button id="close-giveaway-banner" class="absolute top-1/2 right-4 -translate-y-1/2 text-black hover:text-gray-800">
        <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
    </button>
</div>
    <header class="bg-gray-900/70 backdrop-blur-sm sticky top-0 z-50 border-b border-gray-800">
    <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
        <a href="#home" class="text-2xl font-bold text-white nav-trigger font-orbitron">Game<span class="text-cyan-400">Match</span></a>
        
        <div class="hidden md:flex md:items-center md:gap-4">
            <a href="#matchmaker" data-i18n="nav_find_game" class="bg-cyan-600 text-white font-semibold px-5 py-2 rounded-lg hover:bg-cyan-500 transition-all duration-300 transform hover:scale-105 nav-trigger"></a>
            <div id="user-auth" class="flex items-center gap-4">
                <button id="login-btn" data-i18n="nav_login" class="font-semibold text-gray-300 hover:text-white transition-colors"></button>
                <button id="register-btn" data-i18n="nav_register" class="bg-cyan-600 text-white font-semibold px-4 py-1.5 rounded-lg hover:bg-cyan-500 transition-colors"></button>
                <a href="#admin" id="admin-link" data-i18n="nav_admin" class="hidden font-semibold text-yellow-400 hover:text-yellow-300 transition-colors nav-trigger"></a>
                <a href="#news" data-i18n="nav_news" class="font-semibold text-gray-300 hover:text-white transition-colors nav-trigger"></a>
                <a href="#search-users" id="search-users-link" data-i18n="nav_community" class="hidden font-semibold text-gray-300 hover:text-white transition-colors nav-trigger"></a>
                <a href="#partners" data-i18n="nav_partners" class="font-semibold text-gray-300 hover:text-white transition-colors nav-trigger">Partner</a>
                <div id="profile-link" class="relative group hidden">
                    <a href="#profile" class="font-semibold text-gray-300 hover:text-white transition-colors nav-trigger inline-flex items-center gap-1">
                        <span data-i18n="nav_profile"></span>
                        <svg class="w-4 h-4 opacity-70" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        <span id="unread-messages-badge" class="absolute -top-1 -right-2 bg-red-600 text-white text-xs font-bold rounded-full h-4 w-4 flex items-center justify-center hidden"></span>
                    </a>
                    <div class="absolute top-full -right-4 pt-2 w-48 bg-gray-800 border border-gray-700 rounded-lg shadow-lg hidden group-hover:block z-10">
                        <div class="py-1">
                            <a href="#leaderboard" data-i18n="nav_leaderboard" class="block px-4 py-2 text-sm text-gray-300 hover:bg-gray-700 hover:text-white nav-trigger"></a>
                            <a href="https://forms.gle/zV75jDvUzJb4aNB3A" target="_blank" data-i18n="nav_feedback" class="block px-4 py-2 text-sm text-gray-300 hover:bg-gray-700 hover:text-white"></a>
                        </div>
                    </div>
                </div>
                <button id="logout-btn" data-i18n="nav_logout" class="hidden font-semibold text-gray-300 hover:text-white transition-colors"></button>
            </div>
            <div class="flex items-center gap-4 ml-4 border-l border-gray-700 pl-4">
                <a href="https://discord.gg/CTUERAwgNE" target="_blank" rel="noopener" title="Tritt unserem Discord bei!" class="discord-btn">
    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">...</svg>
</a>
                <button onclick="changeLang('de')" title="Deutsch" class="opacity-70 hover:opacity-100 transition-opacity">üá©üá™</button>
                <button onclick="changeLang('en')" title="English" class="opacity-70 hover:opacity-100 transition-opacity">üá¨üáß</button>
            </div>
        </div>
        
        <div class="md:hidden">
            <button id="mobile-menu-btn" class="text-white z-50 relative">
                <svg id="menu-open-icon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
                <svg id="menu-close-icon" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>
    </nav>
</header>

<div id="mobile-menu" class="hidden fixed inset-0 bg-gray-900/95 backdrop-blur-sm z-40 flex flex-col items-center justify-center transition-opacity duration-300">
    <div class="space-y-4 text-center">
        <button id="mobile-login-btn" data-i18n="nav_login" class="block text-2xl text-gray-300 hover:text-cyan-400"></button>
        <button id="mobile-register-btn" data-i18n="nav_register" class="block text-2xl text-cyan-400 font-semibold"></button>
        <hr class="border-gray-700 w-1/2 mx-auto" id="mobile-menu-divider">
        <a href="#matchmaker" data-i18n="nav_find_game" class="block text-2xl text-gray-300 hover:text-cyan-400 nav-trigger"></a>
        <a href="#news" data-i18n="nav_news" class="block text-2xl text-gray-300 hover:text-cyan-400 nav-trigger"></a>
        <a href="#search-users" id="mobile-search-users-link" data-i18n="nav_community" class="block text-2xl text-gray-300 hover:text-cyan-400 nav-trigger"></a>
        <a href="#partners" data-i18n="nav_partners" class="block text-2xl text-gray-300 hover:text-cyan-400 nav-trigger">Partner</a>
        <a href="#profile" id="mobile-profile-link" data-i18n="nav_profile" class="block text-2xl text-gray-300 hover:text-cyan-400 nav-trigger"></a>
        <a href="#leaderboard" id="mobile-leaderboard-link" data-i18n="nav_leaderboard" class="block text-2xl text-gray-300 hover:text-cyan-400 nav-trigger"></a>
        <a href="https://forms.gle/zV75jDvUzJb4aNB3A" target="_blank" data-i18n="nav_feedback" class="block text-2xl text-gray-300 hover:text-cyan-400"></a>
        <a href="#admin" id="mobile-admin-link" data-i18n="nav_admin" class="block text-2xl text-yellow-400 hover:text-yellow-300 nav-trigger"></a>
        <button id="mobile-logout-btn" data-i18n="nav_logout" class="block w-full text-2xl text-gray-300 hover:text-cyan-400"></button>
    </div>
</div>
</header>

    <main>
        <section id="home" class="page-section active fade-in">
    <div class="hero-bg glow-bg">
        <div class="container mx-auto px-4 py-12 md:py-24 text-center">
        <h1 data-i18n="hero_title" class="font-black text-white mb-4 text-fluid-hero"></h1>
        <p data-i18n="hero_subtitle" class="text-gray-400 max-w-2xl mx-auto mb-8 text-fluid-subhero"></p>
        <a data-i18n="hero_cta" href="#matchmaker" class="bg-cyan-500 text-gray-900 font-bold text-base px-8 py-3 sm:text-lg sm:px-10 sm:py-4 rounded-lg hover:bg-cyan-400 transition-all duration-300 transform hover:scale-105 nav-trigger"></a>

            <div id="home-daily-challenge" class="hidden container mx-auto px-6 mt-12 max-w-3xl">
                <div class="bg-gray-800/50 border-2 border-yellow-700 rounded-xl p-6 text-center shadow-lg glow-bg">
                    <h3 data-i18n="daily_mission_title" class="text-2xl font-bold text-yellow-300"></h3>
                    <p id="home-daily-challenge-text" class="text-yellow-200 mt-2 text-lg">Lade Challenge...</p>
                    <div id="home-daily-challenge-reward" class="mt-3 text-sm text-gray-300">
                        <span data-i18n="daily_mission_reward"></span> <span class="font-bold text-white">+25 XP</span>
                    </div>
                    <button data-i18n="daily_mission_cta" id="home-daily-challenge-cta" class="mt-4 rounded-md bg-yellow-500 px-5 py-2.5 text-sm font-semibold text-gray-900 shadow-sm hover:bg-yellow-400"></button>
                </div>
            </div>
            <div class="py-24 sm:py-32">
    <div class="container mx-auto px-6 max-w-7xl">
        <div class="mx-auto max-w-2xl lg:text-center">
            <h2 data-i18n="feature_section_title" class="text-base font-semibold leading-7 text-cyan-400">Dein pers√∂nliches Gaming-Universum</h2>
            <p data-i18n="feature_section_subtitle" class="mt-2 font-bold tracking-tight text-white text-fluid-heading">Mehr als nur Empfehlungen</p>
            <p data-i18n="feature_section_desc" class="mt-6 text-lg leading-8 text-gray-400">
                Ein GameMatch-Konto ist dein zentraler Hub f√ºr alles, was mit deinen Spielen zu tun hat. Sammle, teile und verfolge deinen Fortschritt.
            </p>
        </div>

        <div class="mx-auto mt-16 max-w-2xl sm:mt-20 lg:mt-24 lg:max-w-4xl">
            <dl class="grid max-w-xl grid-cols-1 gap-x-8 gap-y-10 lg:max-w-none lg:grid-cols-3 lg:gap-y-16">
                <div class="relative pl-16">
                    <dt class="text-base font-semibold leading-7 text-white">
                        <div class="absolute left-0 top-0 flex h-10 w-10 items-center justify-center rounded-lg bg-cyan-500">
                            <svg class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25" />
                            </svg>
                        </div>
                        <span data-i18n="feature_new_library_title">Deine Bibliothek</span>
                    </dt>
                    <dd data-i18n="feature_new_library_desc" class="mt-2 text-base leading-7 text-gray-400">Jedes Spiel, das du magst, wird hier gespeichert. Erstelle deine ultimative Sammlung, bewerte sie und zeige sie deinen Freunden.</dd>
                </div>

                <div class="relative pl-16">
                    <dt class="text-base font-semibold leading-7 text-white">
                        <div class="absolute left-0 top-0 flex h-10 w-10 items-center justify-center rounded-lg bg-cyan-500">
                            <svg class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M18 18.72a9.094 9.094 0 003.741-.479 3 3 0 00-4.682-2.72m-7.5-2.964A4.5 4.5 0 1112 5.25v-2.25m-5.25 4.5a4.5 4.5 0 00-1.372 2.964m-7.5 0a4.5 4.5 0 013.741-2.25m9.75 0a4.5 4.5 0 011.372 2.964M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                            </svg>
                        </div>
                        <span data-i18n="feature_new_crew_title">Deine Crew</span>
                    </dt>
                    <dd data-i18n="feature_new_crew_desc" class="mt-2 text-base leading-7 text-gray-400">Finde Spieler, die deinen Geschmack teilen. Vergleicht eure Bibliotheken und findet heraus, welche Spiele ihr gemeinsam zocken k√∂nnt.</dd>
                </div>

                <div class="relative pl-16">
                    <dt class="text-base font-semibold leading-7 text-white">
                        <div class="absolute left-0 top-0 flex h-10 w-10 items-center justify-center rounded-lg bg-cyan-500">
                            <svg class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 18.75h-9a9.75 9.75 0 011.056-5.223 9.75 9.75 0 01-1.056-5.223H7.5a9.75 9.75 0 019 0h-1.875a9.75 9.75 0 01-1.056 5.223A9.75 9.75 0 0116.5 18.75z" />
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 1.5v5.25m0 7.5v5.25m0-5.25h-5.25m5.25 0h5.25" />
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15 5.625a3 3 0 11-6 0 3 3 0 016 0z" />
                            </svg>
                        </div>
                        <span data-i18n="feature_new_progress_title">Dein Fortschritt</span>
                    </dt>
                    <dd data-i18n="feature_new_progress_desc" class="mt-2 text-base leading-7 text-gray-400">Sammle f√ºr deine Aktivit√§ten auf der Seite Erfahrungspunkte (XP), steige im Level auf und schalte neue R√§nge frei.</dd>
                </div>
            </dl>
        </div>
    </div>
</div>
                    <div id="stats-section" class="py-12 bg-gray-900/50">
    <div class="container mx-auto px-6 max-w-5xl">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-8 text-center">
            <div>
                <span id="stat-recommendations" class="font-orbitron text-4xl font-bold text-cyan-400">735</span>
                <p class="text-gray-400 mt-2">Spielempfehlungen generiert</p>
            </div>
            <div>
                <span id="stat-members" class="font-orbitron text-4xl font-bold text-cyan-400">0</span>
                <p class="text-gray-400 mt-2">Community-Mitglieder</p>
            </div>
            <div>
                <span id="stat-rating" class="font-orbitron text-4xl font-bold text-cyan-400">4,5</span>
                <p class="text-gray-400 mt-2">Durchschnittliche Bewertung</p>
            </div>
        </div>
    </div>
</div>

<div class="py-24">
    <div class="container mx-auto px-6 max-w-5xl">
        <h2 class="text-center font-bold text-white text-fluid-heading">Was unsere Nutzer sagen</h2>
        <div class="mt-12 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            <div class="bg-gray-800 p-6 rounded-xl border border-gray-700">
                <p class="text-gray-300">"Ich habe Stunden auf Steam verschwendet. GameMatch hat mir in 2 Minuten ein perfektes Indie-Juwel gefunden. Wahnsinn!"</p>
                <div class="flex items-center mt-4">
                    <img src="https://cdn.cloudflare.steamstatic.com/steamcommunity/public/images/avatars/00/000f11d60061e1748b851b1d850ac25e59541ca1_full.jpg" alt="Kamatra" class="w-10 h-10 rounded-full">
                    <p class="ml-4 font-semibold text-white">Kamatra</p>
                </div>
            </div>
            <div class="bg-gray-800 p-6 rounded-xl border border-gray-700">
                <p class="text-gray-300">"Die KI ist erschreckend gut, nat√ºrlich hat sie noch Kinderkrankheiten. Endlich mal Empfehlungen, die nicht nur die √ºblichen AAA Titel sind."</p>
                <div class="flex items-center mt-4">
                    <img src="https://cdn.cloudflare.steamstatic.com/steamcommunity/public/images/avatars/00/000f1af6be1137efc205847eac9490245dd9e94c_full.jpg" alt="djdonni" class="w-10 h-10 rounded-full">
                    <p class="ml-4 font-semibold text-white">djdonni</p>
                </div>
            </div>
            <div class="bg-gray-800 p-6 rounded-xl border border-gray-700">
                <p class="text-gray-300">"Super Tool, um schnell herauszufinden, worauf man gerade Bock hat. Nutze es mittlerweile fast t√§glich, ab und an kommen echt lustige Vorschl√§ge - immer eine √úberraschung."</p>
                <div class="flex items-center mt-4">
                    <img src="https://cdn.cloudflare.steamstatic.com/steamcommunity/public/images/avatars/00/000f0890a8ff84304784f8075897f3789bb0cff4_full.jpg" alt="Zeli" class="w-10 h-10 rounded-full">
                    <p class="ml-4 font-semibold text-white">Zeli</p>
                </div>
            </div>
        </div>
    </div>
</div>
                    <div class="mt-24 bg-gray-900 border border-gray-700 rounded-2xl p-8 text-center">
                        <h3 data-i18n="guest_cta_title" class="font-bold text-white text-fluid-heading"></h3>
                        <p data-i18n="guest_cta_desc" class="mt-4 text-gray-400 max-w-2xl mx-auto"></p>
                        <div class="mt-6 flex flex-col sm:flex-row items-center justify-center gap-4 sm:gap-x-6">
                            <button data-i18n="guest_cta_register" id="open-register-modal-btn" class="rounded-md bg-cyan-500 px-6 py-3 text-sm font-semibold text-gray-900 shadow-sm hover:bg-cyan-400 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-cyan-600"></button>
                            <button data-i18n="guest_cta_login" id="open-login-modal-btn" class="text-sm font-semibold leading-6 text-white hover:underline"></button>
                        </div>
                    </div>
                    
                    <div id="featured-game-section" class="mt-24 sm:mt-32">
    <div class="container mx-auto px-6 max-w-4xl">
        <div class="text-center mb-8">
            <h2 class="text-base font-semibold leading-7 text-cyan-400">Spiel des Tages</h2>
            <p class="mt-2 font-bold tracking-tight text-white text-fluid-heading">Unsere Empfehlung f√ºr dich</p>
        </div>
        <div id="featured-game-card" class="text-center p-4">
            </div>
    </div>
</div>
        </section>
     <section id="search-users" class="page-section py-12 fade-in">
    <div class="container mx-auto px-6">
        <h2 data-i18n="community_title" class="font-bold text-white mb-4 text-center text-fluid-heading"></h2>
        <p data-i18n="community_subtitle" class="text-gray-400 text-center mb-8"></p>

        <div id="community-tabs" class="border-b border-gray-700 mb-8 flex justify-start sm:justify-center gap-6 overflow-x-auto whitespace-nowrap">
            <button data-i18n="community_tab_discover" data-target="community-content-suche" class="community-tab-btn font-semibold pb-3 border-b-2"></button>
            <button data-i18n="community_tab_feed" data-target="community-content-feed" class="community-tab-btn font-semibold pb-3 border-b-2"></button>
        </div>

        <div id="community-tab-content-container">
            <div id="community-content-suche" class="community-tab-content">
                <div class="max-w-md mx-auto mb-8">
                    <input type="search" id="user-search-filter" data-i18n="[placeholder]community_search_placeholder" class="w-full bg-gray-900 border border-gray-600 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-50">
                </div>
                <div id="user-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                <div data-i18n="community_no_users_found" id="user-list-empty" class="hidden text-center text-gray-500 py-10"></div>
            </div>

            <div id="community-content-feed" class="community-tab-content hidden">
                <div id="activity-feed-list" class="max-w-3xl mx-auto space-y-4">
                </div>
            </div>
        </div>
    </div>
</section>
        <section id="matchmaker" class="page-section py-12 fade-in">
    <div class="container mx-auto px-6">
        <div class="bg-gray-800 border border-gray-700 rounded-xl p-4 md:p-8 max-w-3xl mx-auto shadow-2xl shadow-blue-900/20">
            <div id="ai-chat-window" class="h-[70vh] flex flex-col">
                <div class="flex-grow p-4 space-y-6 overflow-y-auto" id="chat-log"></div>
                <div id="user-input-area" class="p-4 border-t border-gray-700"></div>
            </div>
            <div id="matchmaker-result" class="hidden text-center fade-in p-4">
                <h2 data-i18n="matchmaker_result_title" class="text-3xl font-bold text-white mb-2"></h2>
                <div class="bg-gray-900 p-6 rounded-xl border border-gray-700">
                    <img id="result-img" src="https://placehold.co/600x400/111827/06B6D4?text=GAME" data-i18n="[alt]matchmaker_alt_game_cover" class="w-full mb-4 rounded-lg" loading="lazy" decoding="async">
                    <h3 id="result-title" class="text-4xl font-bold text-cyan-400">Game Title</h3>
                    <p id="result-description" class="text-lg text-gray-100 mt-4 mb-4"></p>
                    <div id="result-affiliate-links" class="mt-6 flex flex-col sm:flex-row gap-3">
                </div>
                </div>
                <button data-i18n="matchmaker_reset_button" id="reset-quiz" class="mt-8 text-gray-400 hover:text-white underline"></button>
            </div>
        </div>
    </div>
</section>
        <section id="chat-view" class="page-section py-12 fade-in">
    <div class="container mx-auto px-6 max-w-4xl">
        <div class="bg-gray-800 border border-gray-700 rounded-xl shadow-2xl flex flex-col h-[80vh]">
            
            <div class="p-4 border-b border-gray-700 flex items-center gap-4">
                <a href="#profile" class="text-gray-400 hover:text-white nav-trigger">&larr; Zur√ºck</a>
                <img id="chat-friend-avatar" src="https://i.pravatar.cc/40" class="w-10 h-10 rounded-full object-cover">
                <h2 id="chat-friend-name" class="text-xl font-bold text-white">Lade...</h2>
            </div>

            <div id="chat-log-messages" class="flex-grow p-4 space-y-4 overflow-y-auto">
                </div>

            <div class="p-4 border-t border-gray-700">
                <form id="chat-form" class="flex gap-2">
                    <input type="text" id="chat-message-input" placeholder="Nachricht schreiben..." class="flex-grow bg-gray-900 border border-gray-600 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-50" required>
                    <button type="submit" class="bg-blue-600 text-white font-semibold px-6 rounded-lg hover:bg-blue-500 transition-colors">Senden</button>
                </form>
            </div>

        </div>
    </div>
</section>
        <section id="profile" class="page-section py-12 fade-in">
    <div class="container mx-auto px-6 max-w-5xl">
        <div class="bg-gray-800 border border-gray-700 rounded-xl p-4 md:p-8 w-full mx-auto shadow-2xl">
            <div class="flex flex-col items-center mb-6">
                <img id="profile-avatar" src="https://i.pravatar.cc/150?u=placeholder" class="w-24 h-24 rounded-full border-2 border-cyan-400 object-cover mb-4" data-i18n="[alt]profile_alt_avatar">
                <div class="flex items-center justify-center gap-2">
                    <h2 id="profile-user-username" class="text-3xl font-bold text-white"></h2>
                    <button id="edit-username-btn" class="text-gray-400 hover:text-white">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.536L16.732 3.732z" /></svg>
                    </button>
                </div>
                <label for="avatar-upload" data-i18n="profile_change_avatar" class="mt-2 text-sm text-cyan-400 cursor-pointer hover:underline"></label>
                <input type="file" id="avatar-upload" class="hidden" accept="image/png, image/jpeg">
            </div>

            <div id="profile-tabs" class="border-b border-gray-700 mb-6 flex justify-start sm:justify-center gap-6 overflow-x-auto whitespace-nowrap">
                <button data-i18n="profile_tab_games" data-target="profile-content-spiele" class="profile-tab-btn font-semibold pb-3 border-b-2"></button>
                <button data-i18n="profile_tab_friends" data-target="profile-content-freunde" class="profile-tab-btn font-semibold pb-3 border-b-2"></button>
                <button data-i18n="profile_tab_stats" data-target="profile-content-stats" class="profile-tab-btn font-semibold pb-3 border-b-2"></button>
                <button data-i18n="profile_tab_lfg" data-target="profile-content-mitspieler" class="profile-tab-btn font-semibold pb-3 border-b-2"></button>
                <button data-i18n="profile_tab_news" data-target="profile-content-news" class="profile-tab-btn font-semibold pb-3 border-b-2"></button>

            </div>

<div id="profile-tab-content-container">

    <div id="profile-content-spiele" class="profile-tab-content">
        <div id="game-filter-buttons" class="flex justify-center gap-4 mb-6">
            <button data-i18n="profile_filter_all" data-filter="all" class="filter-btn active"></button>
            <button data-i18n="profile_filter_liked" data-filter="liked" class="filter-btn"></button>
            <button data-i18n="profile_filter_disliked" data-filter="disliked" class="filter-btn"></button>
        </div>
        <div id="saved-games-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        <p data-i18n="profile_no_saved_games" id="no-saved-games" class="hidden text-center text-gray-500 py-8"></p>
        <div id="load-more-container" class="text-center mt-8"></div>
    </div>

    <div id="profile-content-mitspieler" class="profile-tab-content space-y-6">
        <div id="mitspieler-gamelist-view">
            <h3 data-i18n="profile_lfg_title" class="text-xl font-bold text-white mb-4"></h3>
            <div id="mitspieler-gamelist" class="space-y-3"></div>
        </div>
        <div id="mitspieler-results-view" class="hidden">
            <button data-i18n="profile_lfg_back_button" id="back-to-gamelist-btn" class="mb-4 text-cyan-400 hover:underline"></button>
            <h3 id="mitspieler-results-title" class="text-xl font-bold text-white mb-4"></h3>
            <div id="mitspieler-results-list" class="space-y-3"></div>
        </div>
    </div>

    <div id="profile-content-freunde" class="profile-tab-content">
    <div id="friend-requests-section" class="hidden">
        <h3 data-i18n="profile_friend_requests_title" class="text-xl font-bold text-white mb-4"></h3>
        <div id="friend-requests-list" class="space-y-3 mb-8"></div>
    </div>
    <div>
        <h3 data-i18n="profile_friends_list_title" class="text-xl font-bold text-white mb-4"></h3>
        <div id="friends-list" class="space-y-3"></div>
    </div>
</div>

    <div id="profile-content-stats" class="profile-tab-content text-center active">
        <div class="flex flex-col sm:flex-row items-center justify-center gap-4 sm:gap-8 text-lg">
            <div class="bg-gray-900 p-4 rounded-lg text-center">
                <span class="block font-bold text-2xl text-yellow-400" id="profile-user-rank">...</span>
                <span data-i18n="profile_stat_rank" class="text-gray-400"></span>
            </div>
            <div class="bg-gray-900 p-4 rounded-lg text-center">
                <span class="block font-bold text-2xl text-yellow-400" id="profile-user-level">...</span>
                <span data-i18n="profile_stat_level" class="text-gray-400"></span>
            </div>
            <div class="bg-gray-900 p-4 rounded-lg text-center">
                <span class="block font-bold text-2xl text-yellow-400" id="profile-user-xp">...</span>
                <span data-i18n="profile_stat_xp" class="text-gray-400"></span>
            </div>
        </div>
        <div class="mt-8 max-w-md mx-auto">
            <div class="flex justify-between text-sm text-gray-400 mb-1">
                <span id="progress-current-xp">0 XP</span>
                <span id="progress-next-level-xp">100 XP</span>
            </div>
            <div class="w-full bg-gray-700 rounded-full h-2.5">
                <div id="progress-bar-fill" class="bg-cyan-400 h-2.5 rounded-full transition-all duration-500" style="width: 0%"></div>
            </div>
        </div>
        <div id="referral-container" class="hidden mt-8 mx-auto max-w-md p-4 bg-gray-900/50 border border-cyan-700/50 rounded-lg">
            <h4 class="font-bold text-cyan-300 text-lg">Dein Empfehlungscode</h4>
            <p class="text-gray-300 mt-2">Teile diesen Code mit Freunden. F√ºr jede erfolgreiche Anmeldung √ºber deinen Code kommst du im n√§chsten Giveaway einen Schritt n√§her an den Hauptpreis!</p>
            <div class="mt-4 flex items-center justify-center bg-gray-800 border border-gray-600 rounded-lg p-3">
                <span id="referral-code" class="text-2xl font-mono text-white tracking-widest">LADE...</span>
                <button id="copy-referral-code" class="ml-4 bg-cyan-600 text-white px-3 py-1 rounded-md hover:bg-cyan-500 text-sm">Kopieren</button>
            </div>
            <p class="text-yellow-400 mt-3 font-semibold">Anmeldungen √ºber deinen Code: <span id="referral-count">0</span></p>
        </div>
        <div id="daily-challenge-container" class="hidden mt-8 mx-auto max-w-md p-4 bg-yellow-900/50 border border-yellow-700 rounded-lg">
            <h4 data-i18n="daily_mission_title" class="font-bold text-yellow-300 text-lg"></h4>
            <p id="daily-challenge-text" class="text-yellow-200 mt-1"></p>
        </div>
    </div>

    <div id="profile-content-news" class="profile-tab-content space-y-4">
        </div>

</div>
                </div>
            </div>
        </div>
    </div>
</section>
        <section id="leaderboard" class="page-section py-12 fade-in">
    <div class="container mx-auto px-6 max-w-5xl">
        <h2 data-i18n="leaderboard_title" class="font-bold text-white mb-4 text-center text-fluid-heading"></h2>
        <div class="bg-gray-800 border border-gray-700 rounded-xl p-4 md:p-8 max-w-3xl mx-auto shadow-2xl">
            <p data-i18n="leaderboard_subtitle" class="text-gray-400 mb-6"></p>
            
            <div id="leaderboard-list" class="space-y-2">
            </div>
        </div>
    </div>
</section>
<section id="news" class="page-section py-12 fade-in">
    <div class="container mx-auto px-6 max-w-4xl">
        <h2 data-i18n="news_title" class="font-bold text-white mb-8 text-center text-fluid-heading"></h2>

        <div id="news-post-list" class="space-y-12">
            <p data-i18n="news_loading" class="text-center text-gray-400"></p>
        </div>
    </div>
</section>
<section id="partners" class="page-section py-12 fade-in">
    <div class="container mx-auto px-6 max-w-5xl">
        <div class="text-center mb-12">
            <h2 data-i18n="partners_title" class="font-bold text-white text-fluid-heading">Unsere Partner</h2>
            <p data-i18n="partners_subtitle" class="text-gray-400 mt-4 max-w-2xl mx-auto">Ein gro√ües Dankesch√∂n an die Communities und Projekte, die GameMatch unterst√ºtzen und mit denen wir zusammenarbeiten.</p>
        </div>

        <div id="partner-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8">
            </div>
    </div>
</section>
<section id="impressum" class="page-section py-12 fade-in">
  <div class="container mx-auto px-6 max-w-4xl text-gray-300">
    <h2 class="text-3xl font-bold text-white mb-6 text-center">Impressum</h2>
    <p><strong>Betreiber der Seite:</strong><br>
    Daniel Garcia<br>
    6845 Hohenems<br>
    E-Mail: <a href="mailto:aspireaut@gmail.com" class="text-cyan-400 hover:underline">aspireaut@gmail.com</a></p>

    <p class="mt-4">Verantwortlich gem√§√ü ¬ß 5 TMG.</p>
  </div>
</section>

<section id="datenschutz" class="page-section py-12 fade-in">
  <div class="container mx-auto px-6 max-w-4xl text-gray-300">
    <h2 class="text-3xl font-bold text-white mb-6 text-center">Datenschutzerkl√§rung</h2>
    
    <p>Der Schutz deiner pers√∂nlichen Daten ist uns ein besonderes Anliegen. Diese Website verarbeitet Daten ausschlie√ülich auf Grundlage der gesetzlichen Bestimmungen (DSGVO, TKG).</p>

    <h3 class="text-xl font-semibold text-white mt-6 mb-2">Verwendete Dienste:</h3>

    <ul class="list-disc list-inside space-y-2">
      <li><strong>Firebase / Google Cloud</strong>: Wird f√ºr Authentifizierung, Datenbank, Hosting und ggf. Analytics verwendet. Es k√∂nnen personenbezogene Daten (wie E-Mail-Adresse) verarbeitet werden.</li>
      <li><strong>Google Fonts</strong>: Schriftarten k√∂nnen von Google-Servern geladen werden. Dabei wird deine IP-Adresse an Google √ºbermittelt.</li>
      <li><strong>Google Gemini API</strong>: Bei Nutzung der KI-Dialogfunktionen k√∂nnen Inhalte an die Gemini-API von Google √ºbermittelt werden.</li>
      <li><strong>RAWG API</strong>: F√ºr Spieledaten-Abfragen wird die externe API von rawg.io genutzt. Dabei wird ggf. deine IP-Adresse an deren Server gesendet.</li>
      <li><strong>Netlify</strong>: Diese Website wird bei Netlify gehostet. Netlify erfasst ggf. IP-Adressen zur Fehleranalyse und Zugriffsstatistik.</li>
    </ul>

    <h3 class="text-xl font-semibold text-white mt-6 mb-2">Cookies:</h3>
    <p>Diese Website verwendet Cookies, um deine Nutzungserfahrung zu verbessern (z.‚ÄØB. Login-Zustand speichern). Du kannst Cookies in deinem Browser jederzeit deaktivieren.</p>

    <h3 class="text-xl font-semibold text-white mt-6 mb-2">Kontakt:</h3>
    <p>Bei Fragen zum Datenschutz kontaktiere uns bitte per E-Mail an <a href="mailto:aspireaut@gmail.com" class="text-cyan-400 hover:underline">aspireaut@gmail.com</a>.</p>
  </div>
</section>
<!-- ERSETZE DEN INHALT DEINER <section id="admin"> HIERMIT -->
<section id="admin" class="page-section py-12 fade-in">
    <div class="container mx-auto px-6 max-w-6xl">
        <h2 class="text-4xl font-bold text-white mb-8 text-center">Admin-Dashboard</h2>

        <!-- Admin Tabs -->
        <div id="admin-tabs" class="border-b border-gray-700 mb-6 flex justify-center gap-6">
            <button data-target="admin-content-users" class="profile-tab-btn font-semibold pb-3 border-b-2 active">Nutzerverwaltung</button>
            <button data-target="admin-content-blog" class="profile-tab-btn font-semibold pb-3 border-b-2">Blog-Verwaltung</button>
        </div>

        <!-- Admin Tab Inhalte -->
        <div id="admin-tab-content-container">

            <!-- Nutzerverwaltung (dein bisheriger Code) -->
            <div id="admin-content-users" class="profile-tab-content active">
                <div class="bg-gray-800 border border-gray-700 rounded-xl p-8">
                    <div class="mb-4">
                        <input type="text" id="admin-user-filter" placeholder="Nach Nutzername oder E-Mail filtern..." class="w-full bg-gray-900 border border-gray-600 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-yellow-400 text-gray-50">
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full text-sm text-left text-gray-300">
                            <thead class="text-xs text-gray-400 uppercase bg-gray-700/50">
                                <tr>
                                    <th scope="col" class="px-6 py-3">Nutzername</th>
                                    <th scope="col" class="px-6 py-3">E-Mail</th>
                                    <th scope="col" class="px-6 py-3">Level / XP</th>
                                    <th scope="col" class="px-6 py-3">Registriert am</th>
                                    <th scope="col" class="px-6 py-3">Aktionen</th>
                                </tr>
                            </thead>
                            <tbody id="admin-user-list-body"></tbody>
                        </table>
                    </div>
                    <div id="admin-user-list-empty" class="hidden text-center text-gray-500 py-10">Keine Nutzer gefunden.</div>
                </div>
            </div>

            <!-- Blog-Verwaltung (NEU) -->
            <div id="admin-content-blog" class="profile-tab-content">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                    <!-- Formular f√ºr neue Beitr√§ge -->
                    <div class="md:col-span-1">
                        <div class="bg-gray-800 border border-gray-700 rounded-xl p-6">
                            <h3 class="text-xl font-bold text-white mb-4">Neuen Beitrag erstellen</h3>
                            <form id="blog-post-form" class="space-y-4">
                                <input type="hidden" id="blog-post-id">
                                <div>
                                    <label for="blog-post-title" class="block text-sm font-medium text-gray-300">Titel</label>
                                    <input type="text" id="blog-post-title" required class="mt-1 w-full bg-gray-900 border border-gray-600 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-yellow-400 text-gray-50">
                                </div>
                                <div>
                                    <label for="blog-post-content" class="block text-sm font-medium text-gray-300">Inhalt</label>
                                    <textarea id="blog-post-content" rows="10" required class="mt-1 w-full bg-gray-900 border border-gray-600 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-yellow-400 text-gray-50"></textarea>
                                </div>
                                <div class="flex gap-4">
                                    <button type="submit" class="w-full bg-yellow-500 text-gray-900 font-semibold py-2 rounded-lg hover:bg-yellow-400 transition-colors">Beitrag speichern</button>
                                    <button type="button" id="clear-blog-form" class="w-full bg-gray-600 text-white font-semibold py-2 rounded-lg hover:bg-gray-500 transition-colors">Leeren</button>
                                </div>
                            </form>
                        </div>
                    </div>
                    <!-- Liste bestehender Beitr√§ge -->
                    <div class="md:col-span-2">
                        <div class="bg-gray-800 border border-gray-700 rounded-xl p-6">
                            <h3 class="text-xl font-bold text-white mb-4">Bestehende Beitr√§ge</h3>
                            <div id="admin-blog-post-list" class="space-y-4">
                                <!-- Beitr√§ge werden hier per JS geladen -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</section>
    </main>
    
   <footer class="bg-gray-800 border-t border-gray-700 mt-20">
        <div class="container mx-auto px-6 py-4 text-center">
            <div class="flex justify-center gap-6 mb-4">
                <a href="#impressum" class="text-gray-400 hover:text-white nav-trigger">Impressum</a>
                <a href="#datenschutz" class="text-gray-400 hover:text-white nav-trigger">Datenschutz</a>
                <button id="open-cookie-settings" class="text-gray-400 hover:text-white">Cookie-Einstellungen</button>
            </div>
            <p class="text-gray-400 text-sm mb-2">Besucher: <span id="visit-counter">Lade...</span></p>
            <p class="text-gray-400 text-sm">&copy; 2025 GameMatch. Alle Rechte vorbehalten. Made with ‚ù§Ô∏è in Austria</p>
        </div>
    </footer>

    <!-- Cookie Banner mit Opt-out-M√∂glichkeit -->
    <div id="cookie-banner" class="fixed bottom-0 left-0 right-0 bg-gray-800 border-t border-gray-700 p-4 shadow-lg z-50 hidden">
        <div class="container mx-auto max-w-6xl">
            <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                <div class="flex-1">
                    <p class="text-gray-300">
                        Wir verwenden Cookies, um die Funktionalit√§t der Website zu gew√§hrleisten und deine Erfahrung zu verbessern. 
                        <a href="#datenschutz" class="text-cyan-400 hover:underline nav-trigger">Mehr erfahren</a>
                    </p>
                </div>
                <div class="flex flex-col sm:flex-row gap-2">
                    <button id="accept-necessary-cookies" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg transition-colors">
                        Nur notwendige Cookies
                    </button>
                    <button id="accept-all-cookies" class="px-4 py-2 bg-cyan-600 hover:bg-cyan-500 text-white rounded-lg transition-colors">
                        Alle Cookies akzeptieren
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Cookie Einstellungen Modal -->
    <div id="cookie-settings-modal" class="fixed inset-0 bg-black bg-opacity-70 z-[1000] flex items-center justify-center p-4 invisible opacity-0 transition-opacity">
        <div class="glow-bg bg-gray-800 rounded-xl p-6 w-full max-w-2xl border border-cyan-700/50 shadow-2xl">
            <h2 class="text-2xl font-bold text-white mb-4">Cookie-Einstellungen</h2>
            
            <div class="space-y-6">
                <div class="border-b border-gray-700 pb-4">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="text-lg font-semibold text-white">Notwendige Cookies</h3>
                        <span class="px-2 py-1 bg-gray-700 text-xs rounded text-gray-300">Immer aktiv</span>
                    </div>
                    <p class="text-gray-400 text-sm">
                        Diese Cookies sind f√ºr den Betrieb der Website essenziell und k√∂nnen nicht deaktiviert werden.
                    </p>
                </div>
                
                <div class="border-b border-gray-700 pb-4">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="text-lg font-semibold text-white">Funktionale Cookies</h3>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="functional-cookies" class="sr-only peer" checked>
                            <div class="w-11 h-6 bg-gray-700 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-cyan-600"></div>
                        </label>
                    </div>
                    <p class="text-gray-400 text-sm">
                        Erm√∂glichen erweiterte Funktionen wie gespeicherte Anmeldedaten und Einstellungen.
                    </p>
                </div>
                
                <div class="border-b border-gray-700 pb-4">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="text-lg font-semibold text-white">Analytics Cookies</h3>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="analytics-cookies" class="sr-only peer">
                            <div class="w-11 h-6 bg-gray-700 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-cyan-600"></div>
                        </label>
                    </div>
                    <p class="text-gray-400 text-sm">
                        Helfen uns zu verstehen, wie Besucher unsere Website nutzen.
                    </p>
                </div>
            </div>
            
            <div class="flex justify-end gap-4 mt-6">
                <button id="save-cookie-settings" class="px-6 py-2 bg-cyan-600 hover:bg-cyan-500 text-white rounded-lg transition-colors">
                    Einstellungen speichern
                </button>
                <button id="close-cookie-settings" class="px-6 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg transition-colors">
                    Abbrechen
                </button>
            </div>
        </div>
    </div>
    <canvas id="confetti-canvas" class="fixed top-0 left-0 w-full h-full pointer-events-none z-50"></canvas>

<div id="auth-modal" class="auth-modal fixed inset-0 bg-black bg-opacity-70 z-[100] flex items-center justify-center p-4 invisible opacity-0">
    <div id="auth-modal-content" class="auth-modal-content glow-bg bg-gray-800 rounded-2xl w-full max-w-md p-8 border border-cyan-700/50 shadow-2xl shadow-cyan-900/20 transform scale-95">
        
        <div id="login-view">
            <h2 data-i18n="auth_welcome_back" class="text-2xl font-bold text-white text-center mb-6"></h2>
            <form id="login-form" class="space-y-4">
                <input type="email" id="login-email" data-i18n="[placeholder]auth_placeholder_email" required class="w-full bg-gray-900 border border-gray-600 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-cyan-500 text-gray-50">
                
                <input type="password" id="login-password" data-i18n="[placeholder]auth_placeholder_password" required class="w-full bg-gray-900 border border-gray-600 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-cyan-500 text-gray-50">
                
                <p id="login-error" class="text-red-400 text-sm hidden"></p>
                <button type="submit" data-i18n="nav_login" class="w-full bg-cyan-600 text-white font-semibold py-3 rounded-lg hover:bg-cyan-500 transition-colors"></button>
            </form>
            <div class="flex items-center my-4">
                <hr class="flex-grow border-gray-600">
                <span data-i18n="auth_or" class="px-2 text-gray-400 text-sm"></span>
                <hr class="flex-grow border-gray-600">
            </div>
            <button id="google-signin-btn" class="w-full bg-gray-700 text-white font-semibold py-3 rounded-lg hover:bg-gray-600 transition-colors flex items-center justify-center gap-2">
                <svg class="w-5 h-5" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12s5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24s8.955,20,20,20s20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"></path><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"></path><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"></path><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.571l6.19,5.238C42.021,35.596,44,30.138,44,24C44,22.659,43.862,21.35,43.611,20.083z"></path></svg>
                <span data-i18n="auth_continue_with_google"></span>
            </button>
            <p class="text-center text-sm text-gray-400 mt-6">
                <span data-i18n="auth_no_account_yet"></span>
                <button data-i18n="nav_register" id="switch-to-register" class="font-semibold text-cyan-400 hover:underline"></button>
            </p>
        </div>

        <div id="register-view" class="hidden">
            <h2 data-i18n="auth_register_title" class="text-2xl font-bold text-white text-center mb-6"></h2>
             <form id="register-form" class="space-y-4">
                <input type="email" id="register-email" data-i18n="[placeholder]auth_placeholder_email" required class="w-full bg-gray-900 border border-gray-600 rounded-lg p-3">
                <input type="text" id="register-username" data-i18n="[placeholder]auth_placeholder_username" required class="w-full bg-gray-900 border border-gray-600 rounded-lg p-3">
                <input type="password" id="register-password" data-i18n="[placeholder]auth_placeholder_password_min" required class="w-full bg-gray-900 border border-gray-600 rounded-lg p-3">
                 <input type="text" id="register-referral-code" placeholder="Empfehlungscode (Optional)" class="w-full bg-gray-900 border border-gray-600 rounded-lg p-3">
                <p id="register-error" class="text-red-400 text-sm hidden"></p>
                <button type="submit" data-i18n="auth_create_account" class="w-full bg-cyan-500 text-gray-900 font-semibold py-3 rounded-lg hover:bg-cyan-400"></button>
            </form>
             <div class="flex items-center my-4">
                <hr class="flex-grow border-gray-600">
                <span data-i18n="auth_or" class="px-2 text-gray-400 text-sm"></span>
                <hr class="flex-grow border-gray-600">
            </div>
            <button id="google-signup-btn" class="w-full bg-gray-700 text-white font-semibold py-3 rounded-lg hover:bg-gray-600 transition-colors flex items-center justify-center gap-2">
                <svg class="w-5 h-5" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12s5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24s8.955,20,20,20s20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"></path><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"></path><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"></path><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.571l6.19,5.238C42.021,35.596,44,30.138,44,24C44,22.659,43.862,21.35,43.611,20.083z"></path></svg>
                <span data-i18n="auth_register_with_google"></span>
            </button>
            <p class="text-center text-sm text-gray-400 mt-6">
                <span data-i18n="auth_already_have_account"></span>
                <button data-i18n="nav_login" id="switch-to-login" class="font-semibold text-cyan-400 hover:underline"></button>
            </p>
        </div>
        
        <button id="close-auth-modal-btn" class="absolute top-4 right-4 text-gray-500 hover:text-white transition-colors">
            <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
        </button>
    </div>
</div>

<div id="game-detail-modal" class="fixed inset-0 bg-black bg-opacity-70 z-[100] flex items-center justify-center p-4 invisible opacity-0 transition-opacity duration-300">
    <div id="game-detail-modal-content" class="bg-gray-800 rounded-2xl w-full max-w-4xl max-h-[90vh] flex flex-col border border-gray-700 shadow-2xl shadow-cyan-900/20 transform scale-95 transition-all duration-300">
        <div class="flex-shrink-0 p-4 border-b border-gray-700 flex justify-between items-center">
            <h2 id="modal-game-title" class="text-2xl font-bold text-white"></h2>
            <button id="close-comment-modal" class="text-gray-500 hover:text-white transition-colors">
                <svg class="w-8 h-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
        </div>
        <div class="flex-grow overflow-y-auto p-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <img id="modal-game-image" src="https://placehold.co/600x400/111827/06B6D4?text=Lade..." data-i18n="[alt]matchmaker_alt_game_cover" class="w-full h-auto object-cover rounded-lg mb-4">
                    <p id="modal-game-description" class="text-gray-300"></p>
                </div>
                <div>
                    <h3 data-i18n="modal_community_ratings" class="text-xl font-semibold text-white mb-4"></h3>
                    <div id="modal-rating-section" class="space-y-3 mb-6"></div>
                    <h3 data-i18n="modal_comments" class="text-xl font-semibold text-white mb-4"></h3>
                    <div id="modal-comment-list" class="space-y-4 max-h-60 overflow-y-auto pr-2"></div>
                    <div id="modal-comment-form" class="mt-4 pt-4 border-t border-gray-700"></div>
                </div>
            </div>
        </div>
    </div>
</div>

    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-storage-compat.js"></script>
    <script>
function sanitizeHTML(str) {
    if (!str) return '';
    return str.replace(/[&<>"']/g, function(tag) {
        const replacements = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#39;'
        };
        return replacements[tag] || tag;
    });
}
const partners = [
    {
        name: 'Bodycam',
        logoUrl: 'img/partners/logo2.png',
        websiteUrl: 'https://discord.gg/XwXvKGjUYy',
        description: 'BodyCam - der realistischste Shooter auf dem Markt, schaut heute noch auf dem Discord vorbei!'
    },
    {
        name: 'GameMatch - Discord',
        logoUrl: 'img/partners/logo1.png',
        websiteUrl: 'https://discord.gg/CTUERAwgNE', // Hier den Link zum Partner einf√ºgen
        description: 'Besuche uns auf Discord'
    },
    {
        name: 'Partner 3',
        logoUrl: 'img/partners/logo3.png',
        websiteUrl: '#',
        description: 'Wir suchen nach weiteren Partnern'
    }
    // F√ºge hier bei Bedarf weitere Partner hinzu...
];
 const affiliatePartners = [
        {
            name: 'G2A',
            urlTemplate: 'https://www.g2a.com/search?query={{GAME_NAME}}&r=reflink-0a5413ec7b',
            logo: 'img/affiliates/g2a_logo.png'
        },
        {
            name: 'Instant Gaming',
            urlTemplate: 'https://www.instant-gaming.com/de/suche/?q={{GAME_NAME}}&igr=gamer-918c25',
            logo: 'img/affiliates/instant-gaming_logo.png'
        },
        {
            name: 'GAMIVO',
            urlTemplate: 'https://www.gamivo.com/search/{{GAME_NAME}}?glv=wbrggj3c',
            logo: 'img/affiliates/gamivo_logo.png'
        }
    ];
const translations = {
  de: {
    translation: {
      "nav_find_game": "Finde dein Spiel",
      "nav_login": "Login",
      "nav_register": "Registrieren",
      "nav_news": "News",
      "nav_community": "Community",
      "nav_partners": "Partner", 
      "partners_title": "Unsere Partner",
      "partners_subtitle": "Ein gro√ües Dankesch√∂n an die Communities und Projekte, die GameMatch unterst√ºtzen und mit denen wir zusammenarbeiten.",
      "nav_profile": "Mein Profil",
      "nav_leaderboard": "Rangliste",
      "nav_feedback": "Feedback",
      "nav_admin": "Admin",
      "nav_logout": "Logout",
      "hero_title": "Finde dein n√§chstes Lieblingsspiel. <br class=\"hidden md:inline\"/> Ohne endloses Scrollen.",
      "hero_subtitle": "Unser KI-Berater kennt deinen Geschmack. Egal ob du entspannen, schwitzen oder die Nacht durchzocken willst.",
      "hero_cta": "Jetzt dein Spiel finden,kostenlos",
      "daily_mission_title": "T√§gliche Challenge",
      "daily_mission_reward": "Belohnung:",
      "daily_mission_cta": "Challenge ansehen!",
      "member_advantage": "Dein Vorteil als Mitglied",
      "become_part_of": "Werde Teil von GameMatch",
      "discover_platform": "Entdecke eine Plattform, die dich versteht. Vom perfekten Spielvorschlag bis zur lebendigen Community ‚Äì hier findest du alles.",
      "feature_ai_title": "Deine pers√∂nliche KI",
      "feature_ai_desc": "Schluss mit der Unentschlossenheit. Unsere KI f√ºhrt ein echtes Gespr√§ch mit dir und findet zielsicher das Spiel, auf das du gerade wirklich Lust hast.",
      "feature_archive_title": "Dein Spiele-Archiv",
      "feature_archive_desc": "Jedes \"gelikte\" Spiel landet in deinem Profil. Bewerte und kommentiere deine Sammlung und baue dir so deinen digitalen Troph√§enschrank auf.",
      "feature_crew_title": "Finde deine Crew",
      "feature_crew_desc": "Verbinde dich mit Gamern, die deinen Geschmack teilen. Vergleicht eure Sammlungen, entdeckt gemeinsame Favoriten und werdet Teil einer wachsenden Community.",
      "guest_cta_title": "Bereit f√ºr dein n√§chstes Lieblingsspiel?",
      "guest_cta_desc": "Als Gast kannst du unsere KI <strong>2-mal t√§glich</strong> kostenlos testen. <strong>Registriere dich jetzt</strong>, um unbegrenzte Vorschl√§ge und alle oben genannten Features freizuschalten.",
      "guest_cta_register": "Jetzt kostenlos registrieren",
      "guest_cta_login": "Ich habe schon ein Konto &rarr;",
      "stay_updated": "Bleib auf dem Laufenden",
      "latest_news": "Aktuelles von GameMatch",
      "read_our_posts": "Lies unsere neuesten Beitr√§ge √ºber Updates, Spiel-Highlights und Community-News.",
      "loading_posts": "Lade neueste Beitr√§ge...",
      "our_partners": "Unsere Partner",
      "community_title": "Community",
      "community_subtitle": "Entdecke andere Spieler oder verfolge die letzten Aktivit√§ten.",
      "community_tab_discover": "Nutzer entdecken",
      "community_tab_feed": "Aktivit√§ten",
      "community_search_placeholder": "Nach Benutzernamen filtern...",
      "community_no_users_found": "Keine anderen Nutzer gefunden.",
      "matchmaker_result_title": "Dein perfektes Match!",
      "matchmaker_reset_button": "Neues Gespr√§ch starten &crarr;",
      "matchmaker_alt_game_cover": "Game Cover",
      "matchmaker_initial_greeting": "Hallo! Ich bin GameMatch. Damit ich das perfekte Spiel f√ºr dich finde, erz√§hl mir doch mal: Worauf hast du gerade Lust?",
      "matchmaker_initial_placeholder": "z.B. etwas Entspanntes zum Abschalten",
      "matchmaker_user_bubble": "Du",
      "matchmaker_ai_bubble": "GameMatch KI",
      "matchmaker_find_on_g2a": "Auf G2A finden",
      "matchmaker_error_title": "Hoppla!",
      "matchmaker_error_button": "Neu beginnen",
      "matchmaker_loading_ai": "KI denkt nach",
      "matchmaker_guest_limit_title": "Du hast dein Limit erreicht!",
      "matchmaker_guest_limit_desc": "Als Gast kannst du 3 Spiele pro Tag entdecken. Registriere dich jetzt kostenlos, um unbegrenzte Empfehlungen und viele weitere Features freizuschalten.",
      "matchmaker_guest_limit_register": "Jetzt Registrieren",
      "profile_alt_avatar": "Avatar",
      "profile_change_avatar": "Profilbild √§ndern",
      "profile_tab_games": "Meine Spiele",
      "profile_tab_friends": "Freunde",
      "profile_tab_stats": "Statistiken",
      "profile_tab_lfg": "Mitspieler finden",
      "profile_tab_news": "Gaming News",
      "profile_filter_all": "Alle",
      "profile_filter_liked": "üëç Gemocht",
      "profile_filter_disliked": "üëé Abgelehnt",
      "profile_no_saved_games": "Du hast noch keine Spiele gespeichert.",
      "profile_lfg_title": "W√§hle ein Spiel, um Mitspieler zu finden",
      "profile_lfg_back_button": "&larr; Zur√ºck zur Spielauswahl",
      "profile_friend_requests_title": "Offene Freundschaftsanfragen",
      "profile_friends_list_title": "Meine Freundesliste",
      "profile_stat_rank": "Rang",
      "profile_stat_level": "Level",
      "profile_stat_xp": "XP",
      "profile_loading": "Lade...",
      "profile_user_not_found": "Nutzer nicht gefunden",
      "profile_no_friends": "Du hast noch keine Freunde.",
      "profile_friends_list_private": "Du kannst nur deine eigene Freundesliste einsehen.",
      "profile_error_loading": "Fehler beim Laden",
      "profile_lfg_loading_games": "Lade deine Spiele...",
      "profile_lfg_no_liked_games": "Du hast noch keine Spiele gelikt, um Mitspieler zu finden.",
      "profile_lfg_error_loading": "Fehler beim Laden deiner Spiele.",
      "profile_lfg_results_title": "Spieler, die auch \"{{gameTitle}}\" m√∂gen:",
      "profile_lfg_searching": "Suche nach Spielern...",
      "profile_lfg_no_one_else": "Noch niemand au√üer dir mag dieses Spiel.",
      "profile_lfg_trendsetter": "Bisher hat nur du dieses Spiel gelikt. Sei ein Trendsetter!",
      "profile_lfg_error_player_list": "Spielerliste konnte nicht geladen werden.",
      "profile_games_compare": "Vergleichen",
      "profile_games_chat": "Chat",
      "profile_xp_until_next_level": "{{xp}} XP bis Lvl {{level}}",
      "profile_load_more": "Mehr laden",
      "profile_no_games_for_filter": "Keine Spiele f√ºr den Filter \"{{filter}}\" gefunden.",
      "alert_friend_request_accepted": "Freundschaftsanfrage angenommen!",
      "alert_friend_request_declined": "Freundschaftsanfrage abgelehnt.",
      "alert_login_to_send_request": "Bitte logge dich ein, um Anfragen zu senden.",
      "alert_request_already_sent": "Du hast bereits eine Anfrage an diesen Nutzer gesendet oder bist bereits mit ihm befreundet.",
      "alert_friend_request_sent": "Freundschaftsanfrage gesendet!",
      "alert_friend_request_failed": "Die Anfrage konnte nicht gesendet werden.",
      "prompt_enter_new_username": "Gib deinen neuen Benutzernamen ein:",
      "alert_username_empty": "Der Benutzername darf nicht leer sein.",
      "alert_username_changed": "Benutzername erfolgreich ge√§ndert!",
      "alert_username_change_failed": "Der Name konnte nicht ge√§ndert werden.",
      "alert_uploading_image": "Lade Bild hoch...",
      "alert_avatar_changed": "Profilbild erfolgreich aktualisiert!",
      "alert_avatar_failed": "Upload fehlgeschlagen.",
      "button_text_requested": "Angefragt",
      "leaderboard_title": "Rangliste",
      "leaderboard_subtitle": "Die Top 10 Spieler mit den meisten Erfahrungspunkten.",
      "leaderboard_loading": "Lade Rangliste...",
      "leaderboard_no_players": "Noch keine Spieler in der Rangliste.",
      "leaderboard_error": "Rangliste konnte nicht geladen werden.",
      "news_title": "Neuigkeiten & Updates",
      "news_loading": "Lade Beitr√§ge...",
      "news_no_posts": "Es gibt noch keine Neuigkeiten.",
      "news_error": "Beitr√§ge konnten nicht geladen werden.",
      "news_published_on": "Ver√∂ffentlicht am",
      "auth_welcome_back": "Willkommen zur√ºck!",
      "auth_placeholder_email": "E-Mail",
      "auth_placeholder_password": "Passwort",
      "auth_placeholder_username": "Benutzername",
      "auth_placeholder_password_min": "Passwort (min. 6 Zeichen)",
      "auth_or": "ODER",
      "auth_continue_with_google": "Mit Google fortfahren",
      "auth_no_account_yet": "Noch kein Konto?",
      "auth_register_title": "Werde Teil der Community",
      "auth_create_account": "Konto erstellen",
      "auth_register_with_google": "Mit Google registrieren",
      "auth_already_have_account": "Bereits ein Konto?",
      "modal_loading_game": "Spiel wird geladen...",
      "modal_loading_description": "Beschreibung wird geladen...",
      "modal_community_ratings": "Community-Bewertungen",
      "modal_comments": "Kommentare",
      "alert_register_success": "Registrierung erfolgreich! Du bist jetzt eingeloggt.",
      "alert_login_success": "Login erfolgreich!",
      "alert_account_banned": "Dein Account wurde gesperrt. Bitte kontaktiere den Support.",
      "alert_google_register_success": "Konto erfolgreich mit Google erstellt!",
      "alert_google_welcome_back": "Willkommen zur√ºck, {{name}}!",
      "alert_google_signin_error": "Google Sign-In Fehler ({{errorCode}}): {{errorMessage}}",
      "alert_logout_success": "Du wurdest erfolgreich ausgeloggt.",
      "alert_logout_error": "Fehler beim Logout: {{message}}",
      "alert_comment_failed": "Fehler beim Speichern deines Kommentars.",
      "alert_login_for_rating": "Bitte logge dich ein, um eine Bewertung abzugeben.",
      "alert_rating_success": "Danke f√ºr deine Bewertung!",
      "alert_rating_failed": "Deine Bewertung konnte nicht gespeichert werden.",
      "footer_imprint": "Impressum",
      "footer_privacy": "Datenschutz",
      "footer_cookies": "Cookie-Einstellungen",
      "footer_visitors": "Besucher:",
      "footer_copyright": "&copy; 2025 GameMatch. Alle Rechte vorbehalten. Made with ‚ù§Ô∏è in Austria",
      "cookie_banner_text": "Wir verwenden Cookies, um die Funktionalit√§t der Website zu gew√§hrleisten und deine Erfahrung zu verbessern.",
      "cookie_learn_more": "Mehr erfahren",
      "cookie_accept_necessary": "Nur notwendige Cookies",
      "cookie_accept_all": "Alle Cookies akzeptieren",
      "cookie_settings_title": "Cookie-Einstellungen",
      "cookie_necessary_title": "Notwendige Cookies",
      "cookie_necessary_active": "Immer aktiv",
      "cookie_necessary_desc": "Diese Cookies sind f√ºr den Betrieb der Website essenziell und k√∂nnen nicht deaktiviert werden.",
      "cookie_functional_title": "Funktionale Cookies",
      "cookie_functional_desc": "Erm√∂glichen erweiterte Funktionen wie gespeicherte Anmeldedaten und Einstellungen.",
      "cookie_analytics_title": "Analytics Cookies",
      "cookie_analytics_desc": "Helfen uns zu verstehen, wie Besucher unsere Website nutzen.",
      "cookie_save_settings": "Einstellungen speichern",
      "cookie_cancel": "Abbrechen",
      "admin_dashboard_title": "Admin-Dashboard",
      "admin_tab_users": "Nutzerverwaltung",
      "admin_tab_blog": "Blog-Verwaltung",
      "admin_users_filter_placeholder": "Nach Nutzername oder E-Mail filtern...",
      "admin_users_th_user": "Nutzername",
      "admin_users_th_email": "E-Mail",
      "admin_users_th_level": "Level / XP",
      "admin_users_th_registered": "Registriert am",
      "admin_users_th_actions": "Aktionen",
      "admin_users_no_users": "Keine Nutzer gefunden.",
      "admin_blog_create_title": "Neuen Beitrag erstellen",
      "admin_blog_form_title": "Titel",
      "admin_blog_form_content": "Inhalt",
      "admin_blog_form_save": "Beitrag speichern",
      "admin_blog_form_clear": "Leeren",
      "admin_blog_existing_title": "Bestehende Beitr√§ge",
      "admin_blog_edit": "Bearbeiten",
      "admin_blog_delete": "L√∂schen",
      "chat_back": "&larr; Zur√ºck",
      "chat_loading": "Lade...",
      "chat_placeholder": "Nachricht schreiben...",
      "chat_send": "Senden",
      "profile_request_received": "hat dir eine Anfrage gesendet.",
      "profile_request_accept": "Annehmen",
      "profile_request_decline": "Ablehnen",
      "giveaway_banner_title": "Sommer-Giveaway!",
    "giveaway_banner_text": "Gewinne einen 50‚Ç¨ Steam-Gutschein! Der Nutzer mit den meisten XP am 31. August gewinnt. Viel Gl√ºck!",
    "feature_section_title": "Dein pers√∂nliches Gaming-Universum",
    "feature_section_subtitle": "Mehr als nur Empfehlungen",
    "feature_section_desc": "Ein GameMatch-Konto ist dein zentraler Hub f√ºr alles, was mit deinen Spielen zu tun hat. Sammle, teile und verfolge deinen Fortschritt.",
    "feature_new_library_title": "Deine Bibliothek",
    "feature_new_library_desc": "Jedes Spiel, das du magst, wird hier gespeichert. Erstelle deine ultimative Sammlung, bewerte sie und zeige sie deinen Freunden.",
    "feature_new_crew_title": "Deine Crew",
    "feature_new_crew_desc": "Finde Spieler, die deinen Geschmack teilen. Vergleicht eure Bibliotheken und findet heraus, welche Spiele ihr gemeinsam zocken k√∂nnt.",
    "feature_new_progress_title": "Dein Fortschritt",
    "feature_new_progress_desc": "Sammle f√ºr deine Aktivit√§ten auf der Seite Erfahrungspunkte (XP), steige im Level auf und schalte neue R√§nge frei.",
    }
  },
  en: {
    translation: {
      "nav_find_game": "Find your Game",
      "nav_login": "Login",
      "nav_register": "Register",
      "nav_news": "News",
      "nav_community": "Community",
      "nav_partners": "Partners",
      "partners_title": "Our Partners",
      "partners_subtitle": "A huge thank you to the communities and projects that support GameMatch and collaborate with us.",
      "nav_profile": "My Profile",
      "nav_leaderboard": "Leaderboard",
      "nav_feedback": "Feedback",
      "nav_admin": "Admin",
      "nav_logout": "Logout",
      "hero_title": "Find your next favorite game. <br class=\"hidden md:inline\"/> Without endless scrolling.",
      "hero_subtitle": "Our AI advisor knows your taste. Whether you want to relax, sweat, or game all night.",
      "hero_cta": "Find your game now,free",
      "daily_mission_title": "Your Daily Mission",
      "daily_mission_reward": "Reward:",
      "daily_mission_cta": "View Challenge!",
      "member_advantage": "Your Advantage as a Member",
      "become_part_of": "Become a Part of GameMatch",
      "discover_platform": "Discover a platform that understands you. From the perfect game suggestion to a vibrant community ‚Äì you'll find everything here.",
      "feature_ai_title": "Your Personal AI",
      "feature_ai_desc": "No more indecision. Our AI has a real conversation with you and reliably finds the game you're in the mood for.",
      "feature_archive_title": "Your Game Archive",
      "feature_archive_desc": "Every \"liked\" game lands in your profile. Rate and comment on your collection and build your digital trophy case.",
      "feature_crew_title": "Find Your Crew",
      "feature_crew_desc": "Connect with gamers who share your taste. Compare your collections, discover mutual favorites, and become part of a growing community.",
      "guest_cta_title": "Ready for your next favorite game?",
      "guest_cta_desc": "As a guest, you can test our AI <strong>2 times daily</strong> for free. <strong>Register now</strong> to unlock unlimited suggestions and all the features mentioned above.",
      "guest_cta_register": "Register now for free",
      "guest_cta_login": "I already have an account &rarr;",
      "stay_updated": "Stay Up-to-Date",
      "latest_news": "Latest from GameMatch",
      "read_our_posts": "Read our latest posts about updates, game highlights, and community news.",
      "loading_posts": "Loading latest posts...",
      "our_partners": "Our Partners",
      "community_title": "Community",
      "community_subtitle": "Discover other players or follow the latest activities.",
      "community_tab_discover": "Discover Users",
      "community_tab_feed": "Activity Feed",
      "community_search_placeholder": "Filter by username...",
      "community_no_users_found": "No other users found.",
      "matchmaker_result_title": "Your Perfect Match!",
      "matchmaker_reset_button": "Start a new conversation &crarr;",
      "matchmaker_alt_game_cover": "Game Cover",
      "matchmaker_initial_greeting": "Hi! I'm GameMatch. To help me find the perfect game for you, tell me: What are you in the mood for?",
      "matchmaker_initial_placeholder": "e.g., something relaxing to unwind",
      "matchmaker_user_bubble": "You",
      "matchmaker_ai_bubble": "GameMatch AI",
      "matchmaker_find_on_g2a": "Find on G2A",
      "matchmaker_error_title": "Oops!",
      "matchmaker_error_button": "Start Over",
      "matchmaker_loading_ai": "AI is thinking",
      "matchmaker_guest_limit_title": "You've reached your limit!",
      "matchmaker_guest_limit_desc": "As a guest, you can discover 3 games per day. Register now for free to unlock unlimited recommendations and many more features.",
      "matchmaker_guest_limit_register": "Register Now",
      "profile_alt_avatar": "Avatar",
      "profile_change_avatar": "Change profile picture",
      "profile_tab_games": "My Games",
      "profile_tab_friends": "Friends",
      "profile_tab_stats": "Statistics",
      "profile_tab_lfg": "Find Players",
      "profile_tab_news": "Gaming News",
      "profile_filter_all": "All",
      "profile_filter_liked": "üëç Liked",
      "profile_filter_disliked": "üëé Disliked",
      "profile_no_saved_games": "You haven't saved any games yet.",
      "profile_lfg_title": "Select a game to find players",
      "profile_lfg_back_button": "&larr; Back to game selection",
      "profile_friend_requests_title": "Open Friend Requests",
      "profile_friends_list_title": "My Friend List",
      "profile_stat_rank": "Rank",
      "profile_stat_level": "Level",
      "profile_stat_xp": "XP",
      "profile_loading": "Loading...",
      "profile_user_not_found": "User not found",
      "profile_no_friends": "You don't have any friends yet.",
      "profile_friends_list_private": "You can only view your own friend list.",
      "profile_error_loading": "Error loading",
      "profile_lfg_loading_games": "Loading your games...",
      "profile_lfg_no_liked_games": "You haven't liked any games to find players for.",
      "profile_lfg_error_loading": "Error loading your games.",
      "profile_lfg_results_title": "Players who also like \"{{gameTitle}}\":",
      "profile_lfg_searching": "Searching for players...",
      "profile_lfg_no_one_else": "Nobody else likes this game yet.",
      "profile_lfg_trendsetter": "So far, only you have liked this game. Be a trendsetter!",
      "profile_lfg_error_player_list": "Player list could not be loaded.",
      "profile_games_compare": "Compare",
      "profile_games_chat": "Chat",
      "profile_xp_until_next_level": "{{xp}} XP to Lvl {{level}}",
      "profile_load_more": "Load more",
      "profile_no_games_for_filter": "No games found for the \"{{filter}}\" filter.",
      "alert_friend_request_accepted": "Friend request accepted!",
      "alert_friend_request_declined": "Friend request declined.",
      "alert_login_to_send_request": "Please log in to send requests.",
      "alert_request_already_sent": "You have already sent a request to this user or are already friends.",
      "alert_friend_request_sent": "Friend request sent!",
      "alert_friend_request_failed": "The request could not be sent.",
      "prompt_enter_new_username": "Enter your new username:",
      "alert_username_empty": "Username cannot be empty.",
      "alert_username_changed": "Username changed successfully!",
      "alert_username_change_failed": "The name could not be changed.",
      "alert_uploading_image": "Uploading image...",
      "alert_avatar_changed": "Profile picture updated successfully!",
      "alert_avatar_failed": "Upload failed.",
      "button_text_requested": "Requested",
      "leaderboard_title": "Leaderboard",
      "leaderboard_subtitle": "The Top 10 players with the most experience points.",
      "leaderboard_loading": "Loading leaderboard...",
      "leaderboard_no_players": "No players on the leaderboard yet.",
      "leaderboard_error": "Leaderboard could not be loaded.",
      "news_title": "News & Updates",
      "news_loading": "Loading posts...",
      "news_no_posts": "There are no news yet.",
      "news_error": "Posts could not be loaded.",
      "news_published_on": "Published on",
      "auth_welcome_back": "Welcome back!",
      "auth_placeholder_email": "E-Mail",
      "auth_placeholder_password": "Password",
      "auth_placeholder_username": "Username",
      "auth_placeholder_password_min": "Password (min. 6 characters)",
      "auth_or": "OR",
      "auth_continue_with_google": "Continue with Google",
      "auth_no_account_yet": "No account yet?",
      "auth_register_title": "Join the Community",
      "auth_create_account": "Create Account",
      "auth_register_with_google": "Register with Google",
      "auth_already_have_account": "Already have an account?",
      "modal_loading_game": "Loading game...",
      "modal_loading_description": "Loading description...",
      "modal_community_ratings": "Community Ratings",
      "modal_comments": "Comments",
      "alert_register_success": "Registration successful! You are now logged in.",
      "alert_login_success": "Login successful!",
      "alert_account_banned": "Your account has been suspended. Please contact support.",
      "alert_google_register_success": "Account successfully created with Google!",
      "alert_google_welcome_back": "Welcome back, {{name}}!",
      "alert_google_signin_error": "Google Sign-In Error ({{errorCode}}): {{errorMessage}}",
      "alert_logout_success": "You have been successfully logged out.",
      "alert_logout_error": "Error during logout: {{message}}",
      "alert_comment_failed": "Error saving your comment.",
      "alert_login_for_rating": "Please log in to submit a rating.",
      "alert_rating_success": "Thank you for your rating!",
      "alert_rating_failed": "Your rating could not be saved.",
      "footer_imprint": "Imprint",
      "footer_privacy": "Privacy Policy",
      "footer_cookies": "Cookie Settings",
      "footer_visitors": "Visitors:",
      "footer_copyright": "&copy; 2025 GameMatch. All rights reserved. Made with ‚ù§Ô∏è in Austria",
      "cookie_banner_text": "We use cookies to ensure website functionality and improve your experience.",
      "cookie_learn_more": "Learn more",
      "cookie_accept_necessary": "Necessary cookies only",
      "cookie_accept_all": "Accept all cookies",
      "cookie_settings_title": "Cookie Settings",
      "cookie_necessary_title": "Necessary Cookies",
      "cookie_necessary_active": "Always active",
      "cookie_necessary_desc": "These cookies are essential for the website's operation and cannot be disabled.",
      "cookie_functional_title": "Functional Cookies",
      "cookie_functional_desc": "Enable enhanced functionality like saved login credentials and settings.",
      "cookie_analytics_title": "Analytics Cookies",
      "cookie_analytics_desc": "Help us understand how visitors use our website.",
      "cookie_save_settings": "Save settings",
      "cookie_cancel": "Cancel",
      "admin_dashboard_title": "Admin Dashboard",
      "admin_tab_users": "User Management",
      "admin_tab_blog": "Blog Management",
      "admin_users_filter_placeholder": "Filter by username or email...",
      "admin_users_th_user": "Username",
      "admin_users_th_email": "E-Mail",
      "admin_users_th_level": "Level / XP",
      "admin_users_th_registered": "Registered on",
      "admin_users_th_actions": "Actions",
      "admin_users_no_users": "No users found.",
      "admin_blog_create_title": "Create New Post",
      "admin_blog_form_title": "Title",
      "admin_blog_form_content": "Content",
      "admin_blog_form_save": "Save Post",
      "admin_blog_form_clear": "Clear",
      "admin_blog_existing_title": "Existing Posts",
      "admin_blog_edit": "Edit",
      "admin_blog_delete": "Delete",
      "chat_back": "&larr; Back",
      "chat_loading": "Loading...",
      "chat_placeholder": "Write a message...",
      "chat_send": "Send",
      "profile_request_received": "sent you a friend request.",
      "profile_request_accept": "Accept",
      "profile_request_decline": "Decline",
      "giveaway_banner_title": "Summer Giveaway!",
    "giveaway_banner_text": "Win a 50‚Ç¨ Steam Gift Card! The user with the most XP on August 31st wins. Good luck!",
    "feature_section_title": "Your Personal Gaming Universe",
    "feature_section_subtitle": "More Than Just Recommendations",
    "feature_section_desc": "A GameMatch account is your central hub for everything related to your games. Collect, share, and track your progress.",
    "feature_new_library_title": "Your Library",
    "feature_new_library_desc": "Every game you like is saved here. Create your ultimate collection, rate it, and show it to your friends.",
    "feature_new_crew_title": "Your Crew",
    "feature_new_crew_desc": "Find players who share your taste. Compare your libraries and discover which games you can play together.",
    "feature_new_progress_title": "Your Progress",
    "feature_new_progress_desc": "Earn experience points (XP) for your activities on the site, level up, and unlock new ranks.",
    }
  }
};
// DIREKT NACH DEM `translations`-OBJEKT EINF√úGEN

// Diese Funktion aktualisiert alle Texte auf der Seite
// ERSETZE DEINE BISHERIGE updateContent FUNKTION HIERMIT

function updateContent() {
  document.querySelectorAll('[data-i18n]').forEach(element => {
    let key = element.getAttribute('data-i18n');
    let attribute = 'innerHTML'; // Standard ist, den Text im Element zu √§ndern

    // Pr√ºfen, ob eine Attribut-√úbersetzung wie [placeholder]key gemeint ist
    if (key.startsWith('[')) {
      const match = key.match(/\[(.*?)\](.*)/);
      if (match) {
        attribute = match[1]; // z.B. "placeholder"
        key = match[2];       // z.B. "auth_placeholder_email"
      }
    }

    const translation = i18next.t(key);

    // Je nachdem, ob es ein Attribut oder der Inhalt ist, wird die passende Methode verwendet
    if (attribute === 'innerHTML') {
      element.innerHTML = translation;
    } else {
      element.setAttribute(attribute, translation);
    }
  });
}

// Initialisiert i18next und f√ºhrt die erste √úbersetzung aus
i18next.init({
  lng: 'de', // Startsprache
  fallbackLng: 'de', // Falls eine Sprache nicht gefunden wird
  debug: false, // Auf false setzen, wenn alles funktioniert
  resources: translations
}).then(function(t) {
  // Sobald i18next bereit ist, die Inhalte aktualisieren
  updateContent();
});

// Wenn die Sprache ge√§ndert wird, rufe die Aktualisierungsfunktion auf
i18next.on('languageChanged', () => {
  updateContent();
});

        let chatHistory = [];
        let lastUserInput = '';
        let availableTags = [];
        let availableGenres = [];
        let currentGameCandidates = []

        let currentOpenChatId = null; 
        let unsubscribeFromMessages = null;
        let lastVisibleGameDoc = null; 
        const GAMES_PER_PAGE = 9;

        // UI ELEMENTE SAMMLUNG
        const ui = {
            navTriggers: document.querySelectorAll('.nav-trigger'),
            pageSections: document.querySelectorAll('.page-section'),
            chatLog: document.getElementById('chat-log'),
            userInputArea: document.getElementById('user-input-area'),
            resultContainer: document.getElementById('matchmaker-result'),
            chatWindow: document.getElementById('ai-chat-window'),
            resetQuizButton: document.getElementById('reset-quiz'),
            authModal: document.getElementById('auth-modal'),
            authModalContent: document.getElementById('auth-modal-content'),
            loginView: document.getElementById('login-view'),
            registerView: document.getElementById('register-view'),
        };
        
    
const systemPromptConversation = `DU BIST EIN GAME-SCOUT. Dein Ziel ist es, in einem lockeren Gespr√§ch die W√ºnsche des Nutzers f√ºr ein PC-Spiel zu verstehen. STELLE IMMER NUR EINE EINZIGE FRAGE PRO ANTWORT. Frage nach Genre, Stimmung, Spielstil (realistisch, Fantasy etc.) und ob der Nutzer AAA-Titel oder Indie-Spiele bevorzugt. STELLE FRAGEN, BIS DU DIR SICHER BIST, GENUG INFOS ZU HABEN (NORMALERWEISE NACH 2-3 ANTWORTEN DES NUTZERS). DEINE ALLERLETZTE ANTWORT MUSS EINE ABSCHLIESSENDE BEMERKUNG SEIN UND DARF KEINE FRAGE MEHR ENTHALTEN. ZUM BEISPIEL: "Perfekt, das reicht mir schon. Ich suche jetzt das passende Spiel f√ºr dich!". Setze NUR in diesem finalen Fall 'conversation_complete' auf true. ANTWORTE IMMER IM FOLGENDEN JSON-FORMAT: { "type": "response", "next_question": "Deine n√§chste Frage ODER die abschlie√üende Bemerkung.", "conversation_complete": false }`;

const systemPromptExtractor = `
    You are a data extraction engine for the IGDB API.
    **RULES:**
    1.  From the user's request, identify the **ONE SINGLE MOST IMPORTANT genre** that describes the core gameplay (e.g., 'rpg', 'shooter', 'adventure').
    2.  Identify a **category**: 'indie' or 'aaa'. If not mentioned, this must be null.
    3.  Identify a **maximum of 2-3 essential themes** that are explicitly mentioned or strongly implied (e.g., 'fantasy', 'horror', 'open-world'). Do NOT add generic themes like 'singleplayer' or 'atmospheric' unless they are the primary request. Be conservative.
    4.  Output ONLY a valid JSON object in the format: { "genre": "THE_SINGLE_GENRE_SLUG", "themes": ["theme1"], "category": "indie" }
`;
const systemPromptFinal = `
    You are a highly precise recommendation engine. Your ONLY task is to select one single game from the JSON list of candidates provided in the user's prompt. You MUST follow these rules exactly:

    **CRITICAL RULES:**

    1.  **MANDATORY SELECTION FROM LIST:** You are absolutely forbidden to suggest any game that is NOT in the provided candidate list. You MUST choose one from the list.

    2.  **STRICT TAG ANALYSIS:** Review the user's original request (provided in the prompt). Then, for each game in the candidate list, examine its "tags" array. Select the game whose tags provide the **best and most accurate match** to the user's request.

    3.  **VERIFY THE CORE GENRE:** If the user asked for a "Shooter", you MUST verify that the selected game's tags include "shooter". If the user asked for an "RPG", verify that the tags include "rpg". Do not misclassify genres. For example, "God of War" is NOT a "Shooter".

    4.  **GERMAN JUSTIFICATION:** Your "description" in the JSON output must be in GERMAN and directly address the user ('Du'/'dir').

    5.  **JSON ONLY:** Your entire response must be a single, valid JSON object and nothing more.

    Here is the required JSON structure: { "game": { "id": THE_UNIQUE_ID_FROM_THE_LIST, "description": "YOUR_PERSONAL_REASONING_IN_GERMAN." } }
`;
const systemPromptDescription = `
    You are a creative game journalist. Your task is to write a short, enthusiastic, 2-3 sentence recommendation for a given game, based on provided facts.
    
    **RULES:**
    1.  Address the user directly in German ('Du'/'dir').
    2.  Your tone should be convincing and exciting.
    3.  **Your entire response MUST be ONLY the text of the recommendation. Do NOT output JSON, markdown, or any other formatting. Just the plain text.**
`;


        // FIREBASE INITIALISIERUNG
        const firebaseConfig = {
            apiKey: "AIzaSyDdIe7bx3ub3Sna3p9UYvvwrCaBcPOeMHM",
            authDomain: "gamematch-f462c.firebaseapp.com",
            projectId: "gamematch-f462c",
            storageBucket: "gamematch-f462c.appspot.com",
            messagingSenderId: "598499532222",
            appId: "1:598499532222:web:0027a5cd04a0652ed36def",
            measurementId: "G-NQYQ6V1RLW"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();
        

// +++ NEUE AUTH MODAL FUNKTIONEN +++
function openAuthModal(view = 'login') {
    const loginError = document.getElementById('login-error');
    const registerError = document.getElementById('register-error');
    loginError.classList.add('hidden');
    loginError.textContent = '';
    registerError.classList.add('hidden');
    registerError.textContent = '';

    if (view === 'login') {
        ui.loginView.classList.remove('hidden');
        ui.registerView.classList.add('hidden');
    } else {
        ui.loginView.classList.add('hidden');
        ui.registerView.classList.remove('hidden');
    }
    ui.authModal.classList.remove('invisible', 'opacity-0');
    ui.authModalContent.classList.remove('scale-95');
}
async function incrementVisitCounter() {
  const dbRef = firebase.firestore().collection('siteStats').doc('visitCounter');
  const counterEl = document.getElementById('visit-counter');

  try {
    const doc = await dbRef.get();
    if (!doc.exists) {
      // Erstes Anlegen mit Startwert 1
      await dbRef.set({ count: 350 });
      counterEl.textContent = '1';
    } else {
      // Z√§hler erh√∂hen
      await dbRef.update({
        count: firebase.firestore.FieldValue.increment(1)
      });
      const updatedSnap = await dbRef.get();
      const newCount = updatedSnap.data().count || 0;
      counterEl.textContent = newCount.toLocaleString('de-DE');
    }
  } catch (err) {
    console.error("Fehler beim Z√§hler:", err);
    counterEl.textContent = 'Fehler';
  }
}
function closeAuthModal() {
    ui.authModal.classList.add('opacity-0');
    ui.authModalContent.classList.add('scale-95');
    setTimeout(() => {
        ui.authModal.classList.add('invisible');
    }, 300); // Wait for transition to finish
}
let unsubscribeFromUserDoc = null; 
// +++ NEUE, VERBESSERTE AUTH-FUNKTIONEN +++
async function handleEmailRegister(event) {
    event.preventDefault();
    const email = document.getElementById('register-email').value;
    const password = document.getElementById('register-password').value;
    const username = document.getElementById('register-username').value;
    const referralCodeInput = document.getElementById('register-referral-code').value.trim().toUpperCase(); // NEU
    const errorP = document.getElementById('register-error');

    if (!email || !password || !username) {
        errorP.textContent = "Bitte f√ºlle alle Felder aus.";
        errorP.classList.remove('hidden');
        return;
    }

    try {
        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
        const user = userCredential.user;
        
        // NEU: Logik zur Verarbeitung des Empfehlungscodes
        let referredBy = null;
        if (referralCodeInput) {
            const querySnapshot = await db.collection("users").where("referralCode", "==", referralCodeInput).limit(1).get();
            if (!querySnapshot.empty) {
                const referrerDoc = querySnapshot.docs[0];
                referredBy = referrerDoc.id;
                // Erh√∂he den Z√§hler des Werbenden
                await db.collection("users").doc(referredBy).update({
                    referralCount: firebase.firestore.FieldValue.increment(1)
                });
            } else {
                console.warn("Eingegebener Empfehlungscode existiert nicht:", referralCodeInput);
            }
        }

        await db.collection("users").doc(user.uid).set({
            email: user.email,
            username: username, 
            avatarUrl: null, 
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            xp: 0,
            level: 1,
            referralCode: generateReferralCode(), // NEU: Code bei Erstellung zuweisen
            referralCount: 0, // NEU: Initialen Z√§hler setzen
            referredBy: referredBy // NEU: Speichern, wer geworben hat
        });

        alert(i18next.t('alert_register_success'));
        closeAuthModal();
    } catch (error) {
        errorP.textContent = "Error: " + error.message;
        errorP.classList.remove('hidden');
    }
}

async function sendMessage(friendId, messageText) {
    const currentUser = auth.currentUser;
    if (!currentUser || !messageText.trim()) return;

    const chatId = [currentUser.uid, friendId].sort().join('_');
    const conversationRef = db.collection('conversations').doc(chatId);
    const messagesRef = conversationRef.collection('messages');
    
    // NEU: Referenz auf das Nutzerdokument des Empf√§ngers
    const recipientUserRef = db.collection('users').doc(friendId);

    try {
        // F√ºge die Nachricht hinzu
        await messagesRef.add({
            senderId: currentUser.uid,
            text: messageText,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });

        
        await conversationRef.set({
    users: [currentUser.uid, friendId],

    ['unread_' + friendId]: firebase.firestore.FieldValue.increment(1)
}, { merge: true });

        
        await recipientUserRef.update({
            totalUnreadMessages: firebase.firestore.FieldValue.increment(1)
        });
        
    } catch (error) {
        console.error("Fehler beim Senden der Nachricht oder Aktualisieren der Z√§hler:", error);
    }
}
function changeLang(lang) {
  i18next.changeLanguage(lang);
}

function listenForMessages(friendId, callback) {
    const currentUser = auth.currentUser;
    if (!currentUser) return;

    const chatId = [currentUser.uid, friendId].sort().join('_');

    const query = db.collection('conversations').doc(chatId)
      .collection('messages')
      .orderBy('timestamp', 'asc');
      
    // Gib die von onSnapshot zur√ºckgegebene Funktion direkt zur√ºck
    return query.onSnapshot(querySnapshot => {
        const messages = [];
        querySnapshot.forEach(doc => {
            messages.push({ id: doc.id, ...doc.data() });
        });
        callback(messages);
    });
}
// ERSETZE DEINE BISHERIGE openChat FUNKTION

async function openChat(friendId, friendUsername, friendAvatar) {
    const currentUser = auth.currentUser;
    if (!currentUser) return;

    if (unsubscribeFromMessages) {
        unsubscribeFromMessages();
    }

    currentOpenChatId = friendId;
    document.getElementById('chat-friend-name').textContent = friendUsername;
    // KORREKTUR: F√ºgt ein Standard-Avatarbild hinzu, falls keines vorhanden ist
    document.getElementById('chat-friend-avatar').src = friendAvatar || `https://i.pravatar.cc/40?u=${friendId}`;
    document.getElementById('chat-log-messages').innerHTML = `<p class="text-center text-gray-400">${i18next.t('chat_loading')}</p>`;

    // --- Logik zum Zur√ºcksetzen der Z√§hler bleibt gleich ---
    const chatId = [currentUser.uid, friendId].sort().join('_');
    const conversationRef = db.collection('conversations').doc(chatId);
    const currentUserRef = db.collection('users').doc(currentUser.uid);

    try {
        const conversationDoc = await conversationRef.get();
        if (conversationDoc.exists) {
            const unreadCount = conversationDoc.data()['unread_' + currentUser.uid] || 0;
            if (unreadCount > 0) {
                await db.runTransaction(async (transaction) => {
                    transaction.update(currentUserRef, {
                        totalUnreadMessages: firebase.firestore.FieldValue.increment(-unreadCount)
                    });
                    transaction.update(conversationRef, {
                        ['unread_' + currentUser.uid]: 0
                    });
                });
            }
        }
    } catch (error) {
        console.error("Fehler beim Zur√ºcksetzen der Z√§hler:", error);
    }
    
    showPage('#chat-view');
    unsubscribeFromMessages = listenForMessages(friendId, renderMessages);
}
// NEUE FUNKTION, UM DIE NACHRICHTEN IM UI DARZUSTELLEN
function renderMessages(messages) {
    const chatLog = document.getElementById('chat-log-messages');
    const currentUser = auth.currentUser;
    
    if (!currentUser) return;
    
    chatLog.innerHTML = ''; // Leere alte Nachrichten

    if (messages.length === 0) {
        chatLog.innerHTML = '<p class="text-center text-gray-500 text-sm">Noch keine Nachrichten. Sag Hallo!</p>';
        return;
    }

    messages.forEach(message => {
        const isMe = message.senderId === currentUser.uid;
        
        const bubble = document.createElement('div');
        bubble.className = `flex items-end gap-2 max-w-[80%] ${isMe ? 'self-end flex-row-reverse' : 'self-start'}`;
        
        // Die eigentliche Nachrichtenblase
        const textBubble = document.createElement('div');
        textBubble.textContent = message.text;
        textBubble.className = `px-4 py-2 rounded-xl ${isMe ? 'bg-blue-600 rounded-br-none' : 'bg-gray-700 rounded-bl-none'}`;
        
        bubble.appendChild(textBubble);
        chatLog.appendChild(bubble);
    });

    // Scrolle immer zur neuesten Nachricht
    chatLog.scrollTop = chatLog.scrollHeight;
}
async function displayGamePoolList(userId) {
    const listContainer = document.getElementById('mitspieler-gamelist');
    if (!listContainer) return;
    listContainer.innerHTML = `<p class="text-gray-400">${i18next.t('profile_lfg_loading_games')}</p>`;

    try {
        const querySnapshot = await db.collection("users").doc(userId).collection("suggestedGames")
                                    .where('status', '==', 'liked')
                                    .orderBy('suggestedAt', 'desc')
                                    .get();

        if (querySnapshot.empty) {
            listContainer.innerHTML = `<p class="text-gray-500">${i18next.t('profile_lfg_no_liked_games')}</p>`;
            return;
        }

        let gamesHtml = '';
        querySnapshot.forEach(doc => {
            const game = doc.data();
            // KORREKTUR: Titel wird desinfiziert
            const safeTitle = sanitizeHTML(game.title);
            gamesHtml += `
                <div onclick="showPlayersForGame('${game.rawgId}', '${game.title.replace(/'/g, "\\'")}')" 
                     class="bg-gray-900 p-3 rounded-lg flex items-center gap-4 cursor-pointer hover:bg-gray-800 transition-colors">
                    <img src="${game.imageUrl}" class="w-16 h-10 object-cover rounded">
                    <span class="font-semibold text-white">${safeTitle}</span>
                </div>
            `;
        });
        listContainer.innerHTML = gamesHtml;
    } catch (error) {
        console.error("Fehler beim Laden der Game-Pool-Liste:", error);
        listContainer.innerHTML = `<p class="text-red-400">${i18next.t('profile_lfg_error_loading')}</p>`;
    }
}
async function showPlayersForGame(gameId, gameTitle) {
    document.getElementById('mitspieler-gamelist-view').classList.add('hidden');
    const resultsView = document.getElementById('mitspieler-results-view');
    const resultsList = document.getElementById('mitspieler-results-list');

    document.getElementById('mitspieler-results-title').textContent = i18next.t('profile_lfg_results_title', { gameTitle: gameTitle });
    resultsList.innerHTML = `<p class="text-gray-400">${i18next.t('profile_lfg_searching')}</p>`;
    resultsView.classList.remove('hidden');

    try {
        const gameLikesDoc = await db.collection("gameLikes").doc(String(gameId)).get();
        if (!gameLikesDoc.exists || !gameLikesDoc.data().users) {
            resultsList.innerHTML = `<p class="text-gray-500">${i18next.t('profile_lfg_no_one_else')}</p>`;
            return;
        }

        const usersMap = gameLikesDoc.data().users;
        const currentUser = auth.currentUser;
        let playersHtml = '';
        let playerCount = 0;

        for (const userId in usersMap) {
            if (currentUser && currentUser.uid === userId) continue;
            const userData = usersMap[userId];
            playerCount++;
            // KORREKTUR: Nutzername wird desinfiziert
            const safeUsername = sanitizeHTML(userData.username);
            playersHtml += `
                <a href="#profile?user=${userId}" class="nav-trigger bg-gray-900 p-3 rounded-lg flex items-center gap-4 hover:bg-gray-800 transition-colors">
                    <img src="${userData.avatarUrl || `https://i.pravatar.cc/150?u=${userId}`}" class="w-12 h-12 object-cover rounded-full">
                    <span class="font-semibold text-white">${safeUsername}</span>
                </a>
            `;
        }

        if (playerCount === 0) {
             resultsList.innerHTML = `<p class="text-gray-500">${i18next.t('profile_lfg_trendsetter')}</p>`;
        } else {
            resultsList.innerHTML = playersHtml;
        }

    } catch (error) {
        console.error(`Fehler beim Abrufen der Spieler f√ºr Spiel ${gameId}:`, error);
        resultsList.innerHTML = `<p class="text-red-400">${i18next.t('profile_lfg_error_player_list')}</p>`;
    }
}
function displayPartners() {
    const container = document.getElementById('partner-list');
    if (!container) return;

    let html = '';
    partners.forEach(partner => {
        html += `
            <a href="${partner.websiteUrl}" target="_blank" rel="noopener noreferrer" 
               class="block bg-gray-800 border border-gray-700 rounded-xl p-6 text-center transition-all duration-300 hover:border-cyan-500 hover:-translate-y-1">
                <img src="${partner.logoUrl}" alt="Logo von ${sanitizeHTML(partner.name)}" 
                     class="h-20 mx-auto mb-4 object-contain filter grayscale hover:grayscale-0 transition-all">
                <h3 class="text-xl font-bold text-white mb-2">${sanitizeHTML(partner.name)}</h3>
                <p class="text-gray-400 text-sm">${sanitizeHTML(partner.description)}</p>
            </a>
        `;
    });
    container.innerHTML = html;
}
async function displayUserManagement() {
    const userListBody = document.getElementById('admin-user-list-body');
    const emptyMessage = document.getElementById('admin-user-list-empty');
    if (!userListBody) return;

    userListBody.innerHTML = '<tr><td colspan="5" class="text-center p-6 text-gray-400">Lade Nutzerdaten...</td></tr>';
    emptyMessage.classList.add('hidden');

    try {
        const querySnapshot = await db.collection("users").orderBy("createdAt", "desc").get();

        if (querySnapshot.empty) {
            userListBody.innerHTML = '';
            emptyMessage.classList.remove('hidden');
            return;
        }

        let usersHtml = '';
        querySnapshot.forEach(doc => {
            const userData = doc.data();
            const userId = doc.id;
            const currentUser = auth.currentUser;
            const registeredAt = userData.createdAt?.toDate().toLocaleDateString('de-DE') || 'Unbekannt';
            let actionButtons = `<a href="#profile?user=${userId}" class="nav-trigger font-medium text-cyan-400 hover:underline">Profil</a>`;
            if (currentUser && currentUser.uid !== userId) {
                actionButtons += userData.isBanned ? `<button onclick="toggleUserBan('${userId}', true)" class="ml-4 font-medium text-green-400 hover:underline">Entsperren</button>` : `<button onclick="toggleUserBan('${userId}', false)" class="ml-4 font-medium text-red-500 hover:underline">Sperren</button>`;
                actionButtons += userData.isAdmin ? `<button onclick="toggleAdminStatus('${userId}', true)" class="ml-4 font-medium text-red-500 hover:underline">Admin entfernen</button>` : `<button onclick="toggleAdminStatus('${userId}', false)" class="ml-4 font-medium text-yellow-400 hover:underline">Zum Admin machen</button>`;
            }

            // KORREKTUR: Nutzername und E-Mail werden desinfiziert
            const safeUsername = sanitizeHTML(userData.username || '');
            const safeEmail = sanitizeHTML(userData.email);
            
            usersHtml += `
                <tr class="bg-gray-800 border-b border-gray-700 hover:bg-gray-700/50 ${userData.isBanned ? 'opacity-50' : ''}">
                    <td class="px-6 py-4 font-medium text-white">${safeUsername} ${userData.isAdmin ? '<span class="text-xs text-yellow-400 ml-1">(Admin)</span>' : ''}</td>
                    <td class="px-6 py-4">${safeEmail}</td>
                    <td class="px-6 py-4">Lvl ${userData.level || 1} / ${userData.xp || 0} XP</td>
                    <td class="px-6 py-4">${registeredAt}</td>
                    <td class="px-6 py-4">${actionButtons}</td>
                </tr>
            `;
        });
        userListBody.innerHTML = usersHtml;
    } catch (error) {
        console.error("Fehler beim Laden der Nutzer f√ºr das Admin-Panel:", error);
        userListBody.innerHTML = '<tr><td colspan="5" class="text-center p-6 text-red-400">Fehler beim Laden der Nutzer.</td></tr>';
    }
}
async function handleEmailLogin(event) {
    event.preventDefault();
    const email = document.getElementById('login-email').value;
    const password = document.getElementById('login-password').value;
    const errorP = document.getElementById('login-error');

    try {
        const userCredential = await auth.signInWithEmailAndPassword(email, password);
        const user = userCredential.user;

        const userDoc = await db.collection('users').doc(user.uid).get();
        if (userDoc.exists && userDoc.data().isBanned === true) {
            await auth.signOut();
            alert(i18next.t('alert_account_banned'));
            closeAuthModal();
            return;
        }

        alert(i18next.t('alert_login_success'));
        closeAuthModal();
    
    } catch (error) {
        errorP.textContent = "Error: " + error.message;
        errorP.classList.remove('hidden');
    }
}

async function signInWithGoogle() {
    const provider = new firebase.auth.GoogleAuthProvider();
    try {
        const result = await auth.signInWithPopup(provider);
        const user = result.user;
        const isNewUser = result.additionalUserInfo.isNewUser;

        if (isNewUser) {
            await db.collection("users").doc(user.uid).set({
                email: user.email,
                username: user.displayName || 'Google User',
                avatarUrl: user.photoURL,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                xp: 0,
                level: 1,
                isBanned: false,
                referralCode: generateReferralCode(), // 
                referralCount: 0, // 
                referredBy: null // 
            });
            
            alert(i18next.t('alert_google_register_success'));

        } else {
            const userDoc = await db.collection('users').doc(user.uid).get();
            // Wenn der Nutzer wiederkehrt, aber aus irgendeinem Grund kein DB-Eintrag existiert, erstelle ihn.
            if (!userDoc.exists) {
                await db.collection("users").doc(user.uid).set({
                    email: user.email,
                    username: user.displayName || 'Google User',
                    avatarUrl: user.photoURL,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    xp: 0,
                    level: 1,
                    isBanned: false
                });
            } else if (userDoc.data().isBanned === true) {
                // Wenn der Nutzer existiert und gesperrt ist, logge ihn aus.
                await auth.signOut();
                alert(i18next.t('alert_account_banned'));
                closeAuthModal();
                return;
            }
            
            alert(i18next.t('alert_google_welcome_back', { name: user.displayName }));
        }
        
        closeAuthModal();

    } catch (error) {
        alert(i18next.t('alert_google_signin_error', { errorCode: error.code, errorMessage: error.message }));
    }
}
 async function handleLogout() {
    try {
        await auth.signOut();
        // Ein Alert ist hier nicht n√∂tig, da die Seite sofort neu l√§dt,
        // was f√ºr den Nutzer Best√§tigung genug ist.
        window.location.hash = '#home';
        location.reload(); 
    } catch (error) {
        console.error("Fehler beim Logout:", error);
        alert(i18next.t('alert_logout_error', { message: error.message }));
    }
}       
    
async function postGameComment(event, gameId) {
  event.preventDefault();
  const input = document.getElementById(`comment-input-${gameId}`);
  const commentText = input.value.trim();
  const user = auth.currentUser;

  if (!commentText || !user) return;

  try {
    const userDoc = await db.collection("users").doc(user.uid).get();
    const username = userDoc.exists ? (userDoc.data().username || user.email) : "Unbekannt";

    await db.collection("comments").doc(gameId.toString()).collection("entries").add({
      username,
      comment: commentText,
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });
const gameDoc = await db.collection("game_ratings").doc(String(gameId)).get();
        db.collection('activity_feed').add({
            type: 'COMMENT',
            userId: user.uid,
            username: username,
            details: {
                gameId: gameId,
                gameTitle: gameDoc.data()?.gameTitle || 'einem Spiel',
                commentText: commentText
            },
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
    
input.value = '';
await grantXpAndCheckLevelUp(user.uid, 10);
loadCommentsForGame(gameId, 'modal-comment-list');


  } catch (error) {
    console.error("Kommentar konnte nicht gespeichert werden:", error);
    alert("Fehler beim Speichern deines Kommentars.");
  }
}
// ERSETZE DEINE KOMPLETTE loadSavedGames FUNKTION HIERMIT

async function loadSavedGames(userId, filter, isInitialLoad = false) {
    const savedGamesList = document.getElementById('saved-games-list');
    const noGamesMessage = document.getElementById('no-saved-games');
    const loadMoreContainer = document.getElementById('load-more-container');
    const isOwnProfile = auth.currentUser && auth.currentUser.uid === userId;

    if (isInitialLoad) {
        savedGamesList.innerHTML = '';
        noGamesMessage.classList.add('hidden');
        lastVisibleGameDoc = null;
    }

    loadMoreContainer.innerHTML = `<p class="text-gray-400">${i18next.t('profile_loading')}</p>`;

    try {
        let gamesQuery = db.collection("users").doc(userId).collection("suggestedGames");

        if (filter === 'liked') {
            gamesQuery = gamesQuery.where('status', '==', 'liked');
        } else if (filter === 'disliked') {
            gamesQuery = gamesQuery.where('status', '==', 'disliked');
        }
        
        gamesQuery = gamesQuery.orderBy("suggestedAt", "desc");

        if (lastVisibleGameDoc) {
            gamesQuery = gamesQuery.startAfter(lastVisibleGameDoc);
        }
        gamesQuery = gamesQuery.limit(GAMES_PER_PAGE);

        const gamesSnapshot = await gamesQuery.get();

        if (gamesSnapshot.empty && isInitialLoad) {
            noGamesMessage.textContent = i18next.t('profile_no_games_for_filter', { filter: filter });
            noGamesMessage.classList.remove('hidden');
            loadMoreContainer.innerHTML = '';
            return;
        }

        if (gamesSnapshot.docs.length > 0) {
            lastVisibleGameDoc = gamesSnapshot.docs[gamesSnapshot.docs.length - 1];
        }

        let gamesHtml = '';
        gamesSnapshot.forEach(doc => {
            const game = doc.data();
            gamesHtml += `
                <div class="game-card-trigger bg-gray-900 rounded-lg overflow-hidden border border-gray-700 flex flex-col cursor-pointer hover:border-cyan-500 transition-all duration-300 hover:-translate-y-1"
                     data-game-id="${game.rawgId}"
                     data-game-title="${escapeJS(game.title)}"
                     data-game-image-url="${game.imageUrl}"
                     data-game-description="${escapeJS(game.description)}"
                     data-is-own-profile="${isOwnProfile}">
                    <img src="${game.imageUrl}" alt="Cover f√ºr ${game.title}" class="w-full h-40 object-cover pointer-events-none">
                    <div class="p-4 flex flex-col flex-grow pointer-events-none">
                        <h4 class="font-bold text-xl text-white">${game.title}</h4>
                        <p class="text-gray-300 text-sm mt-2 line-clamp-3">${game.description}</p>
                        <div class="mt-auto pt-4">
                            <div id="avg-rating-${game.rawgId}" class="flex items-center text-sm text-gray-400"></div>
                        </div>
                    </div>
                </div>
            `;
        });
        
        savedGamesList.insertAdjacentHTML('beforeend', gamesHtml);

        const uiPromises = gamesSnapshot.docs.map(doc => {
            const avgRatingContainer = document.getElementById(`avg-rating-${doc.data().rawgId}`);
            if (avgRatingContainer) {
                return db.collection("game_ratings").doc(String(doc.data().rawgId)).get().then(gameRatingDoc => {
                    if (gameRatingDoc.exists) {
                        displayStars(avgRatingContainer, gameRatingDoc.data().averageRating, gameRatingDoc.data().ratingCount);
                    } else {
                         avgRatingContainer.innerHTML = `<span class="text-xs text-gray-500">Noch keine Bewertungen</span>`;
                    }
                });
            }
        });
        await Promise.all(uiPromises);

        if (gamesSnapshot.docs.length < GAMES_PER_PAGE) {
            loadMoreContainer.innerHTML = '';
        } else {
            loadMoreContainer.innerHTML = `<button id="load-more-btn" class="bg-gray-700 hover:bg-gray-600 text-white font-semibold px-6 py-2 rounded-lg">${i18next.t('profile_load_more')}</button>`;
            document.getElementById('load-more-btn').onclick = () => loadSavedGames(userId, filter, false);
        }

    } catch (error) {
        console.error("Fehler beim Laden der Spiele:", error);
        loadMoreContainer.innerHTML = `<p class="text-red-400">${i18next.t('profile_error_loading')} (${error.message})</p>`;
    }
}
async function loadCommentsForGame(gameId, containerId) {
    const container = document.getElementById(containerId);
    if (!container) return;

    try {
        const querySnapshot = await db.collection("comments").doc(gameId.toString()).collection("entries").orderBy("timestamp", "desc").limit(5).get();
        if (querySnapshot.empty) {
            container.innerHTML = `<p class="text-xs text-gray-500 italic px-2">Noch keine Kommentare.</p>`;
            return;
        }

        let html = '';
        querySnapshot.forEach(doc => {
            const entry = doc.data();
            const avatarUrl = `https://i.pravatar.cc/40?u=${encodeURIComponent(entry.username)}`;
            // KORREKTUR: Name und Kommentar werden desinfiziert
            const safeUsername = sanitizeHTML(entry.username);
            const safeComment = sanitizeHTML(entry.comment);
            html += `
                <div class="flex items-start gap-2.5 p-2 rounded-lg hover:bg-gray-800/50">
                    <img class="w-8 h-8 rounded-full" src="${avatarUrl}" alt="${safeUsername} avatar">
                    <div class="flex flex-col w-full">
                        <p class="text-sm font-semibold text-white">${safeUsername}</p>
                        <p class="text-sm text-gray-300 break-words">${safeComment}</p>
                    </div>
                </div>
            `;
        });
        container.innerHTML = html;
    } catch (error) {
        console.error("Fehler beim Laden der Kommentare:", error);
        container.innerHTML = `<p class="text-red-400">Fehler beim Laden der Kommentare.</p>`;
    }
}
async function loadUserList() {
    const container = document.getElementById('user-list');
    const emptyMsg = document.getElementById('user-list-empty');
    if (!container || !emptyMsg) return;

    container.innerHTML = '<p class="text-gray-400 text-center">Lade Community...</p>';
    const currentUser = auth.currentUser;

    try {
        // --- SCHRITT 1: Hole ALLE Nutzer in einer Anfrage ---
        const usersSnapshot = await db.collection("users").get();
        
        let friendships = new Map(); // Hier speichern wir die Freundschafts-Stati

        // --- SCHRITT 2: WENN eingeloggt, hole ALLE Freundschaften in einer zweiten Anfrage ---
        if (currentUser) {
            const friendshipsSnapshot = await db.collection("friendships")
                                              .where("users", "array-contains", currentUser.uid)
                                              .get();
            
            friendshipsSnapshot.forEach(doc => {
                const data = doc.data();
                const friendId = data.users.find(id => id !== currentUser.uid);
                if (friendId) {
                    friendships.set(friendId, data.status); // z.B. { "freundesId": "accepted" }
                }
            });
        }
        
        // --- SCHRITT 3: Baue die Nutzerkarten, ohne weitere DB-Anfragen im Loop ---
        const userDocs = currentUser
            ? usersSnapshot.docs.filter(doc => doc.id !== currentUser.uid)
            : usersSnapshot.docs;

        if (userDocs.length === 0) {
            emptyMsg.classList.remove('hidden');
            container.innerHTML = '';
            return;
        }

        let cardsHtml = userDocs.map(doc => {
            const user = doc.data();
            let buttonHtml = '';

            if (currentUser) {
                const friendshipStatus = friendships.get(doc.id); // Pr√ºfe die lokale Map
                if (friendshipStatus === 'accepted') {
                    buttonHtml = `<span class="text-green-400 font-semibold text-sm">‚úÖ Bereits Freund</span>`;
                } else if (friendshipStatus === 'pending') {
                    buttonHtml = `<span class="text-yellow-400 font-semibold text-sm">‚è≥ Angefragt</span>`;
                } else {
                    buttonHtml = `<button onclick="sendFriendRequest('${doc.id}')" class="bg-cyan-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-cyan-500 transition-colors text-sm">Freund hinzuf√ºgen</button>`;
                }
            }

            // KORREKTUR HIER: 'user.username' wird desinfiziert, bevor es im HTML verwendet wird.
            const safeUsername = sanitizeHTML(user.username || 'Nutzer');

            return `
                <a href="#profile?user=${doc.id}" class="nav-trigger block bg-gray-800 border border-gray-700 rounded-xl p-4 shadow-lg flex flex-col items-center text-center transition-transform transform hover:scale-105 hover:border-cyan-500">
                    <img src="${user.avatarUrl || 'https://i.pravatar.cc/150?u=' + doc.id}" class="w-20 h-20 rounded-full mb-4 border-2 border-cyan-400 object-cover" alt="${safeUsername}">
                    <h3 class="text-xl font-bold text-white mb-1">${safeUsername}</h3>
                    <p class="text-yellow-400 text-sm mb-4">Level ${user.level || 1} ‚Äì ${user.xp || 0} XP</p>
                    <div onclick="event.stopPropagation(); event.preventDefault();" class="h-8">${buttonHtml}</div>
                </a>
            `;
        }).join('');

        container.innerHTML = cardsHtml;
        emptyMsg.classList.add('hidden');

    } catch (error) {
        console.error("Fehler beim Laden der Nutzerliste:", error);
        container.innerHTML = `<p class="text-red-400 text-center">Die Community konnte nicht geladen werden. Fehler: ${error.message}</p>`;
    }
}
async function handleAvatarUpload(event) {
    const user = auth.currentUser;
    if (!user) return;
    const file = event.target.files[0];
    if (!file) return;

    const avatarRef = storage.ref(`avatars/${user.uid}/${file.name}`);
    try {
        alert("Lade Bild hoch...");
        const snapshot = await avatarRef.put(file);
        const downloadURL = await snapshot.ref.getDownloadURL();
        await db.collection("users").doc(user.uid).update({ avatarUrl: downloadURL });
        document.getElementById('profile-avatar').src = downloadURL;
        alert("Profilbild erfolgreich aktualisiert!");
    } catch (error) {
        console.error("Upload-Fehler:", error);
        alert("Upload fehlgeschlagen.");
    }
}
async function handleUsernameChange() {
    const user = auth.currentUser;
    if (!user) return;

    const newUsername = prompt(i18next.t('prompt_enter_new_username'));
    if (!newUsername || newUsername.trim() === "") {
        alert(i18next.t('alert_username_empty'));
        return;
    }

    try {
        await db.collection("users").doc(user.uid).update({ username: newUsername });
        document.getElementById('profile-user-username').textContent = newUsername;
        alert(i18next.t('alert_username_changed'));
    } catch (error) {
        console.error("Fehler beim √Ñndern des Benutzernamens:", error);
        alert(i18next.t('alert_username_change_failed'));
    }
}
function setupProfileListeners() {
    // Event-Listener f√ºr das Hochladen des Avatars
    const avatarUploadInput = document.getElementById('avatar-upload');
    if (avatarUploadInput) {
        avatarUploadInput.addEventListener('change', handleAvatarUpload);
    }
    // Event-Listener f√ºr das √Ñndern des Benutzernamens
    const editUsernameBtn = document.getElementById('edit-username-btn');
    if (editUsernameBtn) {
        editUsernameBtn.addEventListener('click', handleUsernameChange);
    }

    // ======================================================================
    // NEUE LOGIK F√úR DIE FILTER-BUTTONS ("Gemocht", "Abgelehnt", etc.)
    // ======================================================================
    const filterButtons = document.querySelectorAll('#game-filter-buttons .filter-btn');
    filterButtons.forEach(button => {
        button.addEventListener('click', () => {
            // Finde heraus, welches Profil gerade angezeigt wird
            const hash = window.location.hash.substring(1);
            const [pageId, params] = hash.split('?');
            const urlParams = new URLSearchParams(params);
            const userId = urlParams.get('user') || auth.currentUser?.uid;

            if (!userId) {
                console.error("Filter-Klick: Keine UserID gefunden.");
                return;
            }

            // Welcher Filter wurde geklickt? ('all', 'liked', 'disliked')
            const filter = button.dataset.filter;

            // Setze den "active"-Style f√ºr den geklickten Button
            filterButtons.forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');

            // Lade die Spieleliste mit dem neuen Filter neu
            // Der 'true'-Parameter sorgt daf√ºr, dass die alte Liste zuerst geleert wird.
            loadSavedGames(userId, filter, true);
        });
    });
    
    // Klick-Logik f√ºr die einzelnen Spielkarten
    document.getElementById('saved-games-list').addEventListener('click', (event) => {
        const card = event.target.closest('.game-card-trigger');
        if (card) {
            openCommentModal(
                card.dataset.gameId,
                card.dataset.gameTitle,
                card.dataset.gameImageUrl,
                card.dataset.gameDescription,
                card.dataset.isOwnProfile === 'true'
            );
        }
    });
}
async function displayDailyChallenge() {
    const challengeContainer = document.getElementById('daily-challenge-container');
    const challengeText = document.getElementById('daily-challenge-text');

    try {
        const doc = await db.collection("dailyChallenge").doc("current").get();
        if (doc.exists) {
            const challenge = doc.data();
            challengeText.textContent = challenge.text;
            challengeContainer.classList.remove('hidden');
        } else {
            challengeText.textContent = "Heute gibt es keine Challenge.";
        }
    } catch (error) {
        console.error("Fehler beim Laden der Daily Challenge:", error);
        challengeContainer.classList.add('hidden');
    }
}
async function displayDailyChallengeForHome() {
    const challengeTextEl = document.getElementById('home-daily-challenge-text');
    try {
        const doc = await db.collection("dailyChallenge").doc("current").get();
        if (doc.exists) {
            challengeTextEl.textContent = doc.data().text;
            // Optional: Button-Link anpassen, falls die Challenge zu einer bestimmten Seite f√ºhren soll
            document.getElementById('home-daily-challenge-cta').onclick = () => window.location.hash = '#profile';
        } else {
            challengeTextEl.textContent = "Heute gibt es eine kleine Pause. Komm morgen wieder!";
        }
    } catch (error) {
        console.error("Fehler beim Laden der Daily Challenge f√ºr die Startseite:", error);
        challengeTextEl.textContent = "Challenge konnte nicht geladen werden.";
    }
}
async function displayLeaderboard() {
    const leaderboardList = document.getElementById('leaderboard-list');
    leaderboardList.innerHTML = `<p class="text-gray-400">${i18next.t('leaderboard_loading')}</p>`;

    try {
        const querySnapshot = await db.collection("users").orderBy("xp", "desc").limit(10).get();
        if (querySnapshot.empty) {
            leaderboardList.innerHTML = `<p class="text-gray-500">${i18next.t('leaderboard_no_players')}</p>`;
            return;
        }

        let leaderboardHtml = '';
        let rank = 1; 

        querySnapshot.forEach((doc) => { 
            const user = doc.data();
            // KORREKTUR: Name oder E-Mail wird desinfiziert
            const displayName = sanitizeHTML(user.username || user.email);
            leaderboardHtml += `
                <div class="flex items-center justify-between bg-gray-900 p-4 rounded-lg border border-gray-700">
                    <div class="flex items-center gap-4">
                        <span class="font-bold text-lg text-yellow-400">${rank}.</span>
                        <span class="font-semibold text-white">${displayName}</span>
                    </div>
                    <span class="font-bold text-lg text-yellow-400">${user.xp} XP</span>
                </div>
            `;
            rank++;
        });
        leaderboardList.innerHTML = leaderboardHtml;
    } catch (error) {
        console.error("Fehler beim Laden der Rangliste:", error);
        leaderboardList.innerHTML = `<p class="text-red-400">${i18next.t('leaderboard_error')}</p>`;
    }
}
async function loadActivityFeed() {
    const feedList = document.getElementById('activity-feed-list');
    feedList.innerHTML = '<p class="text-gray-400 text-center">Lade Aktivit√§ten...</p>';

    try {
        const querySnapshot = await db.collection("activity_feed").orderBy("timestamp", "desc").limit(30).get();

        if (querySnapshot.empty) {
            feedList.innerHTML = '<p class="text-gray-500 text-center">Noch keine Aktivit√§ten in der Community.</p>';
            return;
        }

        let feedHtml = '';
        querySnapshot.forEach(doc => {
            const event = doc.data();
            let eventHtml = '';

            const userLink = event.userId ? `<a href="#profile?user=${event.userId}" class="font-bold text-cyan-400 hover:underline">${event.username}</a>` : '';

            switch (event.type) {
                case 'RATING':
                    eventHtml = `
                        <p>${userLink} hat ${event.details.rating} Sterne f√ºr <strong>${event.details.gameTitle}</strong> vergeben.</p>
                    `;
                    break;
                case 'FRIENDSHIP':
                    const user1Link = `<a href="#profile?user=${event.details.user1Id}" class="font-bold text-cyan-400 hover:underline">${event.details.user1Username}</a>`;
                    const user2Link = `<a href="#profile?user=${event.details.user2Id}" class="font-bold text-cyan-400 hover:underline">${event.details.user2Username}</a>`;
                    eventHtml = `
                        <p>${user1Link} und ${user2Link} sind jetzt Freunde.</p>
                    `;
                    break;
                
            }
           
            const timestamp = event.timestamp?.toDate().toLocaleString('de-DE', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' }) || '';

            feedHtml += `
                <div class="bg-gray-800 border border-gray-700 rounded-lg p-4 text-gray-300 text-sm">
                    ${eventHtml}
                    <p class="text-xs text-gray-500 text-right mt-1">${timestamp}</p>
                </div>
            `;
        });
        feedList.innerHTML = feedHtml;

    } catch (error) {
        console.error("Fehler beim Laden des Feeds:", error);
        feedList.innerHTML = '<p class="text-red-400 text-center">Der Aktivit√§ten-Feed konnte nicht geladen werden.</p>';
    }
}        
async function acceptFriendRequest(friendshipId) {
    try {
        // Z√§hler f√ºr den aktuellen Nutzer (Empf√§nger) um 1 verringern
        await db.collection('users').doc(auth.currentUser.uid).update({ pendingFriendRequests: firebase.firestore.FieldValue.increment(-1) });
        
        // Status der Freundschaft auf "accepted" setzen (NUR EINMAL)
        await db.collection("friendships").doc(friendshipId).update({ status: 'accepted' });
        
        // Feed-Eintrag erstellen
        const friendshipDoc = await db.collection("friendships").doc(friendshipId).get();
        const data = friendshipDoc.data();
        const user1Doc = await db.collection('users').doc(data.senderId).get();
        const user2Doc = await db.collection('users').doc(data.recipientId).get();
        db.collection('activity_feed').add({
            type: 'FRIENDSHIP',
            details: {
                user1Id: data.senderId,
                user1Username: user1Doc.data()?.username || 'jemand',
                user2Id: data.recipientId,
                user2Username: user2Doc.data()?.username || 'jemand anderem'
            },
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });

        alert(i18next.t('alert_friend_request_accepted'));
        displayUserProfile(auth.currentUser.uid); // Profil neu laden, um die Listen zu aktualisieren
    } catch (error) {
        console.error("Fehler beim Annehmen der Anfrage:", error);
    }
}


async function declineFriendRequest(friendshipId) {
    try {
        // Z√§hler f√ºr den aktuellen Nutzer (Empf√§nger) um 1 verringern
        await db.collection('users').doc(auth.currentUser.uid).update({ pendingFriendRequests: firebase.firestore.FieldValue.increment(-1) });
        
        // Freundschaftsanfrage l√∂schen (NUR EINMAL)
        await db.collection("friendships").doc(friendshipId).delete();
        
        // KORREKTUR: alert mit √úbersetzung
        alert(i18next.t('alert_friend_request_declined'));
        
        // KORREKTUR: displayUserProfile mit der ID des aktuellen Nutzers aufrufen
        displayUserProfile(auth.currentUser.uid); 
    } catch (error) {
        console.error("Fehler beim Ablehnen der Anfrage:", error);
    }
}
// ERSETZE DEINE KOMPLETTE sendFriendRequest FUNKTION HIERMIT

async function sendFriendRequest(recipientId) {
    const sender = auth.currentUser;
    if (!sender) {
        alert(i18next.t('alert_login_to_send_request'));
        return;
    }

    const senderId = sender.uid;
    if (senderId === recipientId) return;

    // KORREKTUR 1: Die ID wird jetzt wieder korrekt aus beiden UIDs erstellt
    const docId = [senderId, recipientId].sort().join('_');
    const friendshipRef = db.collection("friendships").doc(docId);

    try {
        const doc = await friendshipRef.get();
        if (doc.exists) {
            alert(i18next.t('alert_request_already_sent'));
            return;
        }

        // KORREKTUR 2: Wir benutzen .set() anstatt .add() und die korrekte Variable 'recipientId'
        await friendshipRef.set({
            users: [senderId, recipientId],
            senderId: senderId,
            recipientId: recipientId,
            status: 'pending',
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        await db.collection('users').doc(recipientId).update({ pendingFriendRequests: firebase.firestore.FieldValue.increment(1) });


        const addButton = document.querySelector(`button[onclick="sendFriendRequest('${recipientId}')"]`);
        if (addButton) {
            addButton.textContent = i18next.t('button_text_requested');
            addButton.disabled = true;
            addButton.classList.remove('bg-cyan-600', 'hover:bg-cyan-500');
            addButton.classList.add('bg-gray-500', 'cursor-not-allowed');
        }
        alert(i18next.t('alert_friend_request_sent'));

    } catch (error) {
        console.error("Fehler beim Senden der Freundschaftsanfrage:", error);
        alert(i18next.t('alert_friend_request_failed'));
    }
}
        

        // GAMEMATCH FUNKTIONEN
     async function loadTagsFromAPI() {
    try {
        const response = await fetch('/.netlify/functions/call-rawg', {
            method: 'POST',
            body: JSON.stringify({
                path: '/api/tags',
                params: { page_size: 40 }
            })
        });
        if (!response.ok) throw new Error(`RAWG API error: ${response.status}`);
        const data = await response.json();
        availableTags = data.results.map(tag => tag.slug);
    } catch (error) {
        console.error("Fehler beim Laden der Tags:", error);
        availableTags = ["singleplayer", "multiplayer", "co-op", "procedural-generation", "story-rich", "open-world", "atmospheric", "relaxing", "fast-paced", "horror", "difficult"];
    }
}

async function loadGenresFromAPI() {
    try {
        const response = await fetch('/.netlify/functions/call-rawg', {
            method: 'POST',
            body: JSON.stringify({
                path: '/api/genres',
                params: {} // 
            })
        });
        if (!response.ok) throw new Error(`RAWG API error: ${response.status}`);
        const data = await response.json();
        availableGenres = data.results.map(genre => genre.slug);
    } catch (error) {
        console.error("Fehler beim Laden der Genres:", error);
        availableGenres = ["action", "indie", "adventure", "rpg", "strategy", "shooter", "casual", "simulation", "puzzle", "arcade", "platformer", "racing", "sports", "fighting", "family", "board-games", "educational", "card"];
    }
}
        
function getGuestUsage() {
    const usageData = localStorage.getItem('guestUsage');
    console.log('Lese guestUsage aus localStorage:', usageData);
    if (!usageData) {
        return { count: 0, date: new Date().toDateString() };
    }

    const parsedData = JSON.parse(usageData);
    const today = new Date().toDateString();

    if (parsedData.date !== today) {
        // NEU: Der zur√ºckgesetzte Z√§hler wird sofort gespeichert
        const resetData = { count: 0, date: today };
        localStorage.setItem('guestUsage', JSON.stringify(resetData));
        return resetData;
    }

    return parsedData;
}
function incrementGuestUsage() {
    const usage = getGuestUsage();
    usage.count++;
    console.log('Z√§hler wird erh√∂ht auf:', usage.count);
    localStorage.setItem('guestUsage', JSON.stringify(usage));
}
        function showPage(pageId) {
            if (!pageId || pageId === '#') pageId = '#home';
            ui.pageSections.forEach(section => section.classList.remove('active', 'fade-in'));
            const targetSection = document.querySelector(pageId);
            if (targetSection) {
                targetSection.classList.add('active');
                if (pageId !== '#home') targetSection.classList.add('fade-in');
            }
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
 function setupProfileTabs() {
    const tabContainer = document.getElementById('profile-tabs');
    // Verhindern, dass der Listener mehrfach hinzugef√ºgt wird
    if (!tabContainer || tabContainer.dataset.listenerAttached) return;

    tabContainer.addEventListener('click', (e) => {
        const clickedButton = e.target.closest('.profile-tab-btn');
        if (!clickedButton) return;

        // Alle Buttons und Inhalte deaktivieren
        tabContainer.querySelectorAll('.profile-tab-btn').forEach(btn => btn.classList.remove('active'));
        document.querySelectorAll('.profile-tab-content').forEach(content => content.classList.remove('active'));
        
        // Geklickten Button und passenden Inhalt aktivieren
        clickedButton.classList.add('active');
        const targetContent = document.getElementById(clickedButton.dataset.target);
        if (targetContent) {
            targetContent.classList.add('active');
        }
    });

    tabContainer.dataset.listenerAttached = 'true';
}
function setupCommunityTabs() {
    // Die Nutzerliste wird jetzt immer sofort geladen, da die Regeln es erlauben.
    loadUserList(); 

    // KORREKTUR: Der richtige Klassenname f√ºr die Buttons wird hier verwendet.
    const tabButtons = document.querySelectorAll('.community-tab-btn');
    const tabContents = document.querySelectorAll('.community-tab-content');

    // Stellt sicher, dass der erste Tab ("Nutzer entdecken") standardm√§√üig aktiv ist.
    if (tabButtons.length > 0 && tabContents.length > 0) {
        // Zuerst alle deaktivieren
        tabButtons.forEach(btn => btn.classList.remove('active'));
        tabContents.forEach(content => content.classList.remove('active'));
        
        // Dann den ersten aktivieren
        tabButtons[0].classList.add('active');
        const defaultContent = document.getElementById(tabButtons[0].dataset.target);
        if (defaultContent) {
            defaultContent.classList.add('active');
        }
    }

    // F√ºgt die Klick-Logik f√ºr jeden Tab-Button hinzu.
    tabButtons.forEach(button => {
        button.addEventListener('click', () => {
            // Alle Tabs und Inhalte ausblenden
            tabButtons.forEach(btn => btn.classList.remove('active'));
            tabContents.forEach(content => content.classList.remove('active'));
            
            // Den geklickten Tab und den zugeh√∂rigen Inhalt anzeigen
            button.classList.add('active');
            const targetContent = document.getElementById(button.dataset.target);
            if (targetContent) {
                targetContent.classList.add('active');
            }

            // Lade den Inhalt f√ºr den jeweiligen Tab (erneut), falls n√∂tig.
            if (button.dataset.target === 'community-content-suche') {
                loadUserList();
            } else if (button.dataset.target === 'community-content-feed') {
                loadActivityFeed();
            }
        });
    });
}

function handleAIResponse(responseText, nextStepHandler) {
    try {
        const jsonMatch = responseText.match(/{[\s\S]*}/);
        if (!jsonMatch) {
            throw new Error("Kein g√ºltiges JSON-Objekt in der KI-Antwort gefunden.");
        }
        
        const cleanedJsonString = jsonMatch[0];
        const parsedJson = JSON.parse(cleanedJsonString);
        nextStepHandler(parsedJson);

    } catch (e) {
        console.error("Parsing fehlgeschlagen:", e.message, "Original:", responseText);
        renderErrorState("Fehler bei der Verarbeitung der KI-Antwort. Bitte versuche es erneut.");
    }
}
function processConversationStep(parsedJson) {
    renderInteraction({ 
        text: parsedJson.next_question, 
        inputType: 'text', 
        placeholder: 'Deine Antwort...', 
        isComplete: parsedJson.conversation_complete 
    });
}
function handleResponse(userText) {
    console.log("handleResponse aufgerufen mit:", userText);
    const userContainer = document.createElement('div');
    userContainer.className = 'user-bubble-container self-end w-full flex flex-col items-end';
    userContainer.innerHTML = `<span class="text-xs text-gray-400 mr-3 mb-1">${i18next.t('matchmaker_user_bubble')}</span><div class="bg-blue-600 rounded-lg rounded-br-none px-4 py-3">${sanitizeHTML(userText)}</div>`;
    ui.chatLog.appendChild(userContainer);
    ui.chatLog.scrollTop = ui.chatLog.scrollHeight;
    lastUserInput = userText;
    
    callGeminiAPI(userText, systemPromptConversation, true)
        .then(responseText => {
            if (responseText) handleAIResponse(responseText, processConversationStep);
        });
}
function renderInteraction({ text, inputType, placeholder, isComplete = false }) {
    const aiContainer = document.createElement('div');
    aiContainer.className = 'ai-bubble-container self-start w-full flex flex-col items-start';
    const sanitizedText = sanitizeHTML(text);
    aiContainer.innerHTML = `<span class="text-xs text-cyan-400 ml-3 mb-1">${i18next.t('matchmaker_ai_bubble')}</span><div class="bg-gray-700 rounded-lg rounded-bl-none px-4 py-3">${sanitizedText.replace(/\n/g, '<br>')}</div>`;
    ui.chatLog.appendChild(aiContainer);
    ui.chatLog.scrollTop = ui.chatLog.scrollHeight;
    ui.userInputArea.innerHTML = '';
    
    if (isComplete) {
        const searchButton = document.createElement('button');
        searchButton.className = 'w-full bg-cyan-500 text-gray-900 font-bold text-lg px-10 py-3 rounded-lg hover:bg-cyan-400 transition-all duration-300 transform hover:scale-105';
        searchButton.textContent = 'Finde mein Spiel!';
        searchButton.onclick = extractTagsAndSearch;
        ui.userInputArea.appendChild(searchButton);
    } else if (inputType === 'text') {
        const form = document.createElement('form');
        form.innerHTML = `<input type="text" placeholder="${placeholder || 'Deine Antwort...'}" class="w-full bg-gray-900 border border-gray-600 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-50">`;
        form.onsubmit = (e) => {
            e.preventDefault();
            const userText = form.elements[0].value.trim();
            if (userText) handleResponse(userText);
        };
        ui.userInputArea.appendChild(form);
        form.elements[0].focus();
    }
}
function startConversation() {
            chatHistory = []; 
            ui.chatLog.innerHTML = '';
            ui.userInputArea.innerHTML = '';
            ui.resultContainer.classList.add('hidden');
            ui.chatWindow.style.display = 'flex';
            const initialAIMessage = i18next.t('matchmaker_initial_greeting');
            renderInteraction({ text: initialAIMessage, inputType: 'text', placeholder: i18next.t('matchmaker_initial_placeholder') });
        }
async function handleNavigation() {
    const hash = window.location.hash.substring(1);
    const [pageId, params] = hash.split('?');
    const targetPageId = '#' + (pageId || 'home');

    // Sicherheits-Check f√ºr die Admin-Seite
    if (targetPageId === '#admin') {
        const user = auth.currentUser;
        if (!user) {
            window.location.hash = '#home'; // Nicht eingeloggt -> zur Startseite
            return;
        }
        // √úberpr√ºfe die Admin-Rolle aus der Datenbank
        const userDoc = await db.collection('users').doc(user.uid).get();
        if (!userDoc.data()?.isAdmin) {
            alert("Zugriff verweigert.");
            window.location.hash = '#home'; // Kein Admin -> zur Startseite
            return;
        }
        // Wenn der Check erfolgreich ist, lade die Admin-Daten
        displayUserManagement();
        displayBlogManagement();
    }
    
    // Lade die √∂ffentliche News-Seite
    if (targetPageId === '#news') {
        displayNews();
    }

    // NEU: Lade die Partner-Seite
    if (targetPageId === '#partners') {
        displayPartners();
    }

    // Dieser Teil steuert die allgemeine Seitennavigation und blendet die richtige Sektion ein
    showPage(targetPageId);

    // Spezifische Logik f√ºr bestimmte Seiten nach dem Anzeigen ausf√ºhren
    if (targetPageId === '#matchmaker') {
        setTimeout(startConversation, 100);
    }
    
    if (targetPageId === '#leaderboard') {
        displayLeaderboard();
    }
    
    if (targetPageId === '#search-users') {
        setupCommunityTabs();
    }

    if (targetPageId === '#profile') {
        const urlParams = new URLSearchParams(params);
        const userId = urlParams.get('user');
        
        if (userId) {
            displayUserProfile(userId); 
        } else if (auth.currentUser) {
            displayUserProfile(auth.currentUser.uid); 
        } else {
            // Wenn kein Nutzer eingeloggt ist und kein Profil angefragt wird,
            // leite zur Startseite um.
            window.location.hash = '#home';
        }
    }
}
function renderErrorState(message) {
    const errorContainer = document.createElement('div');
    errorContainer.className = 'bg-red-900/50 text-red-200 rounded-lg p-4 mb-4';
    errorContainer.innerHTML = `
        <p class="font-bold">Fehler</p>
        <p>${message}</p>
    `;
    ui.userInputArea.innerHTML = '';
    ui.userInputArea.appendChild(errorContainer);
}
async function callGeminiAPI(prompt, systemPrompt, useHistory = true) {
    setLoading(true);
    const FUNCTION_URL = '/.netlify/functions/call-gemini';

    let localChatHistory = [];
    if (useHistory && chatHistory.length > 0) {
        localChatHistory = [...chatHistory];
    }
    localChatHistory.push({ role: "user", parts: [{ text: prompt }] });

    const payload = {
        contents: localChatHistory,
        systemInstruction: { role: "system", parts: [{ text: systemPrompt }] },
        generationConfig: {
            responseMimeType: "application/json",
            temperature: 0.7,
        }
    };

    try {
        const response = await fetch(FUNCTION_URL, {
            method: 'POST',
            body: JSON.stringify(payload)
        });

        if (!response.ok) {
            // NEUE LOGIK: Wir fangen den Fehler hier ab, um die Nachricht zu analysieren.
            const errorData = await response.json();
            if (errorData.error && errorData.error.includes("overloaded")) {
                throw new Error("model_overloaded"); // Ein spezieller Fehler f√ºr diesen Fall
            }
            throw new Error(`Serverless function error: ${response.status}`);
        }

        const result = await response.json();
        
        if (!result.candidates || !result.candidates[0].content.parts[0].text) {
            throw new Error("Ung√ºltige API-Antwortstruktur von der Function.");
        }
        const aiResponse = result.candidates[0].content.parts[0].text;

        if (useHistory) {
            chatHistory.push({ role: "user", parts: [{ text: prompt }] });
            chatHistory.push({ role: "model", parts: [{ text: aiResponse }] });
        }
        return aiResponse;

    } catch (error) {
        console.error("API Error:", error);
        // NEUE LOGIK: Zeige eine spezifische Nachricht f√ºr den √úberlastungs-Fall an.
        if (error.message === "model_overloaded") {
            renderErrorState("Die KI ist im Moment leider √ºberlastet. Bitte versuche es in ein paar Minuten erneut.");
        } else {
            renderErrorState(i18next.t('matchmaker_error_service'));
        }
        return null;
    } finally {
        setLoading(false);
    }
}
async function searchGames(criteria) {
    setLoading(true);
    console.log(`Starte gestaffelte IGDB-Suche mit Kriterien:`, criteria);

    const { genre, themes, category } = criteria;

    // Eine kleine Hilfsfunktion, um die Suchanfrage zu bauen
    const buildQuery = (searchGenre, searchThemes) => {
        let whereClauses = ["cover != null", "name != null", "total_rating_count > 10", "version_parent = null", "category = 0"]; // category 0 = Hauptspiel

        let genresToSearch = [];
        if (searchGenre) {
            genresToSearch.push(searchGenre);
        }
        if (category === 'indie') {
            genresToSearch.push('indie');
        }

        if (genresToSearch.length > 0) {
            whereClauses.push(`genres.slug = ("${genresToSearch.join('","')}")`);
        }
        
        if (searchThemes && searchThemes.length > 0) {
            const themeClauses = searchThemes.map(t => `themes.slug = "${t}"`);
            whereClauses.push(`(${themeClauses.join(' | ')})`);
        }
        
        const whereString = whereClauses.join(' & ');
        return `
            fields name, summary, cover.url, genres.name, genres.slug, themes.name, themes.slug, game_modes.name, game_modes.slug;
            where ${whereString};
            sort total_rating_count desc;
            limit 40;
        `;
    };

    // Hilfsfunktion zum Ausf√ºhren der Anfrage
    const runQuery = async (query) => {
        const response = await fetch('/.netlify/functions/call-igdb', {
            method: 'POST',
            body: JSON.stringify({ query })
        });
        if (!response.ok) return [];
        return await response.json();
    };

    let igdbResults = [];

    // --- VERSUCH 1: Perfekte Suche (Genre + Themen) ---
    console.log("Versuch 1: Suche mit Genre und allen Themen.");
    const query1 = buildQuery(genre, themes);
    igdbResults = await runQuery(query1);

    // --- VERSUCH 2: Breite Suche (Nur Genre), wenn Versuch 1 fehlschl√§gt ---
    if (igdbResults.length === 0 && genre) {
        console.log("Versuch 1 fehlgeschlagen. Starte Versuch 2: Suche nur mit Genre.");
        const query2 = buildQuery(genre, null);
        igdbResults = await runQuery(query2);
    }
    
    // --- VERSUCH 3: Allerletzte Suche (Nur Themen), wenn Versuch 2 fehlschl√§gt ---
    if (igdbResults.length === 0 && themes && themes.length > 0) {
        console.log("Versuch 2 fehlgeschlagen. Starte Versuch 3: Suche nur mit Themen.");
        const query3 = buildQuery(null, themes);
        igdbResults = await runQuery(query3);
    }
    
    // Ab hier bleibt der Rest der Funktion gleich (Filterung, Formatierung etc.)
    if (category === 'indie') {
        const strictlyIndieGames = igdbResults.filter(game => game.genres && game.genres.some(g => g.slug === 'indie'));
        console.log(`Strikte Indie-Filterung angewendet. Reduziert von ${igdbResults.length} auf ${strictlyIndieGames.length} Spiele.`);
        igdbResults = strictlyIndieGames;
    }

    const formattedGames = igdbResults.map(game => ({
        id: game.id,
        name: game.name,
        background_image: game.cover ? game.cover.url.replace('t_thumb', 't_cover_big') : 'https://placehold.co/600x400',
        genres: game.genres || [],
        themes: game.themes || [],
        game_modes: game.game_modes || []
    }));

    console.log(`Finale, gepr√ºfte Liste von IGDB: ${formattedGames.length} einzigartige Spiele.`);
    return formattedGames;
}
       async function extractTagsAndSearch() {
          const user = auth.currentUser;

    if (!user) {
        const usage = getGuestUsage();
        console.log('Pr√ºfe Limit. Aktueller Stand:', usage.count); // <-- HIER EINF√úGEN
        if (usage.count >= 2) {
            renderGuestLimitMessage();
            return;
        }
    }
            renderSystemMessage("Analysiere deine W√ºnsche...");
            const conversationText = chatHistory.map(entry => `${entry.role}: ${entry.parts[0].text}`).join('\n');
            const extractionPrompt = `Analysiere das Gespr√§ch und extrahiere passende Begriffe.\n---\nGESPR√ÑCH:\n${conversationText}\n---\nVERF√úGBARE TAGS (f√ºr Eigenschaften, Mechaniken etc.):\n${availableTags.join(', ')}\n---\nVERF√úGBARE GENRES (f√ºr Spielkategorien):\n${availableGenres.join(', ')}\n---\nExtrahiere jetzt die passenden 'tags' und 'genres' als Komma-getrennte Listen.`;
            const jsonResponseText = await callGeminiAPI(extractionPrompt, systemPromptExtractor, false);
            if (jsonResponseText) {
                handleAIResponse(jsonResponseText, handleTagExtraction);
            }
        }
async function handleTagExtraction(parsedJson) {
    const criteria = parsedJson;
    
    if (!criteria || !criteria.genre) {
         renderErrorState("Ich konnte leider kein klares Genre aus deiner Anfrage ableiten. Bitte versuche es noch einmal.");
         return;
    }

    renderSystemMessage(`Suche nach Spielen, die zu deinen W√ºnschen passen...`);
    const igdbResults = await searchGames(criteria);

    if (!igdbResults || igdbResults.length === 0) {
        renderErrorState(`Ich konnte leider keine Spiele f√ºr deine Kriterien finden. Bitte starte eine neue Suche.`);
        return;
    }

    // ======================================================================
    // NEUE LOGIK: Gesehene Spiele filtern & Ergebnisse mischen
    // ======================================================================
    let finalResults = igdbResults;
    const user = auth.currentUser;

    // Schritt 1: Hole die Liste der bereits gesehenen Spiele f√ºr eingeloggte Nutzer
    if (user) {
        try {
            const seenGamesSnapshot = await db.collection("users").doc(user.uid).collection("suggestedGames").get();
            const seenGameIds = new Set(seenGamesSnapshot.docs.map(doc => doc.data().rawgId));
            
            // Schritt 2: Filtere die IGDB-Ergebnisse
            const initialCount = finalResults.length;
            const unseenGames = igdbResults.filter(game => !seenGameIds.has(game.id));
            
            console.log(`Filter f√ºr gesehene Spiele angewendet. Reduziert von ${initialCount} auf ${unseenGames.length} Ergebnisse.`);

            // Fallback: Wenn alle Spiele aus der Suche schon gesehen wurden, nimm die urspr√ºngliche Liste,
            // damit der Nutzer nicht ohne Ergebnis dasteht.
            if (unseenGames.length > 0) {
                finalResults = unseenGames;
            } else {
                console.log("Alle gefundenen Spiele wurden bereits vorgeschlagen. Nutze urspr√ºngliche Liste als Fallback.");
            }
        } catch(e) {
            console.error("Fehler beim Abrufen der gesehenen Spiele:", e);
        }
    }

    // Schritt 3: Mische die (gefilterte) Ergebnisliste, um Abwechslung zu schaffen
    for (let i = finalResults.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [finalResults[i], finalResults[j]] = [finalResults[j], finalResults[i]];
    }

    // Schritt 4: W√§hle das erste Spiel aus der neuen, gemischten und gefilterten Liste
    const chosenGame = finalResults[0];

    // Der Rest der Funktion bleibt gleich...
    const gameFacts = {
        name: chosenGame.name,
        genres: chosenGame.genres.map(g => g.name).join(', '),
        themes: chosenGame.themes.map(t => t.name).join(', '),
        game_modes: chosenGame.game_modes.map(m => m.name).join(', ')
    };
    const descriptionPrompt = `
        Write a short, exciting recommendation for the following game based on these facts.
        Game Name: ${gameFacts.name}, Genres: ${gameFacts.genres}, Themes/Setting: ${gameFacts.themes}, Game Modes: ${gameFacts.game_modes}
        Based on these facts, create the recommendation text.
    `;
    const descriptionText = await callGeminiAPI(descriptionPrompt, systemPromptDescription, false);
    if (descriptionText) {
        showResult(chosenGame, descriptionText, finalResults);
    } else {
        renderErrorState("Die KI konnte keine Beschreibung f√ºr das Spiel erstellen.");
    }
}
function displayStars(container, avgRating, count) {
    let starsHtml = '';
    const rating = Math.round(avgRating * 2) / 2; // Auf halbe Sterne runden
    for (let i = 1; i <= 5; i++) {
        if (i <= rating) {
            starsHtml += '<svg class="w-5 h-5 text-yellow-400" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/></svg>';
        } else if (i - 0.5 === rating) {
            starsHtml += '<svg class="w-5 h-5 text-yellow-400" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292zM10 12.585V3.532l-.836 2.57H6.54l2.138 1.554-.836 2.57L10 12.585z"/></svg>';
        } else {
            starsHtml += '<svg class="w-5 h-5 text-gray-500" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/></svg>';
        }
    }
    container.innerHTML = `<div class="flex items-center">${starsHtml}<span class="text-xs text-gray-400 ml-2">(${count} Stimmen)</span></div>`;
}

// NEUE FUNKTION 3: Erstellt die interaktiven Sterne zum Bewerten
function createInteractiveStars(container, gameId, currentRating) {
    container.innerHTML = '';
    const starWrapper = document.createElement('div');
    starWrapper.className = 'flex items-center cursor-pointer';
    starWrapper.setAttribute('data-rating', currentRating);

    for (let i = 1; i <= 5; i++) {
        const star = document.createElement('div');
        star.innerHTML = '<svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/></svg>';
        star.className = i <= currentRating ? 'text-cyan-400' : 'text-gray-600 hover:text-cyan-300';
        
        star.addEventListener('mouseover', () => {
            Array.from(starWrapper.children).forEach((s, index) => {
                s.className = index < i ? 'text-cyan-400' : 'text-gray-600 hover:text-cyan-300';
            });
        });
        
        star.addEventListener('click', () => {
            submitRating(gameId, i);
        });
        
        starWrapper.appendChild(star);
    }
    
    starWrapper.addEventListener('mouseout', () => {
        const savedRating = parseInt(starWrapper.getAttribute('data-rating'));
         Array.from(starWrapper.children).forEach((s, index) => {
            s.className = index < savedRating ? 'text-cyan-400' : 'text-gray-600 hover:text-cyan-300';
        });
    });

    container.appendChild(starWrapper);
}
async function submitRating(gameId, rating) {
    if (!auth.currentUser) {
        alert("Bitte logge dich ein, um eine Bewertung abzugeben.");
        return;
    }
    const userId = auth.currentUser.uid;
    const gameIdStr = String(gameId);
    const gameRatingRef = db.collection("game_ratings").doc(gameIdStr);
    const userRatingRef = gameRatingRef.collection("user_ratings").doc(userId);

    try {
        await db.runTransaction(async (transaction) => {
            const gameDoc = await transaction.get(gameRatingRef);
            const userDoc = await transaction.get(userRatingRef);

            let newRatingCount = gameDoc.exists ? gameDoc.data().ratingCount : 0;
            let currentTotalRating = gameDoc.exists ? gameDoc.data().averageRating * newRatingCount : 0;

            if (userDoc.exists) {
                // Nutzer hat bereits bewertet -> alte Bewertung abziehen
                currentTotalRating -= userDoc.data().rating;
            } else {
                // Erste Bewertung dieses Nutzers
                newRatingCount++;
            }

            const newTotalRating = currentTotalRating + rating;
            const newAverageRating = newTotalRating / newRatingCount;

            transaction.set(userRatingRef, { rating: rating, timestamp: firebase.firestore.FieldValue.serverTimestamp() });
            transaction.set(gameRatingRef, {
                averageRating: newAverageRating,
                ratingCount: newRatingCount
            }, { merge: true });
            
        });
        
        alert("Danke f√ºr deine Bewertung!");
        await grantXpAndCheckLevelUp(userId, 5); // +5 XP f√ºr eine Bewertung
        setupRatingUI(gameId, true);

    } catch (error) {
        console.error("Fehler beim Speichern der Bewertung: ", error);
        alert("Deine Bewertung konnte nicht gespeichert werden.");
    }
const userDoc = await db.collection('users').doc(userId).get();
const username = userDoc.data()?.username || 'Ein Nutzer';
db.collection('activity_feed').add({
    type: 'RATING',
    userId: userId,
    username: username,
    details: {
        gameId: gameIdStr,
        gameTitle: (await db.collection("game_ratings").doc(gameIdStr).get()).data()?.gameTitle || 'einem Spiel', // Titel holen, falls gespeichert
        rating: rating
    },
    timestamp: firebase.firestore.FieldValue.serverTimestamp()
});
}        
async function grantXp(userId, amount) {
    if (!userId || !amount) return;

    const userRef = db.collection("users").doc(userId);
    try {
        await userRef.update({
            xp: firebase.firestore.FieldValue.increment(amount)
        });
        console.log(`User ${userId} hat ${amount} XP erhalten.`);
    } catch (error) {
        console.error("Fehler beim Vergeben von XP:", error);
    }
}

async function compareGamesWithFriend(friendId) {
    const currentUser = auth.currentUser;
    if (!currentUser) return;

    alert("Vergleiche Spiele, bitte warten...");

    try {
        const currentUserGamesSnapshot = await db.collection("users").doc(currentUser.uid).collection("suggestedGames").get();
        const currentUserGameIds = new Set(currentUserGamesSnapshot.docs.map(doc => doc.data().rawgId));

        const friendGamesSnapshot = await db.collection("users").doc(friendId).collection("suggestedGames").get();
        
        const commonGames = [];
        friendGamesSnapshot.forEach(doc => {
            const game = doc.data();
            if (currentUserGameIds.has(game.rawgId)) {
                commonGames.push(game.title);
            }
        });

        if (commonGames.length > 0) {
            alert("Ihr habt diese Spiele gemeinsam:\n\n- " + commonGames.join("\n- "));
        } else {
            alert("Ihr habt keine gemeinsamen Spielempfehlungen.");
        }

    } catch (error) {
        console.error("Fehler beim Spielevergleich:", error);
        alert("Spiele konnten nicht verglichen werden.");
    }
}

async function handleLikeGame(gameData, description) {
    const user = auth.currentUser;
    if (!user) return;

    const gameIdStr = String(gameData.id);
    const userId = user.uid;

    try {
        // Dieser Teil ist korrekt und speichert das Spiel in der pers√∂nlichen Sammlung.
        await db.collection("users").doc(userId).collection("suggestedGames").add({
            title: gameData.name,
            rawgId: gameData.id,
            imageUrl: gameData.background_image,
            description: description,
            status: 'liked',
            suggestedAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        const gameLikesRef = db.collection("gameLikes").doc(gameIdStr);
        const userProfile = await db.collection('users').doc(userId).get();
        const userData = userProfile.data();

        // KORREKTUR HIER:
        // Wir erstellen eine korrekte, verschachtelte 'users'-Map.
        await gameLikesRef.set({
            gameTitle: gameData.name,
            users: { // Erstellt das 'users'-Feld
                [userId]: { // F√ºgt den Nutzer mit seiner ID als Schl√ºssel hinzu
                    username: userData.username,
                    avatarUrl: userData.avatarUrl,
                    likedAt: firebase.firestore.FieldValue.serverTimestamp()
                }
            }
        }, { merge: true }); // { merge: true } sorgt daf√ºr, dass andere Nutzer im 'users'-Feld nicht √ºberschrieben werden.
        
        alert(`${gameData.name} wurde zu deinem Profil hinzugef√ºgt!`);
        await grantXpAndCheckLevelUp(userId, 15);
        startConversation();
        window.location.hash = '#matchmaker';

    } catch (error) {
        console.error("Fehler beim Liken des Spiels:", error);
        alert("Das Spiel konnte nicht zu deinem Profil hinzugef√ºgt werden.");
    }
}

async function handleDislikeGame(gameData, description) {
    const user = auth.currentUser;
    if (user) {
        // Speichere das abgelehnte Spiel im Hintergrund
        await db.collection("users").doc(user.uid).collection("suggestedGames").add({
            title: gameData.name,
            rawgId: gameData.id,
            imageUrl: gameData.background_image,
            description: description,
            status: 'disliked',
            suggestedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
    }

    // Pr√ºfen, ob noch weitere Kandidaten in der Liste sind
    if (currentGameCandidates && currentGameCandidates.length > 0) {
        renderSystemMessage("Okay, wie w√§re es stattdessen hiermit?");
        
        // NEUE LOGIK: Wir nehmen den n√§chsten Kandidaten aus der Liste
        const nextGame = currentGameCandidates[0]; // Das n√§chste Spiel in der Liste
        
        // Wir holen uns die originale Konversation f√ºr den Kontext.
        const fullConversation = chatHistory.map(entry => entry.parts[0].text).join(' ');

        // Wir erstellen einen simplen Prompt, der die KI bittet, nur den Text zu schreiben.
        const descriptionPrompt = `
            User request: "${fullConversation}"
            Chosen Game: "${nextGame.name}"
            Write the recommendation text now.
        `;
        
        // Wir rufen die KI mit dem "Texter"-System-Prompt auf.
        const newDescription = await callGeminiAPI(descriptionPrompt, systemPromptDescription, false);

        if (newDescription) {
            // Wir rufen showResult mit den korrekten Daten auf:
            // Unser gew√§hltes Spiel, der neue Text und die restlichen Kandidaten.
            showResult(nextGame, newDescription, currentGameCandidates);
        } else {
             renderErrorState("Die KI konnte keine neue Beschreibung erstellen.");
        }

    } else {
        renderErrorState("Ich habe leider keine weiteren Vorschl√§ge auf Lager. Lass uns eine neue Suche starten!");
    }
}
async function setupRatingUI(gameId, forceUpdate = false) {
    const avgRatingContainer = document.getElementById(`avg-rating-${gameId}`);
    const userRatingContainer = document.getElementById(`user-rating-${gameId}`);
    if (!avgRatingContainer || !userRatingContainer) return;

    if (!forceUpdate && avgRatingContainer.dataset.loaded === 'true') return;
    avgRatingContainer.dataset.loaded = 'true';

    try {
        // Durchschnittsbewertung holen
        const gameRatingDoc = await db.collection("game_ratings").doc(String(gameId)).get();
        if (gameRatingDoc.exists) {
            const { averageRating, ratingCount } = gameRatingDoc.data();
            displayStars(avgRatingContainer, averageRating, ratingCount);
        } else {
            avgRatingContainer.innerHTML = '<span class="text-xs text-gray-500">Noch keine Bewertungen</span>';
        }

        // Pers√∂nliche Bewertung des eingeloggten Nutzers holen
        const user = auth.currentUser;
        if (user) {
            const userRatingDoc = await db.collection("game_ratings").doc(String(gameId)).collection("user_ratings").doc(user.uid).get();
            const currentUserRating = userRatingDoc.exists ? userRatingDoc.data().rating : 0;
            createInteractiveStars(userRatingContainer, gameId, currentUserRating);
        }

    } catch (error) {
        console.error("Fehler beim Setup des Rating-UI:", error);
        avgRatingContainer.innerHTML = '<span class="text-xs text-red-400">Fehler</span>';
    }
}
function displayStars(container, avgRating, count) {
    let starsHtml = '';
    const rating = Math.round(avgRating * 2) / 2; // Auf halbe Sterne runden
    for (let i = 1; i <= 5; i++) {
        if (i <= rating) {
            starsHtml += '<svg class="w-5 h-5 text-yellow-400" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/></svg>';
        } else if (i - 0.5 === rating) {
            starsHtml += '<svg class="w-5 h-5 text-yellow-400" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292zM10 12.585V3.532l-.836 2.57H6.54l2.138 1.554-.836 2.57L10 12.585z"/></svg>';
        } else {
            starsHtml += '<svg class="w-5 h-5 text-gray-500" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/></svg>';
        }
    }
    container.innerHTML = `<div class="flex items-center">${starsHtml}<span class="text-xs text-gray-400 ml-2">(${count} Stimmen)</span></div>`;
}
function createInteractiveStars(container, gameId, currentRating) {
    container.innerHTML = '';
    const starWrapper = document.createElement('div');
    starWrapper.className = 'flex items-center cursor-pointer';
    starWrapper.setAttribute('data-rating', currentRating);

    for (let i = 1; i <= 5; i++) {
        const star = document.createElement('div');
        star.innerHTML = '<svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/></svg>';
        star.className = i <= currentRating ? 'text-cyan-400' : 'text-gray-600 hover:text-cyan-300';
        
        star.addEventListener('mouseover', () => {
            Array.from(starWrapper.children).forEach((s, index) => {
                s.className = index < i ? 'text-cyan-400' : 'text-gray-600 hover:text-cyan-300';
            });
        });
        
        star.addEventListener('click', () => {
            submitRating(gameId, i);
        });
        
        starWrapper.appendChild(star);
    }
    
    starWrapper.addEventListener('mouseout', () => {
        const savedRating = parseInt(starWrapper.getAttribute('data-rating'));
         Array.from(starWrapper.children).forEach((s, index) => {
            s.className = index < savedRating ? 'text-cyan-400' : 'text-gray-600 hover:text-cyan-300';
        });
    });

    container.appendChild(starWrapper);
}

/**
 * Speichert die Bewertung eines Nutzers in der Datenbank.
 */
async function submitRating(gameId, rating) {
    if (!auth.currentUser) {
        alert("Bitte logge dich ein, um eine Bewertung abzugeben.");
        return;
    }
    const userId = auth.currentUser.uid;
    const gameIdStr = String(gameId);
    const gameRatingRef = db.collection("game_ratings").doc(gameIdStr);
    const userRatingRef = gameRatingRef.collection("user_ratings").doc(userId);

    try {
        await db.runTransaction(async (transaction) => {
            const gameDoc = await transaction.get(gameRatingRef);
            const userDoc = await transaction.get(userRatingRef);

            let newRatingCount = gameDoc.exists ? gameDoc.data().ratingCount : 0;
            let currentTotalRating = gameDoc.exists ? gameDoc.data().averageRating * newRatingCount : 0;

            if (userDoc.exists) {
                // Nutzer hat bereits bewertet -> alte Bewertung abziehen
                currentTotalRating -= userDoc.data().rating;
            } else {
                // Erste Bewertung dieses Nutzers
                newRatingCount++;
            }

            const newTotalRating = currentTotalRating + rating;
            const newAverageRating = newTotalRating / newRatingCount;

            transaction.set(userRatingRef, { rating: rating, timestamp: firebase.firestore.FieldValue.serverTimestamp() });
            transaction.set(gameRatingRef, {
                averageRating: newAverageRating,
                ratingCount: newRatingCount
            }, { merge: true });
        });
        
        alert("Danke f√ºr deine Bewertung!");
        await grantXpAndCheckLevelUp(userId, 5); // +5 XP f√ºr eine Bewertung
        setupRatingUI(gameId, true); // UI mit den neuen Daten aktualisieren

    } catch (error) {
        console.error("Fehler beim Speichern der Bewertung: ", error);
        alert("Deine Bewertung konnte nicht gespeichert werden.");
    }
}
async function displayUserProfile(userId, filter = 'all') {
    if (!userId) {
        console.error("Keine User-ID zum Anzeigen des Profils √ºbergeben.");
        return;
    }

    const currentUser = auth.currentUser;
    const isOwnProfile = currentUser && currentUser.uid === userId;
    
    // UI-Elemente holen und f√ºr Fremdprofile anpassen
    const friendRequestsSection = document.getElementById('friend-requests-section');
    const mitspielerTabButton = document.querySelector('[data-target="profile-content-mitspieler"]');

    if (!isOwnProfile) {
        if(friendRequestsSection) friendRequestsSection.classList.add('hidden');
        if(mitspielerTabButton) mitspielerTabButton.classList.add('hidden');
    } else {
        if(friendRequestsSection) friendRequestsSection.classList.remove('hidden');
        if(mitspielerTabButton) mitspielerTabButton.classList.remove('hidden');
    }

    try {
        const userRef = db.collection("users").doc(userId);
        const userDoc = await userRef.get();
        if (!userDoc.exists) {
            document.getElementById('profile-content-container').innerHTML = `<p class="text-center text-red-400">${i18next.t('profile_user_not_found')}</p>`;
            return;
        }

        const userData = userDoc.data();
        
        // --- Profildaten anzeigen ---
        document.getElementById('profile-user-username').textContent = sanitizeHTML(userData.username || 'Nutzer');
        document.getElementById('profile-avatar').src = userData.avatarUrl || `https://i.pravatar.cc/150?u=${userId}`;
        
        // --- Statistiken laden und anzeigen ---
        loadAndDisplayStats(userData);
        
        // --- Empfehlungscode ---
        const referralContainer = document.getElementById('referral-container');
        if (isOwnProfile && referralContainer) {
            let userReferralCode = userData.referralCode;
            if (!userReferralCode) {
                userReferralCode = generateReferralCode();
                await userRef.update({ referralCode: userReferralCode });
            }
            referralContainer.classList.remove('hidden');
            document.getElementById('referral-code').textContent = userReferralCode;
            document.getElementById('referral-count').textContent = userData.referralCount || 0;
            document.getElementById('copy-referral-code').onclick = () => {
                navigator.clipboard.writeText(userReferralCode).then(() => {
                    const button = document.getElementById('copy-referral-code');
                    button.textContent = "Kopiert!";
                    setTimeout(() => { button.textContent = "Kopieren"; }, 2000);
                });
            };
        } else if (referralContainer) {
            referralContainer.classList.add('hidden');
        }

        // --- Robuste Ladeaufrufe f√ºr die Tab-Inhalte ---
        if (isOwnProfile) {
            try {
                await displayFriendRequests(userId);
                await displayFriendsList(userId);
                await displayGamePoolList(userId);
            } catch (e) { console.error("Fehler beim Laden der Freundes- & Mitspielerdaten isoliert:", e); }
        }
        
        try { await loadSavedGames(userId, filter, true); } 
        catch (e) { console.error("Fehler in loadSavedGames isoliert:", e); }
        
        try { await displayGamingNews(); } 
        catch (e) { console.error("Fehler beim Laden der News isoliert:", e); }
        
        // --- Tabs und Listener korrekt initialisieren ---
        setupProfileListeners();
        setupProfileTabs();

        // KORREKTUR: Erzwinge, dass der erste Tab ("Meine Spiele") beim Laden aktiv ist.
        document.querySelector('#profile-tabs .profile-tab-btn[data-target="profile-content-spiele"]').click();


    } catch (error) {
        console.error("Schwerwiegender Fehler beim Laden des Profils:", error);
    }
}

// NEUE HILFSFUNKTION: B√ºndelt die Logik f√ºr die Statistik-Anzeige
function loadAndDisplayStats(userData) {
    const level = userData.level || 1;
    document.getElementById('profile-user-rank').textContent = getRankForLevel(level);
    document.getElementById('profile-user-level').textContent = level;
    document.getElementById('profile-user-xp').textContent = userData.xp || 0;

    const xpForCurrentLevel = calculateCumulativeXp(level);
    const xpForNextLevel = calculateCumulativeXp(level + 1);
    const currentLevelXp = (userData.xp || 0) - xpForCurrentLevel;
    const requiredXpForNext = xpForNextLevel - xpForCurrentLevel;
    
    document.getElementById('progress-current-xp').textContent = `${currentLevelXp} XP`;
    document.getElementById('progress-next-level-xp').textContent = i18next.t('profile_xp_until_next_level', { xp: requiredXpForNext, level: level + 1 });
    document.getElementById('progress-bar-fill').style.width = `${Math.min(100, (currentLevelXp / requiredXpForNext) * 100)}%`;
}
async function displayFriendRequests(userId) {
    const requestsListContainer = document.getElementById('friend-requests-list');
    if (!requestsListContainer) return;

    try {
        const requestsQuery = db.collection("friendships")
                                .where("recipientId", "==", userId)
                                .where("status", "==", "pending");
        
        const requestsSnapshot = await requestsQuery.get();

        const friendRequestsSection = document.getElementById('friend-requests-section');
        if (requestsSnapshot.empty) {
            if(friendRequestsSection) friendRequestsSection.classList.add('hidden');
            return;
        }

        if(friendRequestsSection) friendRequestsSection.classList.remove('hidden');
        
        let requestsHtml = '';

        for (const doc of requestsSnapshot.docs) {
            const request = doc.data();
            const senderDoc = await db.collection("users").doc(request.senderId).get();
            
            if (senderDoc.exists) {
                const senderData = senderDoc.data();
                
                // KORREKTUR HIER: Name und √úbersetzung sind jetzt getrennt.
                requestsHtml += `
                    <div class="bg-gray-900 p-3 rounded-lg flex flex-col sm:flex-row items-center justify-between gap-3">
                        <p class="text-white">
                            <strong class="font-semibold">${senderData.username}</strong> ${i18next.t('profile_request_received')}
                        </p>
                        <div class="flex gap-2">
                            <button onclick="acceptFriendRequest('${doc.id}')" class="bg-green-600 text-white text-xs font-semibold px-3 py-1.5 rounded-md hover:bg-green-500">${i18next.t('profile_request_accept')}</button>
                            <button onclick="declineFriendRequest('${doc.id}')" class="bg-red-600 text-white text-xs font-semibold px-3 py-1.5 rounded-md hover:bg-red-500">${i18next.t('profile_request_decline')}</button>
                        </div>
                    </div>
                `;
            }
        }
        requestsListContainer.innerHTML = requestsHtml;

    } catch (error) {
        console.error("Fehler beim Laden der Freundschaftsanfragen:", error);
        requestsListContainer.innerHTML = `<p class="text-red-400">Anfragen konnten nicht geladen werden.</p>`;
    }
}
async function displayFriendsList(userId) {
    const friendsListContainer = document.getElementById('friends-list');
    if (!friendsListContainer) return;

    try {
        const friendsQuery = db.collection("friendships")
                                 .where("users", "array-contains", userId)
                                 .where("status", "==", "accepted");
        
        const friendsSnapshot = await friendsQuery.get();

        if (friendsSnapshot.empty) {
            friendsListContainer.innerHTML = `<p class="text-gray-500 text-sm">${i18next.t('profile_no_friends')}</p>`;
            return;
        }

        let friendsHtml = '';
        for (const doc of friendsSnapshot.docs) {
            const friendship = doc.data();
            const friendId = friendship.users.find(id => id !== userId);
            const friendDoc = await db.collection("users").doc(friendId).get();

            if (friendDoc.exists) {
                const friendData = friendDoc.data();
                const safeUsername = sanitizeHTML(friendData.username);
                friendsHtml += `
                    <div class="bg-gray-900 p-3 rounded-lg flex items-center justify-between gap-3">
                        <a href="#profile?user=${friendId}" class="nav-trigger flex items-center gap-3">
                            <img src="${friendData.avatarUrl || `https://i.pravatar.cc/40?u=${friendId}`}" class="w-10 h-10 rounded-full object-cover">
                            <span class="font-semibold text-white hover:text-cyan-400">${safeUsername}</span>
                        </a>
                        <div class="flex gap-2">
                             <button onclick="openChat('${friendId}', '${escapeJS(friendData.username)}', '${friendData.avatarUrl || ''}')" class="bg-blue-600 text-white text-xs font-semibold px-3 py-1.5 rounded-md hover:bg-blue-500">${i18next.t('profile_games_chat')}</button>
                        </div>
                    </div>
                `;
            }
        }
        friendsListContainer.innerHTML = friendsHtml;

    } catch (error) {
        console.error("Fehler beim Laden der Freundesliste:", error);
        friendsListContainer.innerHTML = `<p class="text-red-400">Freundesliste konnte nicht geladen werden.</p>`;
    }
}
function escapeJS(str) {
    if (!str) return '';
    // KORREKTUR: F√ºgt das Ersetzen von Backslashes hinzu, um Fehler zu verhindern
    return str.replace(/\\/g, '\\\\')
              .replace(/'/g, "\\'")
              .replace(/"/g, '\\"')
              .replace(/\n/g, '\\n');
}

// NEUE FUNKTION: √ñffnet und bef√ºllt das Modal
async function openCommentModal(gameId, title, imageUrl, description, isOwnProfile) {
    const modal = document.getElementById('game-detail-modal');
    
    document.getElementById('modal-game-title').textContent = title;
    document.getElementById('modal-game-image').src = imageUrl;
    document.getElementById('modal-game-description').textContent = description.replace(/\\n/g, '\n');
    
    const ratingSection = document.getElementById('modal-rating-section');
    const commentList = document.getElementById('modal-comment-list');
    const commentForm = document.getElementById('modal-comment-form');
    
    ratingSection.innerHTML = `<p class="text-sm text-gray-400">${i18next.t('profile_loading')}</p>`;
    commentList.innerHTML = `<p class="text-sm text-gray-400">${i18next.t('profile_loading')}</p>`;
    commentForm.innerHTML = ''; 

    modal.classList.add('visible');

    await setupRatingUIForModal(gameId, isOwnProfile); 
    await loadCommentsForGame(gameId, 'modal-comment-list'); 
    
    if (auth.currentUser) {
        const userDoc = await db.collection("users").doc(auth.currentUser.uid).get();
        const avatarSrc = userDoc.data()?.avatarUrl || 'https://i.pravatar.cc/40?u=default';
        commentForm.innerHTML = `
            <div class="flex items-start w-full gap-2.5">
                <img class="w-8 h-8 rounded-full object-cover" src="${avatarSrc}" alt="Dein Avatar">
                <form onsubmit="postGameComment(event, '${gameId}')" class="flex-grow flex gap-2">
                  <input type="text" id="comment-input-${gameId}" placeholder="${i18next.t('modal_comments')}..." class="flex-grow bg-gray-700 border border-gray-600 rounded-lg p-2 text-white text-sm focus:outline-none focus:ring-2 focus:ring-cyan-500" maxlength="150" required>
                  <button type="submit" class="bg-cyan-600 hover:bg-cyan-500 text-white font-semibold px-4 rounded-lg text-sm">${i18next.t('nav_post')}</button> 
                </form>
            </div>
        `; // Note: You'll need to add a "nav_post" key: "Posten" -> "Post"
    }
}

// NEUE FUNKTION: Schlie√üt das Modal
function closeCommentModal() {
    document.getElementById('game-detail-modal').classList.remove('visible');
}

// NEUE FUNKTION: Passt das Rating-Setup f√ºr das Modal an
async function setupRatingUIForModal(gameId, isOwnProfile) {
    const container = document.getElementById('modal-rating-section');
    if (!container) return;
    
    container.innerHTML = `
        <div id="modal-avg-rating-${gameId}"></div>
        ${isOwnProfile ? `<div id="modal-user-rating-${gameId}" class="mt-2"></div>` : ''}
    `;

    // Jetzt rufen wir die existierende Logik auf, aber mit den neuen Container-IDs
    const avgContainer = document.getElementById(`modal-avg-rating-${gameId}`);
    const gameRatingDoc = await db.collection("game_ratings").doc(String(gameId)).get();
    if (gameRatingDoc.exists) {
        displayStars(avgContainer, gameRatingDoc.data().averageRating, gameRatingDoc.data().ratingCount);
    } else {
        avgContainer.innerHTML = '<span class="text-xs text-gray-500">Noch keine Bewertungen</span>';
    }

    if (isOwnProfile && auth.currentUser) {
        const userContainer = document.getElementById(`modal-user-rating-${gameId}`);
        const userRatingDoc = await db.collection("game_ratings").doc(String(gameId)).collection("user_ratings").doc(auth.currentUser.uid).get();
        const rating = userRatingDoc.exists ? userRatingDoc.data().rating : 0;
        createInteractiveStars(userContainer, gameId, rating);
    }
}
document.getElementById('close-comment-modal').addEventListener('click', closeCommentModal);
document.getElementById('game-detail-modal').addEventListener('click', (e) => {
    if (e.target.id === 'game-detail-modal') {
        closeCommentModal();
    }
});
async function showResult(finalGame, finalDescription, rawgGames) {
    setLoading(false);
    try {
        currentGameCandidates = rawgGames.filter(g => g.id !== finalGame.id);

        // Spiel-Informationen anzeigen
        const resultContainer = ui.resultContainer;
        resultContainer.querySelector('#result-img').src = finalGame.background_image;
        resultContainer.querySelector('#result-title').textContent = finalGame.name;
        resultContainer.querySelector('#result-description').textContent = finalDescription.replace(/"/g, '');

        // --- NEU: AFFILIATE-BUTTONS DYNAMISCH ERSTELLEN ---
        const affiliateContainer = document.getElementById('result-affiliate-links');
        if (affiliateContainer) {
            affiliateContainer.innerHTML = ''; // Leert alte Buttons
            const encodedGameName = encodeURIComponent(finalGame.name);

            affiliatePartners.forEach(partner => {
                const partnerUrl = partner.urlTemplate.replace('{{GAME_NAME}}', encodedGameName);
                const buttonHtml = `
                    <a href="${partnerUrl}" target="_blank" rel="noopener nofollow"
                       class="flex-1 bg-gray-700 text-white font-semibold px-4 py-2.5 rounded-lg hover:bg-gray-600 transition-colors flex items-center justify-center gap-2 min-w-[140px]">
                        <img src="${partner.logo}" alt="${partner.name}" class="h-4">
                        <span>${partner.name}</span>
                    </a>
                `;
                affiliateContainer.innerHTML += buttonHtml;
            });
        }
        
        // Like/Dislike-Buttons wie gewohnt anzeigen
        document.getElementById('result-action-container')?.remove();
        const actionContainer = document.createElement('div');
        actionContainer.id = 'result-action-container';
        actionContainer.className = 'mt-8 flex flex-col sm:flex-row gap-4';
        actionContainer.innerHTML = `
            <button id="like-btn" class="w-full bg-green-600 text-white font-bold px-6 py-3 rounded-lg hover:bg-green-500 transition-colors transform hover:scale-105">üëç Gef√§llt mir</button>
            <button id="dislike-btn" class="w-full bg-red-600 text-white font-bold px-6 py-3 rounded-lg hover:bg-red-500 transition-colors transform hover:scale-105">üëé Nicht mein Fall</button>
        `;
        resultContainer.appendChild(actionContainer);
        
        document.getElementById('like-btn').onclick = () => handleLikeGame(finalGame, finalDescription);
        document.getElementById('dislike-btn').onclick = () => handleDislikeGame(finalGame, finalDescription);

        // UI-Status aktualisieren
        ui.chatWindow.style.display = 'none';
        resultContainer.classList.remove('hidden');
        
        if (!auth.currentUser) {
            incrementGuestUsage();
        }
        if (!document.querySelector('.confetti-canvas-active')) {
             fireConfetti();
        }
    } catch (e) {
        console.error("Error in showResult:", e);
        renderErrorState("Fehler beim Anzeigen des finalen Ergebnisses.");
    }
}
        function renderSystemMessage(message) {
            const container = document.createElement('div');
            container.className = 'ai-bubble-container self-center w-full flex flex-col items-center';
            container.innerHTML = `<div class="bg-yellow-900/50 text-yellow-300 text-xs rounded-full px-4 py-1">${message}</div>`;
            ui.chatLog.appendChild(container);
            ui.chatLog.scrollTop = ui.chatLog.scrollHeight;
        }
        function renderErrorState(message) {
            setLoading(false);
            const container = document.createElement('div');
            container.className = 'text-center p-4';
            container.innerHTML = `<div class="bg-red-900/50 text-red-200 rounded-lg p-4 mb-3"><p class="font-bold">Hoppla!</p><p>${message}</p></div><button class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-4 rounded">Neu beginnen</button>`;
            container.querySelector('button').onclick = startConversation;
            ui.userInputArea.innerHTML = '';
            ui.userInputArea.appendChild(container);
        }
        function setLoading(isLoading) {
            if (isLoading) {
                ui.userInputArea.innerHTML = `<div class="text-center text-gray-400 is-loading">${i18next.t('matchmaker_loading_ai')}</div>`;
            } else {
                if (!ui.userInputArea.querySelector('.bg-red-900\\/50')) {
                    ui.userInputArea.innerHTML = '';
                }
            }
        }
        function fireConfetti() {
            const canvas = document.getElementById('confetti-canvas');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            let confetti = [];
            const confettiCount = 100;
            for (let i = 0; i < confettiCount; i++) {
                confetti.push({ x: Math.random() * canvas.width, y: Math.random() * canvas.height - canvas.height, r: Math.random() * 4 + 1, d: Math.random() * confettiCount, color: `hsl(${Math.random() * 360}, 90%, 70%)`, tilt: Math.floor(Math.random() * 10) - 10, tiltAngleIncremental: Math.random() * 0.07 + 0.05, tiltAngle: 0 });
            }
            let animationFrameId;
            function draw() {
                if (!ctx) return;
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                for (let i = 0; i < confetti.length; i++) {
                    const c = confetti[i];
                    ctx.beginPath();
                    ctx.lineWidth = c.r * 2;
                    ctx.strokeStyle = c.color;
                    ctx.moveTo(c.x + c.tilt + c.r, c.y);
                    ctx.lineTo(c.x + c.tilt, c.y + c.tilt + c.r);
                    ctx.stroke();
                }
                update();
            }
            function update() {
                let remaining = 0;
                for (let i = 0; i < confetti.length; i++) {
                    const c = confetti[i];
                    c.tiltAngle += c.tiltAngleIncremental;
                    c.y += (Math.cos(c.d) + 3 + c.r / 2) / 2;
                    c.tilt = Math.sin(c.tiltAngle - i / 3) * 15;
                    if (c.y <= canvas.height) remaining++;
                }
                if (remaining > 0) {
                    animationFrameId = requestAnimationFrame(draw);
                } else {
                    if(ctx) ctx.clearRect(0, 0, canvas.width, canvas.height);
                    cancelAnimationFrame(animationFrameId);
                }
            }
            draw();
        }
        function renderGuestLimitMessage() {
    setLoading(false);
    const container = document.createElement('div');
    container.className = 'text-center p-4';
    container.innerHTML = `
    <div class="bg-blue-900/50 text-blue-200 rounded-lg p-4 mb-3">
        <p class="font-bold">${i18next.t('matchmaker_guest_limit_title')}</p>
        <p class="mt-2">${i18next.t('matchmaker_guest_limit_desc')}</p>
    </div>
    <div class="flex gap-4 mt-4">
        <button id="limit-register-btn" class="flex-1 bg-cyan-500 hover:bg-cyan-400 text-gray-900 font-bold py-2 px-4 rounded">${i18next.t('matchmaker_guest_limit_register')}</button>
        <button id="limit-login-btn" class="flex-1 bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded">${i18next.t('nav_login')}</button>
    </div>
`;
    
    // Event Listeners for the new buttons
    container.querySelector('#limit-register-btn').onclick = () => openAuthModal('register');
    container.querySelector('#limit-login-btn').onclick = () => openAuthModal('login');
    
    // UI-Bereich leeren und Meldung einf√ºgen
    const ui = { userInputArea: document.getElementById('user-input-area') };
    ui.userInputArea.innerHTML = '';
    ui.userInputArea.appendChild(container);
}
function generateCacheKey(tags, genres) {
    const sortedTags = tags ? tags.split(',').sort().join(',') : '';
    const sortedGenres = genres ? genres.split(',').sort().join(',') : '';
    return `genres:${sortedGenres}|tags:${sortedTags}`;
}
 // === LEVEL-SYSTEM FUNKTIONEN UND KONSTANTEN ===

const XP_FOR_LEVEL = [
    0,     // Level 1: Start
    100,   // Ben√∂tigte XP f√ºr Level 2
    200,   // Ben√∂tigte XP f√ºr Level 3
    400,   // Ben√∂tigte XP f√ºr Level 4
    1200,  // Ben√∂tigte XP f√ºr Level 5 (deutlicher Sprung)
    1800,  // Ben√∂tigte XP f√ºr Level 6
    2500,  // Ben√∂tigte XP f√ºr Level 7
    3500,  // Ben√∂tigte XP f√ºr Level 8
    5000,  // Ben√∂tigte XP f√ºr Level 9
    7500   // Ben√∂tigte XP f√ºr Level 10
];

const RANKS = {
    1: "Spiele-Neuling",
    3: "KI-Entdecker",
    5: "Community-Mitglied",
    7: "Spiele-Kenner",
    10: "GameMatch-Veteran"
};

function calculateLevel(totalXp) {
    let cumulativeXp = 0;
    for (let level = 1; level < XP_FOR_LEVEL.length; level++) {
        cumulativeXp += XP_FOR_LEVEL[level-1];
        if (totalXp < cumulativeXp + XP_FOR_LEVEL[level]) {
            return level;
        }
    }
    return XP_FOR_LEVEL.length;
}

function getRankForLevel(level) {
    let currentRank = "Spiele-Neuling";
    for (const rankLevel in RANKS) {
        if (level >= rankLevel) {
            currentRank = RANKS[rankLevel];
        }
    }
    return currentRank;
}

function calculateCumulativeXp(level) {
    let cumulativeXp = 0;
    // Wir summieren die XP, die f√ºr JEDES Level bis zum Ziellevel ben√∂tigt werden.
    // F√ºr Level 3 sind das die XP f√ºr Level 1 (0) + XP f√ºr Level 2 (100).
    for (let i = 1; i < level; i++) {
        cumulativeXp += XP_FOR_LEVEL[i];
    }
    return cumulativeXp;
}

async function grantXpAndCheckLevelUp(userId, amount) {
    if (!userId || !amount) return;
    const userRef = db.collection("users").doc(userId);
    try {
        // Diese Transaktion stellt sicher, dass Lese- und Schreibvorg√§nge atomar sind.
        await db.runTransaction(async (transaction) => {
            const userDoc = await transaction.get(userRef);
            if (!userDoc.exists) {
                throw "User does not exist!";
            }

            const currentXp = userDoc.data().xp || 0;
            const newXp = currentXp + amount;
            
            const currentLevel = userDoc.data().level || 1;
            const newLevel = calculateLevel(newXp);

            // Aktualisiere die Felder XP und Level in der Transaktion.
            transaction.update(userRef, { xp: newXp, level: newLevel });

            if (newLevel > currentLevel) {
                console.log(`User ${userId} ist auf Level ${newLevel} aufgestiegen!`);
                // Hier k√∂nntest du eine Benachrichtigung f√ºr den Level-Up anzeigen.
            }
        });
    } catch (error) {
        console.error("Fehler beim Vergeben von XP:", error);
    }
}
async function toggleUserBan(userId, isCurrentlyBanned) {
    if (!confirm(`M√∂chtest du diesen Nutzer wirklich ${isCurrentlyBanned ? 'entsperren' : 'sperren'}?`)) {
        return;
    }
    try {
        await db.collection('users').doc(userId).update({
            isBanned: !isCurrentlyBanned
        });
        alert(`Nutzer wurde erfolgreich ${isCurrentlyBanned ? 'entsperrt' : 'gesperrt'}.`);
        displayUserManagement(); // Lade die Tabelle neu, um den neuen Status anzuzeigen
    } catch (error) {
        console.error("Fehler beim √Ñndern des Sperrstatus:", error);
        alert("Aktion fehlgeschlagen.");
    }
}

/**
 * √Ñndert den 'isAdmin'-Status eines Nutzers in der Datenbank.
 * @param {string} userId - Die UID des Nutzers.
 * @param {boolean} isCurrentlyAdmin - Der aktuelle Admin-Status.
 */
async function toggleAdminStatus(userId, isCurrentlyAdmin) {
    if (!confirm(`M√∂chtest du diesem Nutzer wirklich die Admin-Rechte ${isCurrentlyAdmin ? 'entziehen' : 'geben'}?`)) {
        return;
    }
    try {
        await db.collection('users').doc(userId).update({
            isAdmin: !isCurrentlyAdmin
        });
        alert(`Admin-Status wurde erfolgreich ge√§ndert.`);
        displayUserManagement(); // Lade die Tabelle neu
    } catch (error) {
        console.error("Fehler beim √Ñndern des Admin-Status:", error);
        alert("Aktion fehlgeschlagen.");
    }
}
async function displayNews() {
    const postListContainer = document.getElementById('news-post-list');
    if (!postListContainer) return;

    postListContainer.innerHTML = `<p class="text-center text-gray-400">${i18next.t('news_loading')}</p>`;

    try {
        const querySnapshot = await db.collection("blogPosts").orderBy("createdAt", "desc").get();
        if (querySnapshot.empty) {
            postListContainer.innerHTML = `<p class="text-center text-gray-500">${i18next.t('news_no_posts')}</p>`;
            return;
        }

        let postsHtml = '';
        querySnapshot.forEach(doc => {
            const post = doc.data();
            const postDate = post.createdAt?.toDate().toLocaleDateString(i18next.language, { year: 'numeric', month: 'long', day: 'numeric' }) || '';

            // KORREKTUR 1: Desinfiziere den Titel des Beitrags.
            const safeTitle = sanitizeHTML(post.title);

            // KORREKTUR 2: Desinfiziere den Inhalt, BEVOR Zeilenumbr√ºche hinzugef√ºgt werden.
            const sanitizedContent = sanitizeHTML(post.content);
            const contentHtml = sanitizedContent.replace(/\n/g, '<br>'); // Erst jetzt sicher die Zeilenumbr√ºche umwandeln.

            postsHtml += `
                <article class="bg-gray-800/50 border border-gray-700 rounded-xl p-8">
                    <h3 class="text-3xl font-bold text-cyan-400 mb-2">${safeTitle}</h3>
                    <p class="text-sm text-gray-400 mb-6">${i18next.t('news_published_on')} ${postDate}</p>
                    <div class="prose prose-invert max-w-none text-gray-300">${contentHtml}</div>
                </article>
            `;
        });
        postListContainer.innerHTML = postsHtml;
    } catch (error) {
        console.error("Fehler beim Laden der News:", error);
        postListContainer.innerHTML = `<p class="text-center text-red-400">${i18next.t('news_error')}</p>`;
    }
}
async function displayBlogManagement() {
    const postListContainer = document.getElementById('admin-blog-post-list');
    if (!postListContainer) return;
    postListContainer.innerHTML = '<p class="text-gray-400">Lade Beitr√§ge...</p>';

    const querySnapshot = await db.collection("blogPosts").orderBy("createdAt", "desc").get();
    if (querySnapshot.empty) {
        postListContainer.innerHTML = '<p class="text-gray-500">Noch keine Beitr√§ge erstellt.</p>';
        return;
    }

    let postsHtml = '';
    querySnapshot.forEach(doc => {
        const post = doc.data();
        postsHtml += `
            <div class="bg-gray-900 p-3 rounded-lg flex justify-between items-center">
                <span class="font-semibold text-white">${post.title}</span>
                <div class="flex gap-2">
                    <button onclick="editBlogPost('${doc.id}', '${post.title.replace(/'/g, "\\'")}', '${post.content.replace(/'/g, "\\'").replace(/\n/g, '\\n')}')" class="text-xs bg-blue-600 text-white font-semibold px-2 py-1 rounded-md hover:bg-blue-500">Bearbeiten</button>
                    <button onclick="deleteBlogPost('${doc.id}')" class="text-xs bg-red-600 text-white font-semibold px-2 py-1 rounded-md hover:bg-red-500">L√∂schen</button>
                </div>
            </div>
        `;
    });
    postListContainer.innerHTML = postsHtml;
}

/**
 * Bef√ºllt das Bearbeitungsformular mit den Daten eines bestehenden Posts.
 */
function editBlogPost(id, title, content) {
    document.getElementById('blog-post-id').value = id;
    document.getElementById('blog-post-title').value = title;
    document.getElementById('blog-post-content').value = content.replace(/\\n/g, '\n');
    document.getElementById('blog-post-title').focus();
}

/**
 * L√∂scht einen Blog-Post aus der Datenbank.
 */
async function deleteBlogPost(postId) {
    if (!confirm("M√∂chtest du diesen Beitrag wirklich endg√ºltig l√∂schen?")) return;
    try {
        await db.collection("blogPosts").doc(postId).delete();
        alert("Beitrag gel√∂scht.");
        displayBlogManagement(); // Liste aktualisieren
    } catch (error) {
        console.error("Fehler beim L√∂schen des Beitrags:", error);
        alert("Beitrag konnte nicht gel√∂scht werden.");
    }
}

/**
 * Behandelt das Absenden des Blog-Post-Formulars (Erstellen & Aktualisieren).
 */
async function handleBlogPostSubmit(event) {
    event.preventDefault();
    const postId = document.getElementById('blog-post-id').value;
    const title = document.getElementById('blog-post-title').value;
    const content = document.getElementById('blog-post-content').value;

    if (!title || !content) {
        alert("Titel und Inhalt d√ºrfen nicht leer sein.");
        return;
    }

    const postData = {
        title: title,
        content: content,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
    };

    try {
        if (postId) {
            // Bestehenden Post aktualisieren
            await db.collection("blogPosts").doc(postId).update(postData);
            alert("Beitrag erfolgreich aktualisiert!");
        } else {
            // Neuen Post erstellen
            await db.collection("blogPosts").add(postData);
            alert("Beitrag erfolgreich erstellt!");
        }
        document.getElementById('blog-post-form').reset();
        document.getElementById('blog-post-id').value = '';
        displayBlogManagement(); // Liste aktualisieren
    } catch (error) {
        console.error("Fehler beim Speichern des Beitrags:", error);
        alert("Beitrag konnte nicht gespeichert werden.");
    }
}
async function displayLatestNewsOnHome() {
    const container = document.getElementById('home-news-list');
    if (!container) return;

    try {
        const querySnapshot = await db.collection("blogPosts").orderBy("createdAt", "desc").limit(2).get();
        if (querySnapshot.empty) {
            container.innerHTML = '<p class="text-center text-gray-500 lg:col-span-2">Es gibt noch keine Beitr√§ge.</p>';
            return;
        }

        let postsHtml = '';
        querySnapshot.forEach(doc => {
            const post = doc.data();
            const postDate = post.createdAt?.toDate().toLocaleDateString('de-DE', { day: 'numeric', month: 'long' }) || '';
            
            // KORREKTUR: Titel und Teaser werden desinfiziert
            const safeTitle = sanitizeHTML(post.title);
            const safeTeaser = sanitizeHTML(post.content.substring(0, 120) + '...');

            postsHtml += `
                <article class="flex flex-col items-start justify-between bg-gray-800/50 p-6 rounded-2xl ring-1 ring-white/10 hover:ring-cyan-400/50 transition-all">
                    <div class="relative w-full">
                        <div class="flex items-center gap-x-4 text-xs">
                            <time datetime="${post.createdAt?.toDate().toISOString()}" class="text-gray-400">${postDate}</time>
                        </div>
                        <div class="group relative">
                            <h3 class="mt-3 text-lg font-semibold leading-6 text-white group-hover:text-cyan-400">
                                <a href="#news" class="nav-trigger">
                                    <span class="absolute inset-0"></span>
                                    ${safeTitle}
                                </a>
                            </h3>
                            <p class="mt-4 line-clamp-3 text-sm leading-6 text-gray-300">${safeTeaser}</p>
                        </div>
                    </div>
                </article>
            `;
        });
        container.innerHTML = postsHtml;
    } catch (error) {
        console.error("Fehler beim Laden der News f√ºr die Startseite:", error);
        container.innerHTML = '<p class="text-red-400 lg:col-span-2">Beitr√§ge konnten nicht geladen werden.</p>';
    }
}
document.addEventListener('DOMContentLoaded', () => {

    // Authentifizierungs-Status √ºberwachen
    auth.onAuthStateChanged(user => {
        const isLoggedIn = !!user;
        const authElements = {
            // Desktop
            loginBtn: document.getElementById('login-btn'),
            registerBtn: document.getElementById('register-btn'),
            logoutBtn: document.getElementById('logout-btn'),
            profileLink: document.getElementById('profile-link'),
            searchUsersLink: document.getElementById('search-users-link'),
            leaderboardLink: document.getElementById('leaderboard-link'),
            adminLink: document.getElementById('admin-link'),
            unreadBadge: document.getElementById('unread-messages-badge'),
            // Mobile
            mobileLoginBtn: document.getElementById('mobile-login-btn'),
            mobileRegisterBtn: document.getElementById('mobile-register-btn'),
            mobileMenuDivider: document.getElementById('mobile-menu-divider'),
            mobileLeaderboardLink: document.getElementById('mobile-leaderboard-link'),
            mobileSearchUsersLink: document.getElementById('mobile-search-users-link'),
            mobileProfileLink: document.getElementById('mobile-profile-link'),
            mobileAdminLink: document.getElementById('mobile-admin-link'),
            mobileLogoutBtn: document.getElementById('mobile-logout-btn')
        };
        if (isLoggedIn && (window.location.hash === '' || window.location.hash === '#home')) {
        // Wenn der Nutzer eingeloggt ist und sich auf der Startseite befindet,
        // leite ihn zu seinem Profil weiter.
        window.location.hash = '#profile';
    }
        
        // --- Robuste Logik f√ºr alle Elemente ---
        // Logged-out Zustand
        authElements.loginBtn?.classList.toggle('hidden', isLoggedIn);
        authElements.registerBtn?.classList.toggle('hidden', isLoggedIn);
        authElements.mobileLoginBtn?.classList.toggle('hidden', isLoggedIn);
        authElements.mobileRegisterBtn?.classList.toggle('hidden', isLoggedIn);
        authElements.mobileMenuDivider?.classList.toggle('hidden', isLoggedIn);

        // Logged-in Zustand
        authElements.logoutBtn?.classList.toggle('hidden', !isLoggedIn);
        authElements.profileLink?.classList.toggle('hidden', !isLoggedIn);
        authElements.searchUsersLink?.classList.toggle('hidden', !isLoggedIn);
        authElements.leaderboardLink?.classList.toggle('hidden', !isLoggedIn);
        authElements.mobileLeaderboardLink?.classList.toggle('hidden', !isLoggedIn);
        authElements.mobileSearchUsersLink?.classList.toggle('hidden', !isLoggedIn);
        authElements.mobileProfileLink?.classList.toggle('hidden', !isLoggedIn);
        authElements.mobileLogoutBtn?.classList.toggle('hidden', !isLoggedIn);

        // Elemente, die erst bei Bedarf gezeigt werden
        authElements.adminLink?.classList.add('hidden');
        authElements.mobileAdminLink?.classList.add('hidden');
        
        if (isLoggedIn) {
            unsubscribeFromUserDoc = db.collection('users').doc(user.uid).onSnapshot(doc => {
                 if (doc.exists) {
                    const userData = doc.data();
                    const totalUnread = (userData.totalUnreadMessages || 0) + (userData.pendingFriendRequests || 0);
                    if (totalUnread > 0 && authElements.unreadBadge) {
                        authElements.unreadBadge.textContent = totalUnread > 9 ? '9+' : totalUnread;
                        authElements.unreadBadge.classList.remove('hidden');
                    } else if(authElements.unreadBadge) {
                        authElements.unreadBadge.classList.add('hidden');
                    }
                    if (userData.isAdmin === true) {
                        authElements.adminLink?.classList.remove('hidden');
                        authElements.mobileAdminLink?.classList.remove('hidden');
                    }
                }
            });
        } else {
            if (unsubscribeFromUserDoc) unsubscribeFromUserDoc();
            if (authElements.unreadBadge) authElements.unreadBadge.classList.add('hidden');
        }
    });

    // --- Alle anderen Event-Listener ---
    
    // Auth Modal
    document.getElementById('login-btn')?.addEventListener('click', () => openAuthModal('login'));
    document.getElementById('register-btn')?.addEventListener('click', () => openAuthModal('register'));
    document.getElementById('mobile-login-btn')?.addEventListener('click', () => openAuthModal('login'));
    document.getElementById('mobile-register-btn')?.addEventListener('click', () => openAuthModal('register'));
    document.getElementById('open-login-modal-btn')?.addEventListener('click', () => openAuthModal('login'));
    document.getElementById('open-register-modal-btn')?.addEventListener('click', () => openAuthModal('register'));
    document.getElementById('close-auth-modal-btn')?.addEventListener('click', closeAuthModal);
    document.getElementById('auth-modal')?.addEventListener('click', (e) => {
        if (e.target.id === 'auth-modal') closeAuthModal();
    });
    document.getElementById('switch-to-register')?.addEventListener('click', () => openAuthModal('register'));
    document.getElementById('switch-to-login')?.addEventListener('click', () => openAuthModal('login'));

    // Formular-Submissions
    document.getElementById('login-form')?.addEventListener('submit', handleEmailLogin);
    document.getElementById('register-form')?.addEventListener('submit', handleEmailRegister);

    // Google Sign-In
    document.getElementById('google-signin-btn')?.addEventListener('click', signInWithGoogle);
    document.getElementById('google-signup-btn')?.addEventListener('click', signInWithGoogle);

    // Logout
    document.getElementById('logout-btn')?.addEventListener('click', handleLogout);
    document.getElementById('mobile-logout-btn')?.addEventListener('click', handleLogout);

    // Mobile Menu
    const mobileMenuBtn = document.getElementById('mobile-menu-btn');
    const mobileMenu = document.getElementById('mobile-menu');
    const openIcon = document.getElementById('menu-open-icon');
    const closeIcon = document.getElementById('menu-close-icon');

    mobileMenuBtn?.addEventListener('click', () => {
        mobileMenu.classList.toggle('hidden');
        openIcon.classList.toggle('hidden');
        closeIcon.classList.toggle('hidden');
    });
    mobileMenu?.addEventListener('click', (e) => {
        if (e.target.tagName === 'A' || e.target.tagName === 'BUTTON') {
            mobileMenu.classList.add('hidden');
            openIcon.classList.remove('hidden');
            closeIcon.classList.add('hidden');
        }
    });

    // Admin Tabs
    const adminTabs = document.getElementById('admin-tabs');
    if (adminTabs) {
        adminTabs.addEventListener('click', (e) => {
            const clickedButton = e.target.closest('.profile-tab-btn');
            if (!clickedButton) return;
            adminTabs.querySelectorAll('.profile-tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('#admin-tab-content-container .profile-tab-content').forEach(content => content.classList.remove('active'));
            clickedButton.classList.add('active');
            const targetContent = document.getElementById(clickedButton.dataset.target);
            if (targetContent) targetContent.classList.add('active');
        });
    }
    
    // Blog Formular
    document.getElementById('blog-post-form')?.addEventListener('submit', handleBlogPostSubmit);
    document.getElementById('clear-blog-form')?.addEventListener('click', () => {
        document.getElementById('blog-post-form').reset();
        document.getElementById('blog-post-id').value = '';
    });
    
    // Giveaway Banner
    const giveawayBanner = document.getElementById('giveaway-banner');
    const closeGiveawayBanner = document.getElementById('close-giveaway-banner');
    if (giveawayBanner && closeGiveawayBanner) {
        if (sessionStorage.getItem('giveawayBannerClosed') !== 'true') {
            giveawayBanner.classList.remove('hidden');
        }
        closeGiveawayBanner.addEventListener('click', () => {
            giveawayBanner.classList.add('hidden');
            sessionStorage.setItem('giveawayBannerClosed', 'true');
        });
    }
    
    // Initialisierungsfunktionen
    incrementVisitCounter();
    Promise.all([loadTagsFromAPI(), loadGenresFromAPI()]).then(() => {
        console.log("Alle Tags und Genres erfolgreich geladen.");
    });
    displayFeaturedGame();
    handleNavigation();
    window.addEventListener('hashchange', handleNavigation);
});
function generateReferralCode() {
    const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789'; // Ohne I, O, 0, 1
    let result = '';
    for (let i = 0; i < 6; i++) {
        result += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return result;
}
// ======================================================================
// ANIMATION F√úR DIE STATISTIK-Z√ÑHLER
// ======================================================================
function animateValue(obj, start, end, duration, decimals = 0) {
    let startTimestamp = null;
    const step = (timestamp) => {
        if (!startTimestamp) startTimestamp = timestamp;
        const progress = Math.min((timestamp - startTimestamp) / duration, 1);
        const value = progress * (end - start) + start;
        obj.innerHTML = value.toFixed(decimals).replace('.', ','); // Komma f√ºr deutsche Darstellung
        if (progress < 1) {
            window.requestAnimationFrame(step);
        }
    };
    window.requestAnimationFrame(step);
}

const statsSection = document.getElementById('stats-section');
// Pr√ºfen, ob das Element existiert, bevor wir den Observer starten
if (statsSection) {
    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            // Animation starten, wenn die Sektion zu 50% sichtbar ist
            if (entry.isIntersecting) {
                animateValue(document.getElementById('stat-recommendations'), 0, 1026, 2000);
                animateValue(document.getElementById('stat-members'), 0, 25, 2000);
                animateValue(document.getElementById('stat-rating'), 0, 4.7, 2000, 1); // 1 Dezimalstelle
                
                // Observer stoppen, damit die Animation nur einmal l√§uft
                observer.unobserve(statsSection);
            }
        });
    }, { threshold: 0.5 });

    observer.observe(statsSection);
}
async function displayGamingNews() {
    const container = document.getElementById('profile-content-news');
    if (!container) return;
    container.innerHTML = `<p class="text-gray-400 text-center">${i18next.t('news_loading')}</p>`;

    try {
        // ======================================================================
        // NEUE, ROBUSTE QUERY: Holt die 5 neuesten, hoch bewerteten Spiele
        // ======================================================================
        const threeMonthsAgo = Math.floor(Date.now() / 1000) - (90 * 24 * 60 * 60);
        const query = `
            fields name, cover.url, first_release_date;
            where first_release_date > ${threeMonthsAgo} & total_rating_count > 25 & category = 0;
            sort first_release_date desc;
            limit 5;
        `;

        // Wir nutzen den stabilen '/games' Endpunkt
        const response = await fetch('/.netlify/functions/call-igdb', {
            method: 'POST',
            body: JSON.stringify({ endpoint: 'games', query: query })
        });

        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`Fehler beim Abrufen der neuen Spiele: ${errorText}`);
        }
        const newGames = await response.json();

        if (newGames.length === 0) {
            container.innerHTML = `<p class="text-gray-500 text-center">${i18next.t('news_no_posts')}</p>`;
            return;
        }

        let newsHtml = newGames.map(game => {
            const releaseDate = new Date(game.first_release_date * 1000).toLocaleDateString('de-DE', { year: 'numeric', month: 'long' });
            return `
                <div class="bg-gray-900 p-3 rounded-lg flex items-center gap-4">
                    <img src="${game.cover.url.replace('t_thumb', 't_cover_big')}" class="w-16 h-20 object-cover rounded">
                    <div>
                        <h4 class="font-bold text-white">${sanitizeHTML(game.name)}</h4>
                        <p class="text-sm text-gray-400">Ver√∂ffentlicht: ${releaseDate}</p>
                    </div>
                </div>
            `;
        }).join('');

        container.innerHTML = `<h3 class="text-xl font-bold text-white mb-4">Neueste Top-Spiele</h3>` + newsHtml;
    } catch(e) {
        console.error("Fehler beim Laden der neuen Spiele:", e);
        container.innerHTML = `<p class="text-red-400 text-center">${i18next.t('news_error')}</p>`;
    }
}
async function displayFeaturedGame() {
    const container = document.getElementById('featured-game-card');
    if (!container) return;
    container.innerHTML = `<p class="text-gray-400">${i18next.t('profile_loading')}</p>`;

    try {
        // Holt ein zuf√§lliges, hoch bewertetes Spiel
        const randomOffset = Math.floor(Math.random() * 200);
        const query = `
            fields name, cover.url, summary;
            where total_rating_count > 500 & category = 0 & version_parent = null;
            sort total_rating_count desc;
            limit 1;
            offset ${randomOffset};
        `;

        const response = await fetch('/.netlify/functions/call-igdb', {
            method: 'POST',
            body: JSON.stringify({ query: query })
        });
        const games = await response.json();
        if (!games || games.length === 0) throw new Error("Kein Spiel gefunden.");

        const game = games[0];
        const imageUrl = game.cover ? game.cover.url.replace('t_thumb', 't_cover_big') : '';
        
        container.innerHTML = `
            <div class="max-w-md mx-auto bg-gray-800 rounded-xl shadow-lg overflow-hidden md:max-w-2xl border border-gray-700">
              <div class="md:flex">
                <div class="md:flex-shrink-0">
                  <img class="h-48 w-full object-cover md:h-full md:w-48" src="${imageUrl}" alt="Cover von ${game.name}">
                </div>
                <div class="p-8 text-left">
                  <h3 class="text-2xl font-bold text-white">${sanitizeHTML(game.name)}</h3>
                  <p class="mt-2 text-gray-400 line-clamp-4">${sanitizeHTML(game.summary)}</p>
                </div>
              </div>
            </div>
        `;
    } catch (e) {
        console.error("Fehler beim Laden des Spiel des Tages:", e);
        container.innerHTML = ''; // Bei Fehler einfach ausblenden
    }
}
</script>

</body>
</html>